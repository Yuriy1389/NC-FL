<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ФАРМСТИЛ - Система управления несоответствиями</title>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; border-radius: 10px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { color: #1a73e8; margin-bottom: 20px; text-align: center; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; }
        textarea { min-height: 100px; }
        .btn { padding: 10px 20px; background: #1a73e8; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; }
        .btn:hover { background: #0d62d9; }
        .btn-success { background: #28a745; }
        .btn-success:hover { background: #218838; }
        .notification { padding: 10px; margin: 10px 0; border-radius: 5px; display: none; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; display: block; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; display: block; }
        .qr-preview { text-align: center; margin: 20px 0; padding: 20px; border: 2px dashed #1a73e8; border-radius: 10px; }
        .menu { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .menu button { flex: 1; min-width: 150px; }
        .page { display: none; }
        .active { display: block; }
        .ns-card { background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 5px; padding: 15px; margin-bottom: 10px; }
        .ns-card h3 { color: #1a73e8; margin-bottom: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ФАРМСТИЛ - Управление несоответствиями</h1>
        
        <div class="menu">
            <button class="btn" onclick="showPage('admin')">Админ</button>
            <button class="btn" onclick="showPage('qr')">QR-коды</button>
            <button class="btn" onclick="showPage('list')">Список НС</button>
        </div>
        
        <div id="notification"></div>
        
        <!-- Админ панель -->
        <div id="adminPage" class="page active">
            <h2>Настройки системы</h2>
            <div class="form-group">
                <label>ID Google таблицы:</label>
                <input type="text" id="sheetId" placeholder="1abc123def456...">
                <small>ID из URL таблицы: docs.google.com/spreadsheets/d/<strong>ID_ТАБЛИЦЫ</strong>/edit</small>
            </div>
            <div class="form-group">
                <label>URL веб-приложения:</label>
                <input type="text" id="webAppUrl" placeholder="https://script.google.com/macros/s/...">
                <small>Скопируйте из "Развернуть" → "Веб-приложение"</small>
            </div>
            <button class="btn" onclick="saveSettings()">Сохранить настройки</button>
            <button class="btn btn-success" onclick="testConnection()" style="margin-left: 10px;">Проверить связь</button>
            
            <div style="margin-top: 30px;">
                <h3>Статистика</h3>
                <p>Всего записей: <span id="totalCount">0</span></p>
                <button class="btn" onclick="loadData()">Обновить данные</button>
            </div>
        </div>
        
        <!-- Генерация QR -->
        <div id="qrPage" class="page">
            <h2>Генерация QR-кода</h2>
            <div class="form-group">
                <label>Подразделение:</label>
                <select id="qrDepartment">
                    <option value="">Выберите</option>
                    <option value="ЦМО">ЦМО</option>
                    <option value="ОТК">ОТК</option>
                    <option value="Цех сборки">Цех сборки</option>
                </select>
            </div>
            <div class="form-group">
                <label>Место:</label>
                <input type="text" id="qrLocation" placeholder="Участок №1, Станок №5">
            </div>
            <button class="btn" onclick="generateQR()">Создать QR</button>
            
            <div id="qrResult" class="qr-preview" style="display: none;">
                <h3>QR-код создан</h3>
                <div id="qrcode"></div>
                <p>Подразделение: <strong id="qrDeptText"></strong></p>
                <p>Место: <strong id="qrLocText"></strong></p>
                <button class="btn" onclick="testQR()">Протестировать</button>
            </div>
        </div>
        
        <!-- Список несоответствий -->
        <div id="listPage" class="page">
            <h2>Список несоответствий</h2>
            <div id="nsList"></div>
        </div>
        
        <!-- Форма рабочего (отображается только при наличии QR в URL) -->
        <div id="workerPage" style="display: none;">
            <h2>Регистрация несоответствия</h2>
            <div class="form-group">
                <label>Дата обнаружения:</label>
                <input type="date" id="detectionDate" required>
            </div>
            <div class="form-group">
                <label>Ваше ФИО:</label>
                <input type="text" id="applicant" placeholder="Иванов И.И." required>
            </div>
            <div class="form-group">
                <label>Описание проблемы:</label>
                <textarea id="description" placeholder="Подробно опишите проблему..." required></textarea>
            </div>
            <button class="btn btn-success" onclick="saveNS()">Отправить</button>
        </div>
    </div>

    <script>
        // Конфигурация
        const CONFIG = {
            DEFAULT_SHEET_ID: '',
            DEFAULT_WEB_APP_URL: ''
        };
        
        // Проверка режима
        const urlParams = new URLSearchParams(window.location.search);
        const qrCode = urlParams.get('qrcode');
        
        if (qrCode) {
            document.getElementById('workerPage').style.display = 'block';
            document.querySelector('.container').style.display = 'none';
            processQR(qrCode);
        } else {
            initAdmin();
        }
        
        function initAdmin() {
            loadSettings();
            loadData();
        }
        
        function showPage(page) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(page + 'Page').classList.add('active');
        }
        
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            
            if (type === 'success') {
                setTimeout(() => {
                    notification.style.display = 'none';
                }, 3000);
            }
        }
        
        // Настройки
        function loadSettings() {
            const sheetId = localStorage.getItem('farmstil_sheet_id') || CONFIG.DEFAULT_SHEET_ID;
            const webAppUrl = localStorage.getItem('farmstil_web_app_url') || CONFIG.DEFAULT_WEB_APP_URL;
            
            document.getElementById('sheetId').value = sheetId;
            document.getElementById('webAppUrl').value = webAppUrl;
        }
        
        function saveSettings() {
            const sheetId = document.getElementById('sheetId').value.trim();
            const webAppUrl = document.getElementById('webAppUrl').value.trim();
            
            if (!sheetId || !webAppUrl) {
                showNotification('Заполните все поля', 'error');
                return;
            }
            
            localStorage.setItem('farmstil_sheet_id', sheetId);
            localStorage.setItem('farmstil_web_app_url', webAppUrl);
            
            showNotification('Настройки сохранены');
        }
        
        async function testConnection() {
            const webAppUrl = localStorage.getItem('farmstil_web_app_url');
            
            if (!webAppUrl) {
                showNotification('Сначала сохраните настройки', 'error');
                return;
            }
            
            try {
                showNotification('Проверяем связь...', 'success');
                
                const response = await fetch(webAppUrl + '?test=true');
                const data = await response.json();
                
                if (data.success) {
                    showNotification('✅ Связь установлена!');
                } else {
                    showNotification('❌ Ошибка: ' + (data.error || 'Неизвестная ошибка'), 'error');
                }
            } catch (error) {
                showNotification('❌ Ошибка подключения: ' + error.message, 'error');
            }
        }
        
        // Работа с данными
        async function loadData() {
            const webAppUrl = localStorage.getItem('farmstil_web_app_url');
            
            if (!webAppUrl) {
                showNotification('Сначала настройте URL веб-приложения', 'error');
                return;
            }
            
            try {
                const response = await fetch(webAppUrl);
                const data = await response.json();
                
                if (data.success) {
                    displayData(data.data);
                    showNotification(`Загружено ${data.data.length} записей`);
                } else {
                    showNotification('Ошибка загрузки: ' + (data.error || 'Неизвестная ошибка'), 'error');
                }
            } catch (error) {
                showNotification('Ошибка загрузки: ' + error.message, 'error');
            }
        }
        
        function displayData(data) {
            const container = document.getElementById('nsList');
            const countElement = document.getElementById('totalCount');
            
            countElement.textContent = data.length;
            
            if (data.length === 0) {
                container.innerHTML = '<p>Нет данных</p>';
                return;
            }
            
            let html = '';
            data.forEach(item => {
                html += `
                    <div class="ns-card">
                        <h3>${item['Номер НС'] || 'Без номера'}</h3>
                        <p><strong>Дата:</strong> ${item['Дата обнаружения'] || ''}</p>
                        <p><strong>Подразделение:</strong> ${item['Подразделение'] || ''}</p>
                        <p><strong>Заявитель:</strong> ${item['Заявитель'] || ''}</p>
                        <p><strong>Описание:</strong> ${item['Описание'] || ''}</p>
                        <p><strong>Статус:</strong> ${item['Статус'] || ''}</p>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // QR коды
        function generateQR() {
            const department = document.getElementById('qrDepartment').value;
            const location = document.getElementById('qrLocation').value;
            
            if (!department || !location) {
                showNotification('Заполните все поля', 'error');
                return;
            }
            
            const code = `FS-${Date.now().toString(36)}-${Math.random().toString(36).substr(2, 4)}`;
            const url = `${window.location.origin}${window.location.pathname}?qrcode=${encodeURIComponent(code)}`;
            
            // Сохраняем QR в localStorage
            const qrData = {
                code: code,
                department: department,
                location: location,
                url: url,
                created: new Date().toISOString()
            };
            
            const qrCodes = JSON.parse(localStorage.getItem('farmstil_qrcodes') || '[]');
            qrCodes.push(qrData);
            localStorage.setItem('farmstil_qrcodes', JSON.stringify(qrCodes));
            
            // Генерируем QR код
            const qrcodeDiv = document.getElementById('qrcode');
            qrcodeDiv.innerHTML = '';
            
            new QRCode(qrcodeDiv, {
                text: url,
                width: 200,
                height: 200
            });
            
            document.getElementById('qrDeptText').textContent = department;
            document.getElementById('qrLocText').textContent = location;
            document.getElementById('qrResult').style.display = 'block';
            
            showNotification('QR-код создан!');
        }
        
        function testQR() {
            const qrData = JSON.parse(localStorage.getItem('farmstil_qrcodes') || '[]');
            if (qrData.length > 0) {
                const lastQR = qrData[qrData.length - 1];
                window.open(lastQR.url, '_blank');
            }
        }
        
        // Обработка QR кода рабочим
        function processQR(code) {
            const qrData = JSON.parse(localStorage.getItem('farmstil_qrcodes') || '[]');
            const qrInfo = qrData.find(q => q.code === code);
            
            if (qrInfo) {
                document.getElementById('workerPage').innerHTML = `
                    <h2>Регистрация несоответствия</h2>
                    <div style="background: #e3f2fd; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
                        <p><strong>Подразделение:</strong> ${qrInfo.department}</p>
                        <p><strong>Место:</strong> ${qrInfo.location}</p>
                    </div>
                    <div class="form-group">
                        <label>Дата обнаружения:</label>
                        <input type="date" id="detectionDate" value="${new Date().toISOString().split('T')[0]}" required>
                    </div>
                    <div class="form-group">
                        <label>Ваше ФИО:</label>
                        <input type="text" id="applicant" placeholder="Иванов И.И." required>
                    </div>
                    <div class="form-group">
                        <label>Описание проблемы:</label>
                        <textarea id="description" placeholder="Подробно опишите проблему..." required></textarea>
                    </div>
                    <button class="btn btn-success" onclick="saveNS('${code}', '${qrInfo.department}', '${qrInfo.location}')">Отправить</button>
                    <button class="btn" onclick="window.location.href='${window.location.pathname}'" style="margin-left: 10px;">Отмена</button>
                `;
            } else {
                document.getElementById('workerPage').innerHTML = `
                    <h2>QR-код не распознан</h2>
                    <p>Код: ${code}</p>
                    <p>Заполните данные вручную:</p>
                    <div class="form-group">
                        <label>Подразделение:</label>
                        <select id="manualDepartment">
                            <option value="ЦМО">ЦМО</option>
                            <option value="ОТК">ОТК</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Место:</label>
                        <input type="text" id="manualLocation" placeholder="Участок">
                    </div>
                    <div class="form-group">
                        <label>Дата обнаружения:</label>
                        <input type="date" id="detectionDate" value="${new Date().toISOString().split('T')[0]}" required>
                    </div>
                    <div class="form-group">
                        <label>Ваше ФИО:</label>
                        <input type="text" id="applicant" placeholder="Иванов И.И." required>
                    </div>
                    <div class="form-group">
                        <label>Описание проблемы:</label>
                        <textarea id="description" placeholder="Подробно опишите проблему..." required></textarea>
                    </div>
                    <button class="btn btn-success" onclick="saveNS('${code}')">Отправить</button>
                `;
            }
        }
        
        async function saveNS(qrCode, department, location) {
            try {
                const detectionDate = document.getElementById('detectionDate').value;
                const applicant = document.getElementById('applicant').value;
                const description = document.getElementById('description').value;
                
                if (!department) {
                    department = document.getElementById('manualDepartment')?.value || '';
                }
                if (!location) {
                    location = document.getElementById('manualLocation')?.value || '';
                }
                
                if (!detectionDate || !applicant || !description || !department || !location) {
                    alert('Заполните все поля');
                    return;
                }
                
                // Генерируем номер НС
                const nsNumber = `NS-${new Date().getFullYear()}${(new Date().getMonth()+1).toString().padStart(2,'0')}-${Math.floor(Math.random()*1000).toString().padStart(3,'0')}`;
                
                const data = {
                    nsNumber: nsNumber,
                    detectionDate: detectionDate,
                    department: department,
                    location: location,
                    applicant: applicant,
                    description: description,
                    status: 'checking',
                    qrCode: qrCode
                };
                
                const webAppUrl = localStorage.getItem('farmstil_web_app_url');
                
                if (!webAppUrl) {
                    // Сохраняем локально если нет настроек
                    const localData = JSON.parse(localStorage.getItem('farmstil_ns_local') || '[]');
                    localData.push({
                        ...data,
                        localId: Date.now(),
                        created: new Date().toISOString()
                    });
                    localStorage.setItem('farmstil_ns_local', JSON.stringify(localData));
                    
                    showSuccess(nsNumber);
                    return;
                }
                
                // Отправляем на сервер
                const response = await fetch(webAppUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showSuccess(result.nsNumber || nsNumber);
                } else {
                    throw new Error(result.error || 'Ошибка сервера');
                }
                
            } catch (error) {
                console.error('Ошибка:', error);
                alert('Ошибка отправки: ' + error.message);
            }
        }
        
        function showSuccess(nsNumber) {
            document.getElementById('workerPage').innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <div style="font-size: 48px; color: #28a745; margin-bottom: 20px;">✅</div>
                    <h2>Несоответствие зарегистрировано!</h2>
                    <p style="font-size: 18px; margin: 20px 0;">Номер: <strong>${nsNumber}</strong></p>
                    <p>Данные успешно сохранены в систему.</p>
                    <button class="btn" onclick="window.location.href='${window.location.pathname}'" style="margin-top: 20px;">
                        Вернуться на главную
                    </button>
                </div>
            `;
        }
        
        // Экспорт функций
        window.showPage = showPage;
        window.saveSettings = saveSettings;
        window.testConnection = testConnection;
        window.loadData = loadData;
        window.generateQR = generateQR;
        window.testQR = testQR;
        window.saveNS = saveNS;
        
        // Устанавливаем сегодняшнюю дату по умолчанию
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date().toISOString().split('T')[0];
            const dateInput = document.getElementById('detectionDate');
            if (dateInput) {
                dateInput.value = today;
                dateInput.max = today;
            }
        });
    </script>
</body>
</html>

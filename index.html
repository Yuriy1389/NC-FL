<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–§–ê–†–ú–°–¢–ò–õ - –°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è–º–∏ ISO 13485</title>
    
    <!-- –ë–∏–±–ª–∏–æ—Ç–µ–∫–∏ -->
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/recordrtc@5.6.2/RecordRTC.min.js"></script>
    
    <style>
        /* –í—Å–µ —Å—Ç–∏–ª–∏ –æ—Å—Ç–∞—é—Ç—Å—è –∫–∞–∫ –±—ã–ª–∏, –¥–æ–±–∞–≤–∏–º —Ç–æ–ª—å–∫–æ –Ω–æ–≤—ã–µ */
        .audio-controls {
            display: flex;
            gap: 10px;
            margin: 10px 0;
            align-items: center;
        }
        
        .audio-visualizer {
            width: 100%;
            height: 50px;
            background: #f0f0f0;
            border-radius: 5px;
            margin: 10px 0;
            overflow: hidden;
        }
        
        .audio-wave {
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, #4CAF50 0%, #8BC34A 100%);
            transform: scaleX(0);
            transform-origin: left;
            transition: transform 0.1s;
        }
        
        .audio-preview {
            margin-top: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #ddd;
        }
        
        .stage-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            margin: 0 5px;
        }
        
        .stage-initiation { background: #ff9800; color: white; }
        .stage-analysis { background: #2196F3; color: white; }
        .stage-correction { background: #4CAF50; color: white; }
        .stage-verification { background: #9C27B0; color: white; }
        .stage-closed { background: #607D8B; color: white; }
        
        .workflow-step {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            position: relative;
        }
        
        .workflow-step.completed {
            border-color: #4CAF50;
            background: #f1f8e9;
        }
        
        .workflow-step.active {
            border-color: #2196F3;
            background: #e3f2fd;
        }
        
        .step-number {
            position: absolute;
            top: -12px;
            left: 20px;
            background: #1e3c72;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            text-align: center;
            line-height: 24px;
            font-weight: bold;
        }
        
        .attachment-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 10px 0;
        }
        
        .attachment-item {
            padding: 8px 12px;
            background: #e3f2fd;
            border-radius: 20px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .signature-block {
            background: #fff3cd;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            border-left: 5px solid #ffc107;
        }
        
        .signature-line {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            padding-bottom: 10px;
            border-bottom: 1px dashed #ddd;
        }
    </style>
</head>
<body>
    <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∏ –º–æ–¥–∞–ª–∫–∏ –æ—Å—Ç–∞—é—Ç—Å—è –∫–∞–∫ –±—ã–ª–∏ -->
    
    <!-- –î–æ–±–∞–≤–∏–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Å–∫—Ä–∏–ø—Ç -->
    <script>
        // ========== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ==========
        const CONFIG = {
            // Google Sheets API (–∑–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à URL)
            GOOGLE_SHEETS_API: 'https://docs.google.com/spreadsheets/d/1ePk6IYFO97saRgkETyWEyY6PisNy95OsVkCPK84LLeo/edit?gid=0#gid=0',
            
            // Email –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
            EMAIL_CONFIG: {
                managerEmail: 'finkart23@mail.ru',
                web3formsKey: '68e70096-0aed-4fd2-ba43-a9f06163e05b',
                web3formsUrl: 'https://api.web3forms.com/submit'
            },
            
            // –°—Ç–∞—Ç—É—Å—ã –ø–æ ISO 13485
            STATUSES: {
                'checking': { name: '–ù–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ –°–ú–ö', color: '#ffc107', stage: 'initiation' },
                'analysis': { name: '–ê–Ω–∞–ª–∏–∑ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–º', color: '#2196F3', stage: 'analysis' },
                'correction_plan': { name: '–ü–ª–∞–Ω –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É—é—â–∏—Ö –¥–µ–π—Å—Ç–≤–∏–π', color: '#9C27B0', stage: 'correction' },
                'execution': { name: '–ò—Å–ø–æ–ª–Ω–µ–Ω–∏–µ', color: '#FF5722', stage: 'correction' },
                'verification': { name: '–í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏', color: '#4CAF50', stage: 'verification' },
                'closed': { name: '–ó–∞–∫—Ä—ã—Ç–æ', color: '#607D8B', stage: 'closed' },
                'rework': { name: '–î–æ—Ä–∞–±–æ—Ç–∫–∞', color: '#dc3545', stage: 'rework' }
            },
            
            // –†–æ–ª–∏
            ROLES: {
                'worker': '–°–æ—Ç—Ä—É–¥–Ω–∏–∫',
                'responsible': '–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π –∑–∞ –∞–Ω–∞–ª–∏–∑',
                'executor': '–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å',
                'smk_manager': '–ú–µ–Ω–µ–¥–∂–µ—Ä –°–ú–ö',
                'production_director': '–î–∏—Ä–µ–∫—Ç–æ—Ä –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞',
                'department_head': '–ù–∞—á–∞–ª—å–Ω–∏–∫ —Ü–µ—Ö–∞'
            }
        };
        
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let currentUser = { role: 'smk_manager', name: '–ú–µ–Ω–µ–¥–∂–µ—Ä –°–ú–ö' }; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é
        let audioRecorder = null;
        let audioChunks = [];
        let isRecording = false;
        let visualizerInterval = null;
    </script>
    
    <script>
        // ========== –ê–£–î–ò–û–ó–ê–ü–ò–°–¨ –î–õ–Ø iOS ==========
        
        class AudioRecorderIOS {
            constructor() {
                this.mediaRecorder = null;
                this.stream = null;
                this.audioChunks = [];
                this.isRecording = false;
                this.audioBlob = null;
            }
            
            async startRecording() {
                try {
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É
                    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                        throw new Error('–ë—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∑–∞–ø–∏—Å—å –∞—É–¥–∏–æ');
                    }
                    
                    // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ iOS
                    this.stream = await navigator.mediaDevices.getUserMedia({ 
                        audio: {
                            echoCancellation: true,
                            noiseSuppression: true,
                            sampleRate: 44100
                        }
                    });
                    
                    // –î–ª—è iOS –∏—Å–ø–æ–ª—å–∑—É–µ–º MediaRecorder –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω
                    if (window.MediaRecorder) {
                        this.mediaRecorder = new MediaRecorder(this.stream);
                        this.audioChunks = [];
                        
                        this.mediaRecorder.ondataavailable = (event) => {
                            if (event.data.size > 0) {
                                this.audioChunks.push(event.data);
                            }
                        };
                        
                        this.mediaRecorder.onstop = () => {
                            this.audioBlob = new Blob(this.audioChunks, { type: 'audio/webm' });
                            this.stream.getTracks().forEach(track => track.stop());
                        };
                        
                        this.mediaRecorder.start(1000); // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É
                        this.isRecording = true;
                        
                        // –í–∏–∑—É–∞–ª–∏–∑–∞—Ç–æ—Ä
                        this.startVisualizer();
                        
                        return true;
                    } else {
                        // Fallback –¥–ª—è —Å—Ç–∞—Ä—ã—Ö iOS
                        throw new Error('MediaRecorder –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è');
                    }
                    
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏:', error);
                    
                    // –ü—Ä–æ–±—É–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –º–µ—Ç–æ–¥ –¥–ª—è iOS
                    if (error.name === 'NotAllowedError') {
                        alert('–†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö Safari:\n–ù–∞—Å—Ç—Ä–æ–π–∫–∏ ‚Üí Safari ‚Üí –ú–∏–∫—Ä–æ—Ñ–æ–Ω ‚Üí –†–∞–∑—Ä–µ—à–∏—Ç—å');
                    }
                    
                    return false;
                }
            }
            
            stopRecording() {
                if (this.mediaRecorder && this.isRecording) {
                    this.mediaRecorder.stop();
                    this.isRecording = false;
                    this.stopVisualizer();
                    
                    // –°–æ–∑–¥–∞–µ–º –∞—É–¥–∏–æ URL –¥–ª—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
                    if (this.audioBlob) {
                        const audioUrl = URL.createObjectURL(this.audioBlob);
                        return {
                            blob: this.audioBlob,
                            url: audioUrl,
                            duration: this.audioChunks.length // –ø—Ä–∏–º–µ—Ä–Ω–∞—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
                        };
                    }
                }
                return null;
            }
            
            startVisualizer() {
                const visualizer = document.getElementById('audioWave');
                if (!visualizer) return;
                
                let scale = 0;
                visualizerInterval = setInterval(() => {
                    scale = 0.3 + Math.random() * 0.7;
                    visualizer.style.transform = `scaleX(${scale})`;
                }, 100);
            }
            
            stopVisualizer() {
                if (visualizerInterval) {
                    clearInterval(visualizerInterval);
                    const visualizer = document.getElementById('audioWave');
                    if (visualizer) {
                        visualizer.style.transform = 'scaleX(0)';
                    }
                }
            }
            
            async uploadAudio(audioData, fileName = 'audio_note.webm') {
                try {
                    // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ base64 –¥–ª—è Google Sheets
                    const reader = new FileReader();
                    
                    return new Promise((resolve, reject) => {
                        reader.onloadend = () => {
                            const base64Audio = reader.result.split(',')[1];
                            resolve({
                                name: fileName,
                                type: 'audio/webm',
                                data: base64Audio,
                                size: audioData.blob.size,
                                duration: audioData.duration || 0
                            });
                        };
                        
                        reader.onerror = reject;
                        reader.readAsDataURL(audioData.blob);
                    });
                    
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞—É–¥–∏–æ:', error);
                    return null;
                }
            }
        }
        
        // ========== GOOGLE SHEETS API ==========
        
        class GoogleSheetsAPI {
            constructor(apiUrl) {
                this.apiUrl = apiUrl;
            }
            
            async saveNS(data) {
                try {
                    const response = await fetch(this.apiUrl, {
                        method: 'POST',
                        mode: 'no-cors', // –î–ª—è Google Apps Script
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(data)
                    });
                    
                    // –ü–æ—Å–∫–æ–ª—å–∫—É no-cors, response –±—É–¥–µ—Ç opaque
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–∞–∫–∂–µ –ª–æ–∫–∞–ª—å–Ω–æ –∫–∞–∫ fallback
                    this.saveToLocalStorage(data);
                    
                    return { success: true, message: '–î–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã' };
                    
                } catch (error) {
                    console.warn('Google Sheets –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ:', error);
                    this.saveToLocalStorage(data);
                    return { success: false, error: error.message, savedLocally: true };
                }
            }
            
            async loadAllNS() {
                try {
                    const response = await fetch(`${this.apiUrl}?action=get`);
                    const data = await response.json();
                    
                    if (data.success) {
                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage –¥–ª—è –æ—Ñ—Ñ–ª–∞–π–Ω —Ä–∞–±–æ—Ç—ã
                        localStorage.setItem('farmstil_ns_cloud', JSON.stringify(data.data));
                        return data.data;
                    }
                    
                    // Fallback –Ω–∞ –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                    return this.loadFromLocalStorage();
                    
                } catch (error) {
                    console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ –æ–±–ª–∞–∫–∞:', error);
                    return this.loadFromLocalStorage();
                }
            }
            
            saveToLocalStorage(data) {
                const localData = JSON.parse(localStorage.getItem('farmstil_ns_local') || '[]');
                localData.push({
                    ...data,
                    localId: `local_${Date.now()}`,
                    synced: false
                });
                localStorage.setItem('farmstil_ns_local', JSON.stringify(localData));
            }
            
            loadFromLocalStorage() {
                const localData = JSON.parse(localStorage.getItem('farmstil_ns_local') || '[]');
                const cloudData = JSON.parse(localStorage.getItem('farmstil_ns_cloud') || '[]');
                
                // –û–±—ä–µ–¥–∏–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ, —É–±–∏—Ä–∞—è –¥—É–±–ª–∏–∫–∞—Ç—ã
                const allData = [...cloudData];
                const localIds = new Set(cloudData.map(d => d.nsNumber));
                
                localData.forEach(item => {
                    if (!localIds.has(item.nsNumber)) {
                        allData.push(item);
                    }
                });
                
                return allData;
            }
        }
        
        // ========== EMAIL SERVICE ==========
        
        class EmailService {
            constructor(config) {
                this.config = config;
            }
            
            async sendNotification(type, nsData, recipientEmail = null) {
                const emailConfigs = {
                    'new_ns': {
                        subject: `–§–ê–†–ú–°–¢–ò–õ: –ù–æ–≤–æ–µ –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ ${nsData.nsNumber}`,
                        template: this.getNewNSTemplate(nsData)
                    },
                    'assigned': {
                        subject: `–§–ê–†–ú–°–¢–ò–õ: –í–∞–º –Ω–∞–∑–Ω–∞—á–µ–Ω–æ –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ ${nsData.nsNumber}`,
                        template: this.getAssignedTemplate(nsData)
                    },
                    'correction_ready': {
                        subject: `–§–ê–†–ú–°–¢–ò–õ: –ü–ª–∞–Ω –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É—é—â–∏—Ö –¥–µ–π—Å—Ç–≤–∏–π –¥–ª—è ${nsData.nsNumber}`,
                        template: this.getCorrectionTemplate(nsData)
                    },
                    'execution_required': {
                        subject: `–§–ê–†–ú–°–¢–ò–õ: –¢—Ä–µ–±—É–µ—Ç—Å—è –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–æ –ù–° ${nsData.nsNumber}`,
                        template: this.getExecutionTemplate(nsData)
                    },
                    'verification_required': {
                        subject: `–§–ê–†–ú–°–¢–ò–õ: –¢—Ä–µ–±—É–µ—Ç—Å—è –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ –ù–° ${nsData.nsNumber}`,
                        template: this.getVerificationTemplate(nsData)
                    },
                    'closed': {
                        subject: `–§–ê–†–ú–°–¢–ò–õ: –ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ ${nsData.nsNumber} –∑–∞–∫—Ä—ã—Ç–æ`,
                        template: this.getClosedTemplate(nsData)
                    }
                };
                
                const config = emailConfigs[type];
                if (!config) return false;
                
                const recipient = recipientEmail || this.config.managerEmail;
                
                try {
                    const response = await fetch(this.config.web3formsUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify({
                            access_key: this.config.web3formsKey,
                            subject: config.subject,
                            from_name: '–°–∏—Å—Ç–µ–º–∞ –§–ê–†–ú–°–¢–ò–õ',
                            to: recipient,
                            html: config.template,
                            reply_to: recipient
                        })
                    });
                    
                    const result = await response.json();
                    return result.success;
                    
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ email:', error);
                    return false;
                }
            }
            
            getNewNSTemplate(nsData) {
                return `
                    <h2>üìã –ù–æ–≤–æ–µ –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–æ</h2>
                    <h3>${nsData.nsNumber}</h3>
                    
                    <table style="width: 100%; border-collapse: collapse; margin: 20px 0; border: 1px solid #ddd;">
                        <tr><td style="padding: 10px; background: #f9f9f9;"><strong>–ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ:</strong></td><td style="padding: 10px;">${nsData.department}</td></tr>
                        <tr><td style="padding: 10px; background: #f9f9f9;"><strong>–ú–µ—Å—Ç–æ:</strong></td><td style="padding: 10px;">${nsData.location}</td></tr>
                        <tr><td style="padding: 10px; background: #f9f9f9;"><strong>–ó–∞—è–≤–∏—Ç–µ–ª—å:</strong></td><td style="padding: 10px;">${nsData.applicant}</td></tr>
                        <tr><td style="padding: 10px; background: #f9f9f9;"><strong>–î–∞—Ç–∞:</strong></td><td style="padding: 10px;">${nsData.detectionDate}</td></tr>
                    </table>
                    
                    <h4>–û–ø–∏—Å–∞–Ω–∏–µ:</h4>
                    <div style="background: #f5f5f5; padding: 15px; border-radius: 5px; margin: 10px 0;">
                        ${nsData.description.replace(/\n/g, '<br>')}
                    </div>
                    
                    <div style="margin: 20px 0; padding: 15px; background: #e3f2fd; border-radius: 8px;">
                        <strong>–î–µ–π—Å—Ç–≤–∏—è:</strong>
                        <ol>
                            <li>–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–ª–Ω–æ—Ç—É –¥–∞–Ω–Ω—ã—Ö</li>
                            <li>–ù–∞–∑–Ω–∞—á—å—Ç–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∑–∞ –∞–Ω–∞–ª–∏–∑</li>
                            <li>–ò–∑–º–µ–Ω–∏—Ç–µ —Å—Ç–∞—Ç—É—Å –≤ —Å–∏—Å—Ç–µ–º–µ</li>
                        </ol>
                    </div>
                    
                    <p><a href="${window.location.origin}?ns=${nsData.nsNumber}" style="
                        display: inline-block; padding: 12px 24px; background: #1e3c72; 
                        color: white; text-decoration: none; border-radius: 5px; font-weight: bold;
                    ">–ü–µ—Ä–µ–π—Ç–∏ –∫ –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—é</a></p>
                `;
            }
            
            getAssignedTemplate(nsData) {
                return `
                    <h2>üéØ –í–∞–º –Ω–∞–∑–Ω–∞—á–µ–Ω–æ –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ</h2>
                    <h3>${nsData.nsNumber}</h3>
                    
                    <p><strong>–ó–∞–¥–∞—á–∞:</strong> –ü—Ä–æ–≤–µ–¥–∏—Ç–µ –∞–Ω–∞–ª–∏–∑ –∫–æ—Ä–µ–Ω–Ω—ã—Ö –ø—Ä–∏—á–∏–Ω –∏ —Ä–∞–∑—Ä–∞–±–æ—Ç–∞–π—Ç–µ –ø–ª–∞–Ω –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É—é—â–∏—Ö –¥–µ–π—Å—Ç–≤–∏–π</p>
                    
                    <div style="margin: 20px 0; padding: 15px; background: #fff3cd; border-radius: 8px;">
                        <strong>–°—Å—ã–ª–∫–∞ –¥–ª—è —Ä–∞–±–æ—Ç—ã:</strong><br>
                        <a href="${window.location.origin}?ns=${nsData.nsNumber}&role=responsible">${window.location.origin}?ns=${nsData.nsNumber}&role=responsible</a>
                    </div>
                `;
            }
            
            // –û—Å—Ç–∞–ª—å–Ω—ã–µ —à–∞–±–ª–æ–Ω—ã –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ...
        }
        
        // ========== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ==========
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ –°–∏—Å—Ç–µ–º–∞ –§–ê–†–ú–°–¢–ò–õ ISO 13485 –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è...');
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–µ—Ä–≤–∏—Å—ã
            window.gsheets = new GoogleSheetsAPI(CONFIG.GOOGLE_SHEETS_API);
            window.emailService = new EmailService(CONFIG.EMAIL_CONFIG);
            window.audioRecorder = new AudioRecorderIOS();
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ URL
            const urlParams = new URLSearchParams(window.location.search);
            const role = urlParams.get('role') || 'smk_manager';
            const nsId = urlParams.get('ns');
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–æ–ª—å
            setUserRole(role);
            
            // –ï—Å–ª–∏ –µ—Å—Ç—å ID –ù–°, –∑–∞–≥—Ä—É–∂–∞–µ–º –µ–≥–æ
            if (nsId) {
                loadNSDetails(nsId);
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∂–∏–º (—Ä–∞–±–æ—á–∏–π –∏–ª–∏ –∞–¥–º–∏–Ω)
            checkMode();
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
            loadAllData();
            
            console.log('‚úÖ –°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞. –†–æ–ª—å:', currentUser.role);
        });
        
        function setUserRole(role) {
            currentUser.role = role;
            currentUser.name = CONFIG.ROLES[role] || role;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–æ–ª–∏
            updateUIForRole();
        }
        
        function updateUIForRole() {
            // –°–∫—Ä—ã–≤–∞–µ–º/–ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ –∏ —Ä–∞–∑–¥–µ–ª—ã
            const adminOnly = document.querySelectorAll('.admin-only');
            const workerOnly = document.querySelectorAll('.worker-only');
            const smkOnly = document.querySelectorAll('.smk-only');
            const responsibleOnly = document.querySelectorAll('.responsible-only');
            
            // –õ–æ–≥–∏–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–æ —Ä–æ–ª—è–º...
        }
        
        // ========== –û–°–ù–û–í–ù–ê–Ø –õ–û–ì–ò–ö–ê WORKFLOW ==========
        
        async function submitWorkerForm() {
            try {
                console.log('üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º—ã –æ—Ç —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞...');
                
                // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ
                const nsData = {
                    nsNumber: generateNSNumber(),
                    detectionDate: document.getElementById('detectionDate').value,
                    department: document.getElementById('hiddenDepartment').value || 
                                document.getElementById('manualDepartment').value,
                    location: document.getElementById('hiddenLocation').value || 
                             document.getElementById('manualLocation').value,
                    applicant: document.getElementById('applicant').value,
                    productName: document.getElementById('productName').value,
                    productCode: document.getElementById('productCode').value,
                    description: document.getElementById('description').value,
                    status: 'checking',
                    created: new Date().toISOString(),
                    createdBy: currentUser.name,
                    stage: 'initiation',
                    
                    // –ê—É–¥–∏–æ–∑–∞–º–µ—Ç–∫–∏ –µ—Å–ª–∏ –µ—Å—Ç—å
                    audioNotes: window.audioNotes || [],
                    
                    // –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏
                    photos: window.photos || [],
                    
                    // –°–∫—Ä—ã—Ç—ã–µ –ø–æ–ª—è –∏–∑ QR
                    qrCode: document.getElementById('hiddenQRCode')?.value,
                    qrResponsible: document.getElementById('hiddenResponsible')?.value
                };
                
                // –í–∞–ª–∏–¥–∞—Ü–∏—è
                if (!validateNSData(nsData)) return;
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
                showNotification('–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö...', 'info');
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ Google Sheets
                const saveResult = await window.gsheets.saveNS(nsData);
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º email –º–µ–Ω–µ–¥–∂–µ—Ä—É –°–ú–ö
                await window.emailService.sendNotification('new_ns', nsData);
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É—Å–ø–µ—Ö
                showSuccessScreen(nsData);
                
                // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
                resetWorkerForm();
                
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏:', error);
                showNotification('–û—à–∏–±–∫–∞: ' + error.message, 'error');
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ (–≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º –°–ú–ö)
        async function assignResponsible(nsId, responsiblePerson, responsibleEmail) {
            try {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –ù–°
                const nsData = await getNSById(nsId);
                if (!nsData) throw new Error('–ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ');
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ
                nsData.responsible = responsiblePerson;
                nsData.responsibleEmail = responsibleEmail;
                nsData.status = 'analysis';
                nsData.stage = 'analysis';
                nsData.assignedDate = new Date().toISOString();
                nsData.assignedBy = currentUser.name;
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º
                await window.gsheets.saveNS(nsData);
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º email –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–º—É
                await window.emailService.sendNotification('assigned', nsData, responsibleEmail);
                
                showNotification('–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π –Ω–∞–∑–Ω–∞—á–µ–Ω, –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ', 'success');
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è:', error);
                showNotification('–û—à–∏–±–∫–∞: ' + error.message, 'error');
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É—é—â–∏—Ö –¥–µ–π—Å—Ç–≤–∏–π (–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π)
        async function submitCorrectionPlan(nsId, correctionData) {
            try {
                const nsData = await getNSById(nsId);
                
                // –î–æ–±–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –∞–Ω–∞–ª–∏–∑–∞
                nsData.rootCauseAnalysis = correctionData.rootCauseAnalysis;
                nsData.immediateCorrection = correctionData.immediateCorrection;
                nsData.correctiveActions = correctionData.correctiveActions;
                nsData.correctionDeadline = correctionData.deadline;
                nsData.executors = correctionData.executors;
                nsData.status = 'correction_plan';
                nsData.stage = 'correction';
                nsData.correctionSubmitted = new Date().toISOString();
                nsData.correctionSubmittedBy = currentUser.name;
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º
                await window.gsheets.saveNS(nsData);
                
                // –£–≤–µ–¥–æ–º–ª—è–µ–º –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –°–ú–ö
                await window.emailService.sendNotification('correction_ready', nsData);
                
                showNotification('–ü–ª–∞–Ω –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É—é—â–∏—Ö –¥–µ–π—Å—Ç–≤–∏–π –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É', 'success');
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–ª–∞–Ω–∞:', error);
                showNotification('–û—à–∏–±–∫–∞: ' + error.message, 'error');
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø–ª–∞–Ω–∞ (–º–µ–Ω–µ–¥–∂–µ—Ä –°–ú–ö)
        async function approveCorrectionPlan(nsId, approvalData) {
            try {
                const nsData = await getNSById(nsId);
                
                nsData.correctionApproved = true;
                nsData.correctionApprovalDate = new Date().toISOString();
                nsData.correctionApprovedBy = currentUser.name;
                nsData.approvalNotes = approvalData.notes;
                nsData.status = 'execution';
                
                // –ù–∞–∑–Ω–∞—á–∞–µ–º –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–π
                if (nsData.executors && nsData.executors.length > 0) {
                    nsData.executors.forEach(executor => {
                        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è–º
                        window.emailService.sendNotification('execution_required', nsData, executor.email);
                    });
                }
                
                await window.gsheets.saveNS(nsData);
                showNotification('–ü–ª–∞–Ω —É—Ç–≤–µ—Ä–∂–¥–µ–Ω, —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è–º', 'success');
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è:', error);
                showNotification('–û—à–∏–±–∫–∞: ' + error.message, 'error');
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –æ—Ç—á–µ—Ç–Ω–æ—Å—Ç–∏ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è
        async function submitExecutionReport(nsId, reportData) {
            try {
                const nsData = await getNSById(nsId);
                
                // –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç—á–µ—Ç –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è
                if (!nsData.executionReports) nsData.executionReports = [];
                nsData.executionReports.push({
                    executor: currentUser.name,
                    date: new Date().toISOString(),
                    actionsTaken: reportData.actionsTaken,
                    evidence: reportData.evidence, // —Ñ–æ—Ç–æ, –¥–æ–∫—É–º–µ–Ω—Ç—ã
                    isCompleted: reportData.isCompleted
                });
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Å–µ –ª–∏ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–∏ –æ—Ç—á–∏—Ç–∞–ª–∏—Å—å
                const allExecuted = nsData.executors.every(executor => 
                    nsData.executionReports.some(report => report.executor === executor.name)
                );
                
                if (allExecuted) {
                    nsData.status = 'verification';
                    nsData.stage = 'verification';
                    nsData.allExecutedDate = new Date().toISOString();
                    
                    // –£–≤–µ–¥–æ–º–ª—è–µ–º –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –°–ú–ö –æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏
                    await window.emailService.sendNotification('verification_required', nsData);
                }
                
                await window.gsheets.saveNS(nsData);
                showNotification('–û—Ç—á–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω', 'success');
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ—Ç—á–µ—Ç–∞:', error);
                showNotification('–û—à–∏–±–∫–∞: ' + error.message, 'error');
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ (–º–µ–Ω–µ–¥–∂–µ—Ä –°–ú–ö)
        async function submitVerification(nsId, verificationData) {
            try {
                const nsData = await getNSById(nsId);
                
                nsData.verification = {
                    date: new Date().toISOString(),
                    conductedBy: currentUser.name,
                    method: verificationData.method,
                    results: verificationData.results,
                    isEffective: verificationData.isEffective,
                    effectivenessEvidence: verificationData.evidence
                };
                
                if (verificationData.isEffective) {
                    nsData.status = 'closed';
                    nsData.stage = 'closed';
                    nsData.closedDate = new Date().toISOString();
                    nsData.closedBy = currentUser.name;
                    
                    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –∑–∞–∫—Ä—ã—Ç–∏–∏
                    await window.emailService.sendNotification('closed', nsData);
                    
                    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç
                    generateFinalReport(nsData);
                    
                } else {
                    nsData.status = 'rework';
                    nsData.verificationNotes = '–ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É—é—â–∏–µ –¥–µ–π—Å—Ç–≤–∏—è –Ω–µ—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã, —Ç—Ä–µ–±—É–µ—Ç—Å—è –¥–æ—Ä–∞–±–æ—Ç–∫–∞';
                }
                
                await window.gsheets.saveNS(nsData);
                showNotification('–í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∞', 'success');
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏:', error);
                showNotification('–û—à–∏–±–∫–∞: ' + error.message, 'error');
            }
        }
        
        // ========== –ê–£–î–ò–û–ó–ê–ü–ò–°–¨ UI ==========
        
        function initAudioRecording() {
            const audioControls = `
                <div class="audio-controls">
                    <button id="startRecording" class="btn btn-warning" onclick="startAudioRecording()">
                        üé§ –ù–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—å
                    </button>
                    <button id="stopRecording" class="btn btn-danger" onclick="stopAudioRecording()" disabled>
                        ‚èπÔ∏è –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
                    </button>
                    <button id="playRecording" class="btn btn-info" onclick="playAudioRecording()" disabled>
                        ‚ñ∂Ô∏è –ü—Ä–æ—Å–ª—É—à–∞—Ç—å
                    </button>
                </div>
                <div class="audio-visualizer">
                    <div class="audio-wave" id="audioWave"></div>
                </div>
                <div id="audioPreview" class="audio-preview"></div>
            `;
            
            return audioControls;
        }
        
        async function startAudioRecording() {
            try {
                const success = await window.audioRecorder.startRecording();
                
                if (success) {
                    document.getElementById('startRecording').disabled = true;
                    document.getElementById('stopRecording').disabled = false;
                    showNotification('–ó–∞–ø–∏—Å—å –Ω–∞—á–∞—Ç–∞...', 'info');
                } else {
                    showNotification('–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—å', 'error');
                }
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –Ω–∞—á–∞–ª–∞ –∑–∞–ø–∏—Å–∏:', error);
                
                // –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –º–µ—Ç–æ–¥ –¥–ª—è —Å—Ç–∞—Ä—ã—Ö iOS
                if (error.message.includes('MediaRecorder')) {
                    showNotification('–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≥–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥ —Ç–µ–∫—Å—Ç–∞ –≤–º–µ—Å—Ç–æ –∑–∞–ø–∏—Å–∏', 'warning');
                    startVoiceInput(); // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞—Ä—ã–π –º–µ—Ç–æ–¥ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ –≤–≤–æ–¥–∞
                }
            }
        }
        
        async function stopAudioRecording() {
            const audioData = window.audioRecorder.stopRecording();
            
            if (audioData) {
                document.getElementById('startRecording').disabled = false;
                document.getElementById('stopRecording').disabled = true;
                document.getElementById('playRecording').disabled = false;
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∞—É–¥–∏–æ
                window.currentAudio = audioData;
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–≤—å—é
                const preview = document.getElementById('audioPreview');
                preview.innerHTML = `
                    <p><strong>–ê—É–¥–∏–æ–∑–∞–ø–∏—Å—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞</strong></p>
                    <audio controls src="${audioData.url}"></audio>
                    <button class="btn btn-sm btn-danger" onclick="removeAudioRecording()" style="margin-top: 10px;">
                        ‚ùå –£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å
                    </button>
                `;
                
                showNotification('–ó–∞–ø–∏—Å—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞', 'success');
            }
        }
        
        function playAudioRecording() {
            if (window.currentAudio && window.currentAudio.url) {
                const audio = new Audio(window.currentAudio.url);
                audio.play();
            }
        }
        
        function removeAudioRecording() {
            window.currentAudio = null;
            document.getElementById('audioPreview').innerHTML = '';
            document.getElementById('playRecording').disabled = true;
        }
        
        // ========== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ==========
        
        function generateNSNumber() {
            const year = new Date().getFullYear().toString().slice(-2);
            const month = (new Date().getMonth() + 1).toString().padStart(2, '0');
            const random = Math.floor(Math.random() * 999).toString().padStart(3, '0');
            return `NS-${year}${month}-${random}`;
        }
        
        function validateNSData(data) {
            const required = ['department', 'location', 'applicant', 'description'];
            const missing = required.filter(field => !data[field] || data[field].trim() === '');
            
            if (missing.length > 0) {
                showNotification(`–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è: ${missing.join(', ')}`, 'error');
                return false;
            }
            
            return true;
        }
        
        async function getNSById(nsId) {
            const allData = await window.gsheets.loadAllNS();
            return allData.find(ns => ns.nsNumber === nsId || ns.localId === nsId);
        }
        
        function generateFinalReport(nsData) {
            // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è PDF –æ—Ç—á–µ—Ç–∞ –¥–ª—è –ø–µ—á–∞—Ç–∏
            const report = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>–û—Ç—á–µ—Ç –ø–æ –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—é ${nsData.nsNumber}</title>
                    <style>
                        body { font-family: Arial; padding: 20px; }
                        .header { text-align: center; margin-bottom: 30px; }
                        .section { margin: 20px 0; }
                        .signature-area { margin-top: 50px; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>–§–ê–†–ú–°–¢–ò–õ</h1>
                        <h2>–õ–∏—Å—Ç –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è ${nsData.nsNumber}</h2>
                        <p>ISO 13485</p>
                    </div>
                    
                    <div class="section">
                        <h3>1. –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è</h3>
                        <p><strong>–î–∞—Ç–∞ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è:</strong> ${nsData.detectionDate}</p>
                        <p><strong>–ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ:</strong> ${nsData.department}</p>
                        <p><strong>–ú–µ—Å—Ç–æ:</strong> ${nsData.location}</p>
                        <p><strong>–ó–∞—è–≤–∏—Ç–µ–ª—å:</strong> ${nsData.applicant}</p>
                    </div>
                    
                    ${nsData.rootCauseAnalysis ? `
                    <div class="section">
                        <h3>2. –ê–Ω–∞–ª–∏–∑ –∫–æ—Ä–µ–Ω–Ω—ã—Ö –ø—Ä–∏—á–∏–Ω</h3>
                        <p>${nsData.rootCauseAnalysis}</p>
                    </div>
                    ` : ''}
                    
                    ${nsData.correctiveActions ? `
                    <div class="section">
                        <h3>3. –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É—é—â–∏–µ –¥–µ–π—Å—Ç–≤–∏—è</h3>
                        <p>${nsData.correctiveActions}</p>
                    </div>
                    ` : ''}
                    
                    ${nsData.verification ? `
                    <div class="section">
                        <h3>4. –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</h3>
                        <p><strong>–†–µ–∑—É–ª—å—Ç–∞—Ç:</strong> ${nsData.verification.isEffective ? '–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ' : '–ù–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ'}</p>
                        <p><strong>–î–∞—Ç–∞:</strong> ${nsData.verification.date}</p>
                    </div>
                    ` : ''}
                    
                    <div class="section signature-area">
                        <h3>–ü–æ–¥–ø–∏—Å–∏:</h3>
                        <table style="width: 100%;">
                            <tr>
                                <td>–î–∏—Ä–µ–∫—Ç–æ—Ä –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞: ___________________</td>
                                <td>–î–∞—Ç–∞: ___________</td>
                            </tr>
                            <tr>
                                <td>–ù–∞—á–∞–ª—å–Ω–∏–∫ —Ü–µ—Ö–∞: ___________________</td>
                                <td>–î–∞—Ç–∞: ___________</td>
                            </tr>
                            <tr>
                                <td>–ú–µ–Ω–µ–¥–∂–µ—Ä –°–ú–ö: ___________________</td>
                                <td>–î–∞—Ç–∞: ___________</td>
                            </tr>
                        </table>
                    </div>
                </body>
                </html>
            `;
            
            // –û—Ç–∫—Ä—ã–≤–∞–µ–º –≤ –Ω–æ–≤–æ–º –æ–∫–Ω–µ –¥–ª—è –ø–µ—á–∞—Ç–∏
            const printWindow = window.open('', '_blank');
            printWindow.document.write(report);
            printWindow.document.close();
        }
        
        // –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –≤ –≥–ª–æ–±–∞–ª—å–Ω—É—é –æ–±–ª–∞—Å—Ç—å
        window.submitWorkerForm = submitWorkerForm;
        window.assignResponsible = assignResponsible;
        window.submitCorrectionPlan = submitCorrectionPlan;
        window.approveCorrectionPlan = approveCorrectionPlan;
        window.submitExecutionReport = submitExecutionReport;
        window.submitVerification = submitVerification;
        window.startAudioRecording = startAudioRecording;
        window.stopAudioRecording = stopAudioRecording;
        window.playAudioRecording = playAudioRecording;
        window.removeAudioRecording = removeAudioRecording;
        
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–§–ê–†–ú–°–¢–ò–õ - ISO 13485</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        /* –í–µ—Å—å –≤–∞—à –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –≤–∏–∑—É–∞–ª —Å–æ—Ö—Ä–∞–Ω–µ–Ω */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 10px; }
        .container { max-width: 1200px; margin: 0 auto; background: white; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); overflow: hidden; }
        .header { background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); color: white; padding: 20px; text-align: center; }
        .menu { display: flex; background: linear-gradient(90deg, #4b6cb7 0%, #182848 100%); padding: 0; gap: 1px; flex-wrap: wrap; }
        .menu-btn { padding: 12px 15px; background: white; border: none; color: #1e3c72; font-weight: bold; cursor: pointer; flex: 1; min-width: 120px; }
        .menu-btn.active { background: #1e3c72; color: white; }
        .page { display: none; padding: 20px; }
        .page.active { display: block; }
        .form-grid { display: flex; flex-direction: column; gap: 15px; margin: 20px 0; }
        .form-group { display: flex; flex-direction: column; width: 100%; }
        label { margin-bottom: 6px; font-weight: 600; font-size: 14px; }
        input, select, textarea { padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px; }
        .btn { padding: 14px 20px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; margin: 5px 0; }
        .btn-primary { background: #1e3c72; color: white; }
        .btn-success { background: #28a745; color: white; }
        .photo-preview-container { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; }
        .photo-preview { width: 100px; height: 100px; object-fit: cover; border-radius: 8px; border: 2px solid #ddd; }
        .worker-container { max-width: 800px; margin: 20px auto; background: white; border-radius: 15px; overflow: hidden; }
        .worker-header { background: #1e3c72; color: white; padding: 20px; text-align: center; }
        .form-section { background: #f8f9fa; border-radius: 10px; padding: 20px; margin-bottom: 20px; border-left: 4px solid #1e3c72; }
        .required::after { content: " *"; color: #dc3545; }
    </style>
</head>
<body>
    <div id="workerMode" style="display: none;">
        <div class="worker-container">
            <div class="worker-header">
                <h1>üìù –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è</h1>
            </div>
            <div id="workerContent" style="padding: 20px;"></div>
        </div>
    </div>

    <div id="adminMode">
        <div class="container">
            <div class="header"><h1>–§–ê–†–ú–°–¢–ò–õ - –ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å</h1></div>
            <div class="menu">
                <button class="menu-btn active" onclick="location.reload()">üéØ –°–æ–∑–¥–∞—Ç—å QR</button>
                <button class="menu-btn" onclick="showPage('listNS')">üìã –°–ø–∏—Å–æ–∫ –õ–ù</button>
            </div>
            <div class="page active" id="generateQRPage">
                <div class="form-grid">
                    <div class="form-group">
                        <label>üè≠ –ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ:</label>
                        <select id="qrDepartment">
                            <option value="–¶–µ—Ö ‚Ññ1">–¶–µ—Ö ‚Ññ1</option>
                            <option value="–¶–µ—Ö ‚Ññ2">–¶–µ—Ö ‚Ññ2</option>
                            <option value="–û–¢–ö">–û–¢–ö</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>üìç –ú–µ—Å—Ç–æ:</label>
                        <input type="text" id="qrLocation" placeholder="–°—Ç–∞–Ω–æ–∫ ‚Ññ1">
                    </div>
                </div>
                <button class="btn btn-primary" onclick="generateQRCode()">üéØ –°–æ–∑–¥–∞—Ç—å QR-–∫–æ–¥</button>
                <div id="qrPreview" style="text-align:center; margin-top:20px;"></div>
            </div>
            <div class="page" id="listNSPage">
                <div id="nsListContainer"></div>
            </div>
        </div>
    </div>

    <script>
        const GOOGLE_APP_URL = 'https://script.google.com/macros/s/AKfycbzC-ySCf4MqMDd1Kl_DHPgfz8Q7OhgLNKtMQv2E1XzHHZc2G7S1isL7ubWt7xcdclEC/exec';
        let photos = [];

        document.addEventListener('DOMContentLoaded', () => {
            const params = new URLSearchParams(window.location.search);
            if (params.get('mode') === 'worker') {
                document.getElementById('adminMode').style.display = 'none';
                document.getElementById('workerMode').style.display = 'block';
                showWorkerForm(params);
            }
        });

        function showWorkerForm(params) {
            const dept = params.get('department') || '–ù–µ —É–∫–∞–∑–∞–Ω–æ';
            const loc = params.get('location') || '–ù–µ —É–∫–∞–∑–∞–Ω–æ';
            
            document.getElementById('workerContent').innerHTML = `
                <div class="form-section">
                    <p><strong>–¶–µ—Ö:</strong> ${dept} | <strong>–ú–µ—Å—Ç–æ:</strong> ${loc}</p>
                </div>
                <form onsubmit="submitForm(event, '${dept}', '${loc}')">
                    <div class="form-section">
                        <h3>üë§ –ó–∞—è–≤–∏—Ç–µ–ª—å</h3>
                        <div class="form-group"><label class="required">–§–ò–û</label><input type="text" id="fio" required></div>
                        <div class="form-group"><label>–¢–µ–ª–µ—Ñ–æ–Ω</label><input type="tel" id="tel"></div>
                    </div>
                    <div class="form-section">
                        <h3>üìã –ü—Ä–æ–±–ª–µ–º–∞</h3>
                        <div class="form-group"><label class="required">–û–ø–∏—Å–∞–Ω–∏–µ</label><textarea id="desc" rows="4" required></textarea></div>
                        <div class="form-group">
                            <label>üì∑ –§–æ—Ç–æ (–º–∞–∫—Å 2)</label>
                            <input type="file" accept="image/*" multiple onchange="handlePhotos(event)">
                            <div id="preview" class="photo-preview-container"></div>
                        </div>
                    </div>
                    <button type="submit" id="subBtn" class="btn btn-success" style="width:100%">üì§ –û–¢–ü–†–ê–í–ò–¢–¨</button>
                </form>
            `;
        }

        function handlePhotos(e) {
            const preview = document.getElementById('preview');
            preview.innerHTML = '';
            photos = [];
            
            Array.from(e.target.files).slice(0, 2).forEach(file => {
                const reader = new FileReader();
                reader.onload = (event) => {
                    const imgData = event.target.result;
                    photos.push(imgData);
                    const img = document.createElement('img');
                    img.src = imgData;
                    img.className = 'photo-preview';
                    preview.appendChild(img);
                };
                reader.readAsDataURL(file);
            });
        }

        async function submitForm(e, dept, loc) {
            e.preventDefault();
            const btn = document.getElementById('subBtn');
            btn.disabled = true;
            btn.innerText = '‚è≥ –û—Ç–ø—Ä–∞–≤–∫–∞...';

            const nsData = {
                id: 'ns_' + Date.now(),
                nsNumber: '–õ–ù-' + Math.floor(Math.random() * 10000),
                created: new Date().toISOString(),
                department: dept,
                location: loc,
                applicant: document.getElementById('fio').value,
                phone: document.getElementById('tel').value,
                description: document.getElementById('desc').value,
                photoCount: photos.length,
                status: 'detected'
            };

            try {
                // 1. –°–æ—Ö—Ä–∞–Ω—è–µ–º –í–°–Å (–≤–∫–ª—é—á–∞—è —Ñ–æ—Ç–æ) –≤ –ª–æ–∫–∞–ª—å–Ω—É—é –ø–∞–º—è—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω–∞
                const localData = JSON.parse(localStorage.getItem('farmstil_ns') || '[]');
                localData.push({...nsData, photos: photos}); 
                localStorage.setItem('farmstil_ns', JSON.stringify(localData));

                // 2. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ Google Sheets —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç (—á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –æ—à–∏–±–∫–∏ URL too long)
                const sheetUrl = `${GOOGLE_APP_URL}?action=add_ns&data=${encodeURIComponent(JSON.stringify(nsData))}`;
                await fetch(sheetUrl, { mode: 'no-cors' });

                document.getElementById('workerContent').innerHTML = `
                    <div style="text-align:center; padding:40px;">
                        <h2 style="color:green">‚úÖ –£—Å–ø–µ—à–Ω–æ!</h2>
                        <p>–í–∞—à–∞ –∑–∞—è–≤–∫–∞ ${nsData.nsNumber} –ø—Ä–∏–Ω—è—Ç–∞.</p>
                    </div>`;
            } catch (err) {
                alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏, –Ω–æ –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –ª–æ–∫–∞–ª—å–Ω–æ!');
            }
        }

        function generateQRCode() {
            const dept = document.getElementById('qrDepartment').value;
            const loc = document.getElementById('qrLocation').value;
            const url = `${window.location.origin}${window.location.pathname}?mode=worker&department=${encodeURIComponent(dept)}&location=${encodeURIComponent(loc)}`;
            
            const preview = document.getElementById('qrPreview');
            preview.innerHTML = '<div id="qrcode" style="display:inline-block; padding:10px; background:white;"></div>';
            new QRCode(document.getElementById('qrcode'), { text: url, width: 200, height: 200 });
            preview.innerHTML += `<p style="margin-top:10px;">–°—Å—ã–ª–∫–∞: <a href="${url}" target="_blank">–û—Ç–∫—Ä—ã—Ç—å —Ñ–æ—Ä–º—É</a></p>`;
        }

        function showPage(id) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(id + 'Page').classList.add('active');
            if(id === 'listNS') renderList();
        }

        function renderList() {
            const list = JSON.parse(localStorage.getItem('farmstil_ns') || '[]');
            const cont = document.getElementById('nsListContainer');
            cont.innerHTML = list.length ? '' : '<p>–°–ø–∏—Å–æ–∫ –ø—É—Å—Ç</p>';
            
            list.reverse().forEach(ns => {
                const card = document.createElement('div');
                card.className = 'form-section';
                card.style.borderLeft = '4px solid #28a745';
                card.innerHTML = `
                    <h4>${ns.nsNumber} - ${ns.applicant}</h4>
                    <p>${ns.description}</p>
                    <div class="photo-preview-container">
                        ${(ns.photos || []).map(p => `<img src="${p}" class="photo-preview">`).join('')}
                    </div>
                `;
                cont.appendChild(card);
            });
        }
    </script>
</body>
</html>

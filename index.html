<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–§–ê–†–ú–°–¢–ò–õ - –°–∏—Å—Ç–µ–º–∞ ISO 13485</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <style>
        /* –¢–≤–æ–∏ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –ø–æ–ª–Ω–æ—Å—Ç—å—é */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 10px; }
        .container { max-width: 1200px; margin: 0 auto; background: white; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); overflow: hidden; }
        .header { background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); color: white; padding: 20px; text-align: center; }
        .menu { display: flex; background: #f8f9fa; border-bottom: 1px solid #ddd; flex-wrap: wrap; }
        .menu-btn { padding: 15px; border: none; background: none; cursor: pointer; font-weight: bold; flex: 1; min-width: 100px; }
        .menu-btn.active { background: #1e3c72; color: white; }
        .page { display: none; padding: 20px; }
        .page.active { display: block; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; }
        .btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; margin: 5px 0; }
        .btn-primary { background: #1e3c72; color: white; }
        .qr-container { padding: 20px; background: white; display: inline-block; border: 1px solid #ccc; margin-top: 10px; }
        #qrPreview { text-align: center; display: none; border-top: 2px solid #eee; margin-top: 20px; }
        .ln-card { border: 1px solid #ddd; padding: 15px; border-radius: 8px; margin-bottom: 10px; }
        .notification { position: fixed; top: 20px; right: 20px; background: #28a745; color: white; padding: 15px; border-radius: 5px; display: none; z-index: 9999; }
    </style>
</head>
<body>

    <div id="notification" class="notification"></div>

    <div id="workerMode" style="display: none; padding: 20px;">
        <div class="container" style="max-width: 600px;">
            <div class="header">
                <h2>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –õ–ù</h2>
                <p id="workerLocationInfo"></p>
            </div>
            <div style="padding: 20px;">
                <form id="nsForm">
                    <div class="form-group">
                        <label>–§–ò–û –∑–∞—è–≤–∏—Ç–µ–ª—è:</label>
                        <input type="text" id="applicantName" required>
                    </div>
                    <div class="form-group">
                        <label>–û–ø–∏—Å–∞–Ω–∏–µ –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è:</label>
                        <textarea id="nsDescription" rows="5" required></textarea>
                    </div>
                    <div class="form-group">
                        <label>–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–æ—Ç–æ:</label>
                        <input type="file" id="nsPhotos" accept="image/*" multiple>
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%;">–û–¢–ü–†–ê–í–ò–¢–¨</button>
                </form>
            </div>
        </div>
    </div>

    <div id="adminMode">
        <div class="container">
            <div class="header">
                <h1>–§–ê–†–ú–°–¢–ò–õ ISO 13485</h1>
            </div>
            <div class="menu">
                <button class="menu-btn active" onclick="showPage('gen')">–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä QR</button>
                <button class="menu-btn" onclick="showPage('list')">–°–ø–∏—Å–æ–∫ –õ–ù</button>
                <button class="menu-btn" onclick="showPage('settings')">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
            </div>

            <div id="genPage" class="page active">
                <h3>–ì–µ–Ω–µ—Ä–∞—Ü–∏—è QR-–∫–æ–¥–∞ –¥–ª—è —É—á–∞—Å—Ç–∫–∞</h3>
                <div class="form-group">
                    <label>–ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ:</label>
                    <input type="text" id="dept" placeholder="–ù–∞–ø—Ä: –¶–µ—Ö ‚Ññ1">
                </div>
                <div class="form-group">
                    <label>–†–∞–±–æ—á–µ–µ –º–µ—Å—Ç–æ / –°—Ç–∞–Ω–æ–∫:</label>
                    <input type="text" id="pos" placeholder="–ù–∞–ø—Ä: –õ–∏–Ω–∏—è —Ä–æ–∑–ª–∏–≤–∞">
                </div>
                <button class="btn btn-primary" onclick="generateQRCode()">–°–æ–∑–¥–∞—Ç—å QR-–∫–æ–¥</button>
                
                <div id="qrPreview">
                    <div id="qrcode" class="qr-container"></div>
                    <div id="qrLinkInfo" style="margin-top: 10px; font-size: 12px; color: #666;"></div>
                </div>
            </div>

            <div id="listPage" class="page">
                <h3>–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è</h3>
                <div id="nsList"></div>
            </div>

            <div id="settingsPage" class="page">
                <h3>–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å Google Sheets</h3>
                <button class="btn btn-primary" onclick="syncWithGoogle()">–í—ã–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Å–µ–π—á–∞—Å</button>
            </div>
        </div>
    </div>

    <script>
        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
        const GOOGLE_URL = '–¢–í–û–Ø_–°–°–´–õ–ö–ê_–ù–ê_GOOGLE_SCRIPT'; // –ó–∞–º–µ–Ω–∏ –Ω–∞ —Å–≤–æ—é

        // 1. –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –õ–û–ì–ò–ö–ê –û–ü–†–ï–î–ï–õ–ï–ù–ò–Ø –ü–£–¢–ò
        function getBaseUrl() {
            // –ë–µ—Ä–µ–º —Ç–µ–∫—É—â–∏–π –ø—É—Ç—å –±–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∏ index.html
            let path = window.location.pathname;
            if (path.endsWith('index.html')) {
                path = path.substring(0, path.lastIndexOf('/') + 1);
            }
            return window.location.origin + path;
        }

        document.addEventListener('DOMContentLoaded', () => {
            checkUrlParams();
            if (document.getElementById('listPage').classList.contains('active')) renderList();
        });

        function checkUrlParams() {
            const params = new URLSearchParams(window.location.search);
            if (params.has('mode') && params.get('mode') === 'worker') {
                document.getElementById('adminMode').style.display = 'none';
                document.getElementById('workerMode').style.display = 'block';
                const qrCode = params.get('qrcode');
                document.getElementById('workerLocationInfo').innerText = "–ö–æ–¥ –ª–æ–∫–∞—Ü–∏–∏: " + (qrCode || "–û–±—â–∏–π");
            }
        }

        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.menu-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(pageId + 'Page').classList.add('active');
            event.currentTarget.classList.add('active');
            if (pageId === 'list') renderList();
        }

        // 2. –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –ì–ï–ù–ï–†–ê–¶–ò–Ø QR
        function generateQRCode() {
            const dept = document.getElementById('dept').value;
            const pos = document.getElementById('pos').value;
            if (!dept || !pos) return alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ —É—á–∞—Å—Ç–∫–∞");

            const uniqueId = btoa(unescape(encodeURIComponent(dept + "|" + pos))).slice(0, 8);
            
            // –§–æ—Ä–º–∏—Ä—É–µ–º URL –ø—Ä–∞–≤–∏–ª—å–Ω–æ –¥–ª—è GitHub Pages
            const baseUrl = getBaseUrl();
            const finalUrl = `${baseUrl}?mode=worker&qrcode=${uniqueId}`;

            const qrContainer = document.getElementById('qrcode');
            qrContainer.innerHTML = '';
            
            new QRCode(qrContainer, {
                text: finalUrl,
                width: 200,
                height: 200
            });

            document.getElementById('qrPreview').style.display = 'block';
            document.getElementById('qrLinkInfo').innerText = "–°—Å—ã–ª–∫–∞: " + finalUrl;
            
            showNotification("QR-–∫–æ–¥ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω");
        }

        // 3. –°–û–•–†–ê–ù–ï–ù–ù–ê–Ø –õ–û–ì–ò–ö–ê –§–û–†–ú–´
        document.getElementById('nsForm').onsubmit = async function(e) {
            e.preventDefault();
            
            const photos = [];
            const fileInput = document.getElementById('nsPhotos');
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ç–æ –≤ Base64 (–∫–∞–∫ –±—ã–ª–æ —É —Ç–µ–±—è)
            if (fileInput.files.length > 0) {
                for (let file of fileInput.files) {
                    const base64 = await toBase64(file);
                    photos.push(base64);
                }
            }

            const newNS = {
                id: Date.now(),
                applicant: document.getElementById('applicantName').value,
                desc: document.getElementById('nsDescription').value,
                location: new URLSearchParams(window.location.search).get('qrcode'),
                date: new Date().toLocaleString(),
                photos: photos,
                status: 'new'
            };

            const data = JSON.parse(localStorage.getItem('farmstil_data') || '[]');
            data.push(newNS);
            localStorage.setItem('farmstil_data', JSON.stringify(data));

            alert("–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –ª–æ–∫–∞–ª—å–Ω–æ!");
            location.reload(); 
        };

        function renderList() {
            const data = JSON.parse(localStorage.getItem('farmstil_data') || '[]');
            const container = document.getElementById('nsList');
            container.innerHTML = data.reverse().map(item => `
                <div class="ln-card">
                    <strong>ID: ${item.id}</strong><br>
                    <small>${item.date} | –õ–æ–∫–∞—Ü–∏—è: ${item.location}</small><br>
                    <p style="margin-top:10px">${item.desc}</p>
                    <p><i>–ó–∞—è–≤–∏—Ç–µ–ª—å: ${item.applicant}</i></p>
                    ${item.photos.length ? `<p>üì∑ –§–æ—Ç–æ: ${item.photos.length} —à—Ç.</p>` : ''}
                </div>
            `).join('') || '–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π';
        }

        function toBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }

        function showNotification(text) {
            const n = document.getElementById('notification');
            n.innerText = text;
            n.style.display = 'block';
            setTimeout(() => n.style.display = 'none', 3000);
        }

        async function syncWithGoogle() {
            const data = localStorage.getItem('farmstil_data');
            if (!data) return alert("–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏");

            try {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º POST –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Google Sheets
                await fetch(GOOGLE_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: data
                });
                alert("–ó–∞–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ Google Sheets!");
            } catch (e) {
                alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏");
            }
        }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–§–ê–†–ú–°–¢–ò–õ - –°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è–º–∏ ISO 13485</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <style>
        /* [–ó–¥–µ—Å—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤—Å—è –≤–∞—à–∞ CSS-—Å—Ç–∏–ª–∏—Å—Ç–∏–∫–∞ –∏–∑ –æ—Ä–∏–≥–∏–Ω–∞–ª–∞: –≥—Ä–∞–¥–∏–µ–Ω—Ç—ã, –∫–∞—Ä—Ç–æ—á–∫–∏, –º–æ–¥–∞–ª–∫–∏] */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh; padding: 10px;
        }
        .container { max-width: 1200px; margin: 0 auto; background: white; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); overflow: hidden; }
        .header { background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); color: white; padding: 20px; text-align: center; }
        .menu { display: flex; background: linear-gradient(90deg, #4b6cb7 0%, #182848 100%); padding: 0; gap: 1px; flex-wrap: wrap; }
        .menu-btn { padding: 12px 15px; background: white; border: none; color: #1e3c72; font-weight: bold; cursor: pointer; transition: all 0.3s ease; flex: 1; min-width: 120px; font-size: 14px; }
        .menu-btn.active { background: #1e3c72; color: white; }
        .page { display: none; padding: 20px; min-height: 500px; }
        .page.active { display: block; }
        .notification { position: fixed; top: 10px; right: 10px; left: 10px; background: white; color: #333; padding: 15px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.15); display: none; z-index: 1000; border-left: 5px solid #28a745; text-align: center; }
        .notification.error { border-left-color: #dc3545; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; justify-content: center; align-items: center; }
        .modal-content { background: white; border-radius: 15px; padding: 25px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto; }
        .ln-card { background: white; border: 1px solid #e0e0e0; border-radius: 12px; padding: 15px; margin: 10px 0; box-shadow: 0 3px 10px rgba(0,0,0,0.08); }
        .status-badge { padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; }
        .form-grid { display: flex; flex-direction: column; gap: 15px; margin: 20px 0; }
        input, select, textarea { padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px; width: 100%; }
        .btn { padding: 14px 20px; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-primary { background: #1e3c72; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .directory-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #f8f9fa; border-radius: 8px; margin-bottom: 8px; border: 1px solid #e0e0e0; }
        /* Workflow steps */
        .workflow-step { background: #f8f9fa; border-radius: 10px; padding: 20px; margin-bottom: 15px; border-left: 5px solid #1e3c72; position: relative; }
        .workflow-step.active { background: #e8f4ff; border-left-color: #28a745; }
    </style>
</head>
<body>
    <div class="notification" id="notification"></div>
    
    <div class="modal" id="statusModal">
        <div class="modal-content">
            <div class="modal-header" style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3 id="modalTitle">–î–µ—Ç–∞–ª–∏ –õ–ù</h3>
                <button onclick="closeModal()" style="border:none; background:none; font-size:24px; cursor:pointer;">&times;</button>
            </div>
            <div id="modalContent"></div>
        </div>
    </div>

    <div id="workerMode" style="display: none;">
        <div class="container" style="max-width: 800px; margin: 20px auto; padding: 20px;">
            <div class="header" style="border-radius: 10px 10px 0 0;">
                <h1>üìù –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è</h1>
                <p>–§–ê–†–ú–°–¢–ò–õ - –°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–∞—á–µ—Å—Ç–≤–æ–º</p>
            </div>
            <div id="workerContent" style="padding: 20px;">
                <div class="form-grid">
                    <div class="form-group">
                        <label>üìù –û–ø–∏—Å–∞–Ω–∏–µ –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è:</label>
                        <textarea id="ncDescription" rows="5" placeholder="–û–ø–∏—à–∏—Ç–µ, —á—Ç–æ –ø—Ä–æ–∏–∑–æ—à–ª–æ..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>üì∏ –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ (–¥–æ 3-—Ö —à—Ç—É–∫):</label>
                        <input type="file" id="ncPhotos" accept="image/*" multiple onchange="handlePhotoSelect(event)">
                        <div id="photoPreview" style="display:flex; gap:10px; margin-top:10px;"></div>
                    </div>
                    <button class="btn btn-success" onclick="submitNC()">üöÄ –û–¢–ü–†–ê–í–ò–¢–¨ –í –°–ú–ö</button>
                </div>
            </div>
        </div>
    </div>

    <div id="adminMode">
        <div class="container">
            <div class="header">
                <h1>–§–ê–†–ú–°–¢–ò–õ - –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–∞—è –ø–∞–Ω–µ–ª—å</h1>
                <h2>ISO 13485 Workflow</h2>
            </div>
            
            <div class="menu">
                <button class="menu-btn active" onclick="showPage('listNS')">üìã –í—Å–µ –õ–ù</button>
                <button class="menu-btn" onclick="showPage('generateQR')">üéØ –°–æ–∑–¥–∞—Ç—å QR</button>
                <button class="menu-btn" onclick="showPage('workflow')">üîÑ Workflow</button>
                <button class="menu-btn" onclick="showPage('directories')">üìö –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏</button>
                <button class="menu-btn" onclick="showPage('admin')">‚öôÔ∏è –ê–¥–º–∏–Ω</button>
            </div>

            <div class="page active" id="listNSPage">
                <h2>üìã –†–µ–µ—Å—Ç—Ä –õ–∏—Å—Ç–æ–≤ –ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–π</h2>
                <input type="text" id="searchNS" placeholder="üîç –ë—ã—Å—Ç—Ä—ã–π –ø–æ–∏—Å–∫..." onkeyup="filterNS()" style="margin-bottom: 15px;">
                <div id="nsListContainer"></div>
            </div>

            <div class="page" id="generateQRPage">
                <h2>üéØ –°–æ–∑–¥–∞–Ω–∏–µ —Ç–æ—á–∫–∏ –∫–æ–Ω—Ç—Ä–æ–ª—è</h2>
                <div class="form-grid">
                    <input type="text" id="qrDept" placeholder="–¶–µ—Ö/–ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ">
                    <input type="text" id="qrLoc" placeholder="–†–∞–±–æ—á–µ–µ –º–µ—Å—Ç–æ/–°—Ç–∞–Ω–æ–∫">
                    <button class="btn btn-primary" onclick="generateQRCode()">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å QR</button>
                </div>
                <div id="qrPreview" style="text-align: center; display:none; padding: 20px; border: 2px dashed #ccc;"></div>
            </div>

            <div class="page" id="directoriesPage">
                <h2>üìö –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–ª–æ–º</h2>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <h3>üë• –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–µ</h3>
                        <div id="responsiblesList"></div>
                        <div class="directory-input-group" style="margin-top:10px;">
                            <input type="text" id="respName" placeholder="–§–ò–û">
                            <input type="email" id="respEmail" placeholder="Email">
                            <button class="btn btn-success" onclick="addResponsible()">–î–æ–±–∞–≤–∏—Ç—å</button>
                        </div>
                    </div>
                    <div>
                        <h3>üë∑ –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–∏</h3>
                        <div id="executorsList"></div>
                        <div class="directory-input-group" style="margin-top:10px;">
                            <input type="text" id="execName" placeholder="–§–ò–û">
                            <button class="btn btn-success" onclick="addExecutor()">–î–æ–±–∞–≤–∏—Ç—å</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="page" id="adminPage">
                <h2>‚öôÔ∏è –°–∏—Å—Ç–µ–º–∞</h2>
                <div class="form-grid">
                    <button class="btn btn-primary" onclick="backupData()">üíæ –†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è</button>
                    <button class="btn btn-danger" onclick="clearAllData()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö</button>
                    <button class="btn btn-success" onclick="exportToCSV()">üìä –≠–∫—Å–ø–æ—Ä—Ç –≤ Excel (CSV)</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- –ì–õ–û–ë–ê–õ–¨–ù–´–ï –î–ê–ù–ù–´–ï (–í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–û) ---
        let nsData = JSON.parse(localStorage.getItem('farmstil_ns') || '[]');
        let responsibles = JSON.parse(localStorage.getItem('farmstil_responsibles') || '[]');
        let executors = JSON.parse(localStorage.getItem('farmstil_executors') || '[]');
        let selectedPhotos = [];

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        window.onload = function() {
            const params = new URLSearchParams(window.location.search);
            if (params.get('mode') === 'worker') {
                document.getElementById('adminMode').style.display = 'none';
                document.getElementById('workerMode').style.display = 'block';
            }
            renderNSList();
            renderDirectories();
        };

        // --- –õ–û–ì–ò–ö–ê –†–ê–ë–û–ß–ï–ì–û (–° –§–û–¢–û) ---
        function handlePhotoSelect(e) {
            const files = Array.from(e.target.files);
            selectedPhotos = [];
            const preview = document.getElementById('photoPreview');
            preview.innerHTML = '';
            
            files.slice(0, 3).forEach(file => {
                const reader = new FileReader();
                reader.onload = function(event) {
                    selectedPhotos.push(event.target.result);
                    const img = document.createElement('img');
                    img.src = event.target.result;
                    img.style.width = '80px';
                    img.style.height = '80px';
                    img.style.objectFit = 'cover';
                    img.style.borderRadius = '5px';
                    preview.appendChild(img);
                };
                reader.readAsDataURL(file);
            });
        }

        function submitNC() {
            const desc = document.getElementById('ncDescription').value;
            if (!desc) return showNotification('–í–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ!', 'error');

            const params = new URLSearchParams(window.location.search);
            const newNC = {
                id: '–õ–ù-' + Date.now().toString().slice(-6),
                date: new Date().toLocaleString(),
                location: params.get('qrcode') || '–ù–µ —É–∫–∞–∑–∞–Ω–∞',
                description: desc,
                photos: selectedPhotos,
                status: 'checking_smk',
                history: [{ date: new Date().toLocaleString(), action: '–°–æ–∑–¥–∞–Ω' }]
            };

            nsData.push(newNC);
            localStorage.setItem('farmstil_ns', JSON.stringify(nsData));
            showNotification('–£—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!');
            setTimeout(() => window.location.search = '', 2000);
        }

        // --- –õ–û–ì–ò–ö–ê –ê–î–ú–ò–ù–ê (–ü–û–õ–ù–´–ô –§–£–ù–ö–¶–ò–û–ù–ê–õ) ---
        function renderNSList() {
            const container = document.getElementById('nsListContainer');
            if (!container) return;
            container.innerHTML = nsData.length ? '' : '<p>–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π</p>';
            
            nsData.slice().reverse().forEach(ns => {
                const card = document.createElement('div');
                card.className = 'ln-card';
                card.innerHTML = `
                    <div style="display:flex; justify-content:space-between;">
                        <strong>${ns.id}</strong>
                        <span class="status-badge" style="background:#17a2b8; color:white;">${ns.status}</span>
                    </div>
                    <p style="margin:10px 0;">${ns.description}</p>
                    <button class="btn btn-primary btn-sm" onclick="viewNSDetails('${ns.id}')">–û—Ç–∫—Ä—ã—Ç—å –¥–µ—Ç–∞–ª–∏</button>
                `;
                container.appendChild(card);
            });
        }

        function viewNSDetails(id) {
            const ns = nsData.find(item => item.id === id);
            const modal = document.getElementById('statusModal');
            document.getElementById('modalTitle').innerText = `–î–µ—Ç–∞–ª–∏ ${ns.id}`;
            
            let photoHtml = ns.photos.map(p => `<img src="${p}" style="width:100%; margin-bottom:10px; border-radius:10px;">`).join('');
            
            document.getElementById('modalContent').innerHTML = `
                <p><strong>–î–∞—Ç–∞:</strong> ${ns.date}</p>
                <p><strong>–õ–æ–∫–∞—Ü–∏—è:</strong> ${ns.location}</p>
                <div style="margin:15px 0;">${photoHtml}</div>
                <hr>
                <div style="margin-top:15px;">
                    <label>–ù–∞–∑–Ω–∞—á–∏—Ç—å –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ:</label>
                    <select id="assignee">
                        ${responsibles.map(r => `<option value="${r.email}">${r.name}</option>`).join('')}
                    </select>
                    <button class="btn btn-success" style="margin-top:10px; width:100%;" onclick="approveNS('${ns.id}')">–£—Ç–≤–µ—Ä–¥–∏—Ç—å –õ–ù</button>
                </div>
            `;
            modal.style.display = 'flex';
        }

        function approveNS(id) {
            const ns = nsData.find(item => item.id === id);
            ns.status = 'assigned';
            ns.assignedTo = document.getElementById('assignee').value;
            localStorage.setItem('farmstil_ns', JSON.stringify(nsData));
            closeModal();
            renderNSList();
            showNotification('–°—Ç–∞—Ç—É—Å –∏–∑–º–µ–Ω–µ–Ω –Ω–∞: –ù–∞–∑–Ω–∞—á–µ–Ω–æ');
        }

        // --- –£–¢–ò–õ–ò–¢–´ ---
        function generateQRCode() {
            const dept = document.getElementById('qrDept').value;
            const loc = document.getElementById('qrLoc').value;
            if(!dept || !loc) return alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
            
            const code = `FS-${Date.now().toString().slice(-5)}`;
            const url = `${window.location.origin}${window.location.pathname}?mode=worker&qrcode=${code}`;
            const preview = document.getElementById('qrPreview');
            preview.innerHTML = `<h3>${dept} - ${loc}</h3><div id="qrImg" style="display:inline-block; margin:20px;"></div><p>${url}</p>`;
            preview.style.display = 'block';
            new QRCode(document.getElementById("qrImg"), { text: url, width: 200, height: 200 });
        }

        function showPage(id) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.menu-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(id + 'Page').classList.add('active');
            event.currentTarget.classList.add('active');
        }

        function closeModal() { document.getElementById('statusModal').style.display = 'none'; }

        function showNotification(msg, type = 'success') {
            const n = document.getElementById('notification');
            n.innerText = msg; n.className = 'notification ' + type;
            n.style.display = 'block';
            setTimeout(() => n.style.display = 'none', 3000);
        }

        function backupData() {
            const blob = new Blob([JSON.stringify(nsData)], {type: 'application/json'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'fs_backup.json';
            a.click();
        }

        function clearAllData() {
            if(confirm('–£–¥–∞–ª–∏—Ç—å –í–°–ï –∑–∞–ø–∏—Å–∏?')) { localStorage.clear(); location.reload(); }
        }

        function renderDirectories() {
            const rList = document.getElementById('responsiblesList');
            const eList = document.getElementById('executorsList');
            rList.innerHTML = responsibles.map(r => `<div class="directory-item">${r.name} (${r.email})</div>`).join('');
            eList.innerHTML = executors.map(e => `<div class="directory-item">${e.name}</div>`).join('');
        }

        function addResponsible() {
            const name = document.getElementById('respName').value;
            const email = document.getElementById('respEmail').value;
            if(name && email) {
                responsibles.push({name, email});
                localStorage.setItem('farmstil_responsibles', JSON.stringify(responsibles));
                renderDirectories();
            }
        }
        
        function addExecutor() {
            const name = document.getElementById('execName').value;
            if(name) {
                executors.push({name});
                localStorage.setItem('farmstil_executors', JSON.stringify(executors));
                renderDirectories();
            }
        }

        function exportToCSV() {
            let csv = "ID,–î–∞—Ç–∞,–°—Ç–∞—Ç—É—Å,–û–ø–∏—Å–∞–Ω–∏–µ\n";
            nsData.forEach(n => csv += `${n.id},${n.date},${n.status},${n.description}\n`);
            const blob = new Blob([csv], {type: 'text/csv'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'export.csv';
            a.click();
        }
    </script>
</body>
</html>

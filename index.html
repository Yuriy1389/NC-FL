<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–§–ê–†–ú–°–¢–ò–õ - –°–∏—Å—Ç–µ–º–∞ ISO 13485</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh; padding: 10px;
        }
        .container { max-width: 1200px; margin: 0 auto; background: white; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); overflow: hidden; }
        .header { background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); color: white; padding: 20px; text-align: center; }
        .menu { display: flex; background: #182848; gap: 1px; flex-wrap: wrap; }
        .menu-btn { padding: 12px 15px; background: white; border: none; color: #1e3c72; font-weight: bold; cursor: pointer; flex: 1; min-width: 120px; }
        .menu-btn.active { background: #1e3c72; color: white; }
        .page { display: none; padding: 20px; min-height: 500px; }
        .page.active { display: block; }
        .form-grid { display: grid; grid-template-columns: 1fr; gap: 15px; margin: 20px 0; }
        @media (min-width: 768px) { .form-grid { grid-template-columns: 1fr 1fr; } }
        .form-group { display: flex; flex-direction: column; margin-bottom: 15px; }
        label { margin-bottom: 6px; font-weight: 600; color: #333; }
        input, select, textarea { padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px; width: 100%; }
        .btn { padding: 14px 20px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: 0.3s; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-primary { background: #1e3c72; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-warning { background: #ffc107; color: #212529; }
        .btn-info { background: #17a2b8; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .ln-card { background: white; border: 1px solid #e0e0e0; border-radius: 12px; padding: 15px; margin: 10px 0; box-shadow: 0 3px 10px rgba(0,0,0,0.08); }
        .ln-status { padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; }
        .status-detected { background: #ffc107; }
        .status-assigned { background: #6f42c1; color: white; }
        .status-completed { background: #28a745; color: white; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; justify-content: center; align-items: center; }
        .modal-content { background: white; border-radius: 15px; padding: 25px; width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto; }
        .photo-preview-container { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; }
        .photo-preview { width: 80px; height: 80px; object-fit: cover; border-radius: 8px; }
        .notification { position: fixed; top: 20px; right: 20px; padding: 15px 25px; border-radius: 8px; color: white; display: none; z-index: 3000; }
        .worker-container { max-width: 600px; margin: 20px auto; background: white; border-radius: 15px; overflow: hidden; box-shadow: 0 10px 20px rgba(0,0,0,0.2); }
    </style>
</head>
<body>

    <div id="notification" class="notification"></div>

    <div class="modal" id="statusModal">
        <div class="modal-content">
            <h2 id="modalTitle" style="margin-bottom:15px"></h2>
            <div id="modalContent"></div>
            <button class="btn btn-danger" onclick="closeModal()" style="margin-top:20px; width:100%">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>

    <div id="workerMode" style="display:none">
        <div class="worker-container">
            <div class="header"><h3>üìù –§–ê–†–ú–°–¢–ò–õ –°–ú–ö</h3></div>
            <div id="workerContent" style="padding:20px"></div>
        </div>
    </div>

    <div id="adminMode">
        <div class="container">
            <div class="header">
                <h1>–§–ê–†–ú–°–¢–ò–õ - –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</h1>
                <p>–°–∏—Å—Ç–µ–º–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–π ISO 13485</p>
            </div>
            <div class="menu">
                <button class="menu-btn active" onclick="showPage('generateQR')">–°–æ–∑–¥–∞—Ç—å QR</button>
                <button class="menu-btn" onclick="showPage('listNS')">–í—Å–µ –õ–ù</button>
                <button class="menu-btn" onclick="showPage('directories')">–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏</button>
            </div>

            <div class="page active" id="generateQRPage">
                <div class="form-group">
                    <label>–ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ:</label>
                    <select id="qrDepartment">
                        <option value="–ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ">–ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ</option>
                        <option value="–°–∫–ª–∞–¥">–°–∫–ª–∞–¥</option>
                        <option value="–õ–∞–±–æ—Ä–∞—Ç–æ—Ä–∏—è">–õ–∞–±–æ—Ä–∞—Ç–æ—Ä–∏—è</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>–ú–µ—Å—Ç–æ (—Å—Ç–∞–Ω–æ–∫/—É—á–∞—Å—Ç–æ–∫):</label>
                    <input type="text" id="qrLocation" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –£—á–∞—Å—Ç–æ–∫ —É–ø–∞–∫–æ–≤–∫–∏">
                </div>
                <button class="btn btn-primary" onclick="generateQRCode()">–°–æ–∑–¥–∞—Ç—å QR-–∫–æ–¥</button>
                <div id="qrPreview" style="margin-top:20px; text-align:center; display:none">
                    <div id="qrcodeDisplay" style="display:inline-block; padding:10px; border:1px solid #ccc"></div>
                </div>
            </div>

            <div class="page" id="listNSPage">
                <div id="nsListContainer"></div>
            </div>

            <div class="page" id="directoriesPage">
                <h3>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–º–∏</h3>
                <div id="respList" style="margin:15px 0"></div>
                <div class="form-group">
                    <input type="text" id="newRespName" placeholder="–§–ò–û">
                    <input type="email" id="newRespEmail" placeholder="Email" style="margin-top:5px">
                    <button class="btn btn-success" onclick="addResp()" style="margin-top:10px">–î–æ–±–∞–≤–∏—Ç—å</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const WEB3FORMS_KEY = '0f9ce86d-9834-4669-b86e-c0cc782cca96';
        let photos = [];

        // --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ---
        document.addEventListener('DOMContentLoaded', () => {
            if (!localStorage.getItem('farmstil_ns')) localStorage.setItem('farmstil_ns', '[]');
            if (!localStorage.getItem('farmstil_resp')) localStorage.setItem('farmstil_resp', '[]');
            checkUrlParams();
            loadResp();
        });

        function checkUrlParams() {
            const params = new URLSearchParams(window.location.search);
            const mode = params.get('mode');
            const action = params.get('action');
            const nsId = params.get('id');
            const qrcode = params.get('qrcode');

            if (mode === 'worker') {
                document.getElementById('adminMode').style.display = 'none';
                document.getElementById('workerMode').style.display = 'block';
                
                if (action === 'edit' && nsId) {
                    showEditForm(nsId); // –ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–º
                } else {
                    showCreateForm(qrcode); // –ù–æ–≤–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
                }
            }
        }

        // --- –õ–û–ì–ò–ö–ê –†–ê–ë–û–ß–ï–ì–û (–°–æ–∑–¥–∞–Ω–∏–µ) ---
        function showCreateForm(qrcode) {
            document.getElementById('workerContent').innerHTML = `
                <h4>üö® –ù–æ–≤–æ–µ –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ</h4>
                <div class="form-group">
                    <label>–í–∞—à–µ –§–ò–û:</label>
                    <input type="text" id="wName" required>
                </div>
                <div class="form-group">
                    <label>–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã:</label>
                    <textarea id="wDesc" rows="4" required></textarea>
                </div>
                <div class="form-group">
                    <label>–§–æ—Ç–æ:</label>
                    <input type="file" accept="image/*" multiple onchange="handleFiles(event)">
                </div>
                <button class="btn btn-primary" onclick="submitNewNS('${qrcode}')" style="width:100%">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –º–µ–Ω–µ–¥–∂–µ—Ä—É</button>
            `;
        }

        function handleFiles(e) {
            photos = [];
            const files = e.target.files;
            for(let f of files) {
                let r = new FileReader();
                r.onload = (ex) => photos.push(ex.target.result);
                r.readAsDataURL(f);
            }
        }

        function submitNewNS(qr) {
            const name = document.getElementById('wName').value;
            const desc = document.getElementById('wDesc').value;
            if(!name || !desc) return alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª—è');

            const ns = {
                id: 'ns_' + Date.now(),
                num: '–õ–ù-' + Math.floor(Math.random()*1000),
                applicant: name,
                description: desc,
                photos: photos,
                status: 'detected',
                created: new Date().toISOString(),
                qrcode: qr,
                correction: ''
            };

            const list = JSON.parse(localStorage.getItem('farmstil_ns'));
            list.push(ns);
            localStorage.setItem('farmstil_ns', JSON.stringify(list));

            // –ü–∏—Å—å–º–æ –º–µ–Ω–µ–¥–∂–µ—Ä—É
            sendMail('finkart23@mail.ru', '–ù–æ–≤—ã–π –õ–ù: ' + ns.num, `–ü–æ—Å—Ç—É–ø–∏–ª –Ω–æ–≤—ã–π –õ–ù –æ—Ç ${name}. –û–ø–∏—Å–∞–Ω–∏–µ: ${desc}`);

            document.getElementById('workerContent').innerHTML = `
                <div style="text-align:center; padding:30px">
                    <h2 style="color:green">–£—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!</h2>
                    <p>–ù–æ–º–µ—Ä –≤–∞—à–µ–≥–æ –õ–ù: ${ns.num}</p>
                    <button class="btn btn-primary" onclick="window.close()" style="margin-top:20px; width:100%">–ó–∞–∫—Ä—ã—Ç—å –æ–∫–Ω–æ</button>
                </div>
            `;
        }

        // --- –õ–û–ì–ò–ö–ê –û–¢–í–ï–¢–°–¢–í–ï–ù–ù–û–ì–û (–ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è) ---
        function showEditForm(id) {
            const list = JSON.parse(localStorage.getItem('farmstil_ns'));
            const ns = list.find(x => x.id === id);
            if(!ns) return;

            document.getElementById('workerContent').innerHTML = `
                <h4>üõ† –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏–π –ø–æ ${ns.num}</h4>
                <div style="background:#f0f0f0; padding:10px; border-radius:8px; margin-bottom:15px">
                    <small>–ü—Ä–æ–±–ª–µ–º–∞:</small><br><strong>${ns.description}</strong>
                </div>
                <div class="form-group">
                    <label>–ß—Ç–æ –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ (–ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É—é—â–∏–µ –¥–µ–π—Å—Ç–≤–∏—è):</label>
                    <textarea id="wCorrection" rows="6" required>${ns.correction || ''}</textarea>
                </div>
                <button class="btn btn-success" onclick="saveCorrection('${id}')" style="width:100%">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –∑–∞–≤–µ—Ä—à–∏—Ç—å</button>
            `;
        }

        function saveCorrection(id) {
            const corr = document.getElementById('wCorrection').value;
            if(!corr) return alert('–û–ø–∏—à–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏—è');

            const list = JSON.parse(localStorage.getItem('farmstil_ns'));
            const idx = list.findIndex(x => x.id === id);
            list[idx].correction = corr;
            list[idx].status = 'completed';
            localStorage.setItem('farmstil_ns', JSON.stringify(list));

            document.getElementById('workerContent').innerHTML = `
                <div style="text-align:center; padding:30px">
                    <h2 style="color:green">–î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!</h2>
                    <p>–õ–∏—Å—Ç –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω.</p>
                    <button class="btn btn-primary" onclick="window.close()" style="margin-top:20px; width:100%">–ó–∞–∫—Ä—ã—Ç—å –æ–∫–Ω–æ</button>
                </div>
            `;
        }

        // --- –õ–û–ì–ò–ö–ê –ê–î–ú–ò–ù–ê ---
        function showPage(id) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.menu-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(id + 'Page').classList.add('active');
            if(id === 'listNS') renderList();
        }

        function renderList() {
            const list = JSON.parse(localStorage.getItem('farmstil_ns'));
            const cont = document.getElementById('nsListContainer');
            cont.innerHTML = list.length ? '' : '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö';
            
            list.reverse().forEach(ns => {
                const card = document.createElement('div');
                card.className = 'ln-card';
                card.innerHTML = `
                    <div style="display:flex; justify-content:space-between">
                        <strong>${ns.num}</strong>
                        <span class="ln-status status-${ns.status}">${ns.status}</span>
                    </div>
                    <p style="margin:5px 0">${ns.description.substring(0,50)}...</p>
                    <div style="margin-top:10px">
                        <button class="btn btn-info btn-sm" onclick="viewDetails('${ns.id}')">üëÅ –ü—Ä–æ—Å–º–æ—Ç—Ä</button>
                        ${ns.status === 'detected' ? `<button class="btn btn-warning btn-sm" style="margin-top:5px" onclick="openAssign('${ns.id}')">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å / –ù–∞–∑–Ω–∞—á–∏—Ç—å</button>` : ''}
                    </div>
                `;
                cont.appendChild(card);
            });
        }

        function openAssign(id) {
            const resps = JSON.parse(localStorage.getItem('farmstil_resp'));
            let options = resps.map(r => `<option value="${r.email}">${r.name}</option>`).join('');
            
            document.getElementById('modalTitle').innerText = '–ù–∞–∑–Ω–∞—á–∏—Ç—å –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ';
            document.getElementById('modalContent').innerHTML = `
                <div class="form-group">
                    <label>–í—ã–±–µ—Ä–∏—Ç–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ:</label>
                    <select id="selResp">${options}</select>
                </div>
                <button class="btn btn-success" onclick="confirmAssign('${id}')" style="width:100%">–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å—Å—ã–ª–∫—É –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—é</button>
            `;
            document.getElementById('statusModal').style.display = 'flex';
        }

        function confirmAssign(id) {
            const email = document.getElementById('selResp').value;
            const list = JSON.parse(localStorage.getItem('farmstil_ns'));
            const idx = list.findIndex(x => x.id === id);
            
            list[idx].status = 'assigned';
            localStorage.setItem('farmstil_ns', JSON.stringify(list));

            // –°—Å—ã–ª–∫–∞ –¥–ª—è –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ
            const link = window.location.origin + window.location.pathname + `?mode=worker&action=edit&id=${id}`;
            
            sendMail(email, '–í–∞–º –Ω–∞–∑–Ω–∞—á–µ–Ω –õ–ù: ' + list[idx].num, 
                `–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –í–∞–º –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∑–∞–ø–æ–ª–Ω–∏—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É—é—â–∏–µ –¥–µ–π—Å—Ç–≤–∏—è –ø–æ —Å—Å—ã–ª–∫–µ: ${link}`);

            closeModal();
            renderList();
            alert('–°—Å—ã–ª–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–º—É');
        }

        function viewDetails(id) {
            const ns = JSON.parse(localStorage.getItem('farmstil_ns')).find(x => x.id === id);
            document.getElementById('modalTitle').innerText = ns.num;
            document.getElementById('modalContent').innerHTML = `
                <p><strong>–ó–∞—è–≤–∏—Ç–µ–ª—å:</strong> ${ns.applicant}</p>
                <p><strong>–û–ø–∏—Å–∞–Ω–∏–µ:</strong> ${ns.description}</p>
                <p><strong>–î–µ–π—Å—Ç–≤–∏—è:</strong> ${ns.correction || '<i>–Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ</i>'}</p>
                <div class="photo-preview-container">
                    ${ns.photos.map(p => `<img src="${p}" class="photo-preview">`).join('')}
                </div>
            `;
            document.getElementById('statusModal').style.display = 'flex';
        }

        // --- –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï ---
        function generateQRCode() {
            const dep = document.getElementById('qrDepartment').value;
            const loc = document.getElementById('qrLocation').value;
            const code = 'QR' + Date.now();
            const url = window.location.origin + window.location.pathname + `?mode=worker&qrcode=${code}`;
            
            document.getElementById('qrPreview').style.display = 'block';
            document.getElementById('qrcodeDisplay').innerHTML = '';
            new QRCode(document.getElementById('qrcodeDisplay'), { text: url, width: 150, height: 150 });
        }

        function addResp() {
            const name = document.getElementById('newRespName').value;
            const email = document.getElementById('newRespEmail').value;
            if(!name || !email) return;
            const list = JSON.parse(localStorage.getItem('farmstil_resp'));
            list.push({name, email});
            localStorage.setItem('farmstil_resp', JSON.stringify(list));
            loadResp();
        }

        function loadResp() {
            const list = JSON.parse(localStorage.getItem('farmstil_resp') || '[]');
            const cont = document.getElementById('respList');
            if(cont) cont.innerHTML = list.map(r => `<div>${r.name} (${r.email})</div>`).join('');
        }

        function sendMail(to, sub, msg) {
            fetch('https://api.web3forms.com/submit', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ access_key: WEB3FORMS_KEY, to_email: to, subject: sub, message: msg })
            });
        }

        function closeModal() { document.getElementById('statusModal').style.display = 'none'; }
    </script>
</body>
</html>

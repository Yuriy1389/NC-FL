<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–§–ê–†–ú–°–¢–ò–õ - –°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è–º–∏ ISO 13485</title>
    
    <!-- –ë–∏–±–ª–∏–æ—Ç–µ–∫–∏ -->
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    
    <style>
        /* [–í–µ—Å—å CSS –æ—Å—Ç–∞–µ—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π] */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 24px;
            margin-bottom: 8px;
        }
        
        .header h2 {
            font-size: 14px;
            font-weight: normal;
            opacity: 0.9;
        }
        
        .menu {
            display: flex;
            background: linear-gradient(90deg, #4b6cb7 0%, #182848 100%);
            padding: 0;
            gap: 1px;
            flex-wrap: wrap;
        }
        
        .menu-btn {
            padding: 12px 15px;
            background: white;
            border: none;
            color: #1e3c72;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            flex: 1;
            min-width: 120px;
            font-size: 14px;
        }
        
        .menu-btn.active {
            background: #1e3c72;
            color: white;
        }
        
        .page {
            display: none;
            padding: 20px;
            min-height: 500px;
        }
        
        .page.active {
            display: block;
        }
        
        .form-grid {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin: 20px 0;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            width: 100%;
        }
        
        label {
            margin-bottom: 6px;
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }
        
        input, select, textarea {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            width: 100%;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }
        
        select {
            background: white url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%231e3c72' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e") no-repeat right 10px center;
            background-size: 16px;
        }
        
        .btn {
            padding: 14px 20px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin: 5px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
        }
        
        .btn-primary {
            background: #1e3c72;
            color: white;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-warning {
            background: #ffc107;
            color: #212529;
        }
        
        .btn-info {
            background: #17a2b8;
            color: white;
        }
        
        .notification {
            position: fixed;
            top: 10px;
            right: 10px;
            left: 10px;
            background: white;
            color: #333;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.15);
            display: none;
            z-index: 1000;
            border-left: 5px solid #28a745;
            text-align: center;
        }
        
        .notification.error { border-left-color: #dc3545; }
        .notification.warning { border-left-color: #ffc107; }
        .notification.info { border-left-color: #17a2b8; }
        
        .worker-container {
            width: 100%;
            margin: 20px auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        
        .worker-header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 25px;
            text-align: center;
        }
        
        .worker-content {
            padding: 20px;
        }
        
        .worker-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .qr-info-box {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 10px;
            border-left: 5px solid #2196F3;
            margin-bottom: 15px;
        }
        
        .manual-input-box {
            background: #fff3cd;
            padding: 15px;
            border-radius: 10px;
            border-left: 5px solid #ffc107;
            margin-bottom: 15px;
        }
        
        .photo-upload-area {
            border: 3px dashed #28a745;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            background: #f8fff8;
            cursor: pointer;
            margin: 15px 0;
        }
        
        .preview-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        
        .photo-preview {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid #ddd;
            height: 100px;
        }
        
        .photo-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .info-box {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            border-left: 5px solid #1e3c72;
            font-size: 14px;
        }
        
        .ln-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 20px;
        }
        
        .ln-card {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
        }
        
        .ln-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .ln-number {
            font-weight: bold;
            color: #1e3c72;
            font-size: 16px;
        }
        
        .ln-status {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: bold;
            color: white;
        }
        
        .status-checking { background: #ffc107; }
        .status-analysis { background: #2196F3; }
        .status-correction { background: #9C27B0; color: white; }
        .status-execution { background: #FF5722; color: white; }
        .status-verification { background: #4CAF50; color: white; }
        .status-rework { background: #dc3545; }
        .status-closed { background: #607D8B; color: white; }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 25px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-title {
            font-size: 20px;
            color: #1e3c72;
            font-weight: bold;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }
        
        .status-badges {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin: 15px 0;
        }
        
        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            cursor: pointer;
            border: 2px solid transparent;
        }
        
        .status-badge.active {
            border-color: #1e3c72;
            font-weight: bold;
        }
        
        .qr-preview {
            text-align: center;
            padding: 20px;
            border: 3px dashed #1e3c72;
            border-radius: 15px;
            margin-top: 20px;
            background: #f8f9fa;
        }
        
        .ios-warning {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            font-size: 14px;
            color: #856404;
        }
        
        .voice-error {
            background: #f8d7da;
            border: 2px solid #f5c6cb;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            font-size: 14px;
            color: #721c24;
        }
        
        .department-info {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 5px solid #2196F3;
        }
        
        .voice-indicator {
            display: none;
            text-align: center;
            padding: 10px;
            margin: 10px 0;
            background: #d4edda;
            border-radius: 8px;
            color: #155724;
            font-weight: bold;
        }
        
        .voice-indicator.active {
            display: block;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.6; }
            100% { opacity: 1; }
        }
        
        /* –ù–æ–≤—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è workflow */
        .stage-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            margin: 0 5px;
        }
        
        .stage-initiation { background: #ff9800; color: white; }
        .stage-analysis { background: #2196F3; color: white; }
        .stage-correction { background: #4CAF50; color: white; }
        .stage-verification { background: #9C27B0; color: white; }
        .stage-closed { background: #607D8B; color: white; }
        
        .workflow-step {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            position: relative;
        }
        
        .workflow-step.completed {
            border-color: #4CAF50;
            background: #f1f8e9;
        }
        
        .workflow-step.active {
            border-color: #2196F3;
            background: #e3f2fd;
        }
        
        .step-number {
            position: absolute;
            top: -12px;
            left: 20px;
            background: #1e3c72;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            text-align: center;
            line-height: 24px;
            font-weight: bold;
        }
        
        .attachment-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 10px 0;
        }
        
        .attachment-item {
            padding: 8px 12px;
            background: #e3f2fd;
            border-radius: 20px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .signature-block {
            background: #fff3cd;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            border-left: 5px solid #ffc107;
        }
        
        .signature-line {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            padding-bottom: 10px;
            border-bottom: 1px dashed #ddd;
        }
        
        .audio-controls {
            display: flex;
            gap: 10px;
            margin: 10px 0;
            align-items: center;
        }
        
        .audio-visualizer {
            width: 100%;
            height: 50px;
            background: #f0f0f0;
            border-radius: 5px;
            margin: 10px 0;
            overflow: hidden;
        }
        
        .audio-wave {
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, #4CAF50 0%, #8BC34A 100%);
            transform: scaleX(0);
            transform-origin: left;
            transition: transform 0.1s;
        }
        
        .audio-preview {
            margin-top: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #ddd;
        }
        
        @media (min-width: 768px) {
            body {
                padding: 20px;
            }
            
            .menu-btn {
                padding: 15px 25px;
                font-size: 16px;
            }
            
            .header h1 {
                font-size: 28px;
            }
            
            .header h2 {
                font-size: 16px;
            }
            
            .page {
                padding: 30px;
            }
            
            .form-grid {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 20px;
            }
            
            .btn {
                width: auto;
            }
            
            .worker-container {
                max-width: 800px;
            }
            
            .worker-content {
                padding: 40px;
            }
            
            .ln-list {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
                gap: 25px;
            }
            
            .notification {
                right: 20px;
                left: auto;
                max-width: 400px;
            }
        }
        
        @media (max-width: 375px) {
            .worker-header {
                padding: 20px;
            }
            
            .worker-header h1 {
                font-size: 20px;
            }
            
            .btn {
                padding: 12px 15px;
                font-size: 15px;
            }
            
            input, select, textarea {
                font-size: 16px;
                padding: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="notification" id="notification"></div>
    
    <div class="modal" id="statusModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle">–ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –ù–°</div>
                <button class="modal-close" onclick="closeModal()">√ó</button>
            </div>
            <div id="modalContent"></div>
        </div>
    </div>
    
    <div id="workerMode" style="display: none;">
        <div class="worker-container">
            <div class="worker-header">
                <h1>üìù –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è (ISO 13485)</h1>
                <p>–§–ê–†–ú–°–¢–ò–õ - –°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–∞—á–µ—Å—Ç–≤–æ–º</p>
            </div>
            <div class="worker-content">
                <div id="workerForm"></div>
            </div>
        </div>
    </div>
    
    <div id="adminMode">
        <div class="container">
            <div class="header">
                <h1>–§–ê–†–ú–°–¢–ò–õ - –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–∞—è –ø–∞–Ω–µ–ª—å</h1>
                <h2>–°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è–º–∏ –ø–æ ISO 13485</h2>
            </div>
            
            <div class="menu">
                <button class="menu-btn active" onclick="showPage('generateQR')">üéØ –°–æ–∑–¥–∞—Ç—å QR</button>
                <button class="menu-btn" onclick="showPage('listNS')">üìã –í—Å–µ –ù–°</button>
                <button class="menu-btn" onclick="showPage('workflow')">üîÑ Workflow</button>
                <button class="menu-btn" onclick="showPage('directories')">üìö –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏</button>
                <button class="menu-btn" onclick="showPage('admin')">‚öôÔ∏è –ê–¥–º–∏–Ω</button>
            </div>
            
            <div class="page active" id="generateQRPage">
                <h2>üéØ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è QR-–∫–æ–¥–∞ –¥–ª—è —Ü–µ—Ö–∞</h2>
                <div class="info-box">
                    <p><strong>üí° –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:</strong></p>
                    <ol style="margin: 10px 0 0 15px; font-size: 14px;">
                        <li>–°–æ–∑–¥–∞–µ—Ç–µ QR-–∫–æ–¥ –¥–ª—è –º–µ—Å—Ç–∞ –≤ —Ü–µ—Ö—É</li>
                        <li>–ü–µ—á–∞—Ç–∞–µ—Ç–µ –∏ —Ä–∞–∑–º–µ—â–∞–µ—Ç–µ –Ω–∞ –≤–∏–¥–Ω–æ–º –º–µ—Å—Ç–µ</li>
                        <li>–†–∞–±–æ—á–∏–µ —Å–∫–∞–Ω–∏—Ä—É—é—Ç QR –∏ –∑–∞–ø–æ–ª–Ω—è—é—Ç —Ñ–æ—Ä–º—É</li>
                        <li>–î–∞–Ω–Ω—ã–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ Google Sheets</li>
                    </ol>
                </div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label>üè≠ –ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ:</label>
                        <select id="qrDepartment">
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ</option>
                            <option value="–¶–ú–û">–¶–ú–û (–¶–µ—Ö –º–µ—Ç–∞–ª–ª–æ–æ–±—Ä–∞–±–æ—Ç–∫–∏)</option>
                            <option value="–û–¢–ö">–û–¢–ö (–û—Ç–¥–µ–ª —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–≥–æ –∫–æ–Ω—Ç—Ä–æ–ª—è)</option>
                            <option value="–¶–µ—Ö —Å–±–æ—Ä–∫–∏">–¶–µ—Ö —Å–±–æ—Ä–∫–∏</option>
                            <option value="–°–∫–ª–∞–¥">–°–∫–ª–∞–¥ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤</option>
                            <option value="–¶–µ—Ö –ø–æ–∫—Ä–∞—Å–∫–∏">–¶–µ—Ö –ø–æ–∫—Ä–∞—Å–∫–∏</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>üìç –ú–µ—Å—Ç–æ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è:</label>
                        <input type="text" id="qrLocationInput" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –°—Ç–æ–ª –∑–∞—è–≤–æ–∫, –£—á–∞—Å—Ç–æ–∫ ‚Ññ3">
                    </div>
                    
                    <div class="form-group">
                        <label>üë§ –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π –ø–æ QR:</label>
                        <input type="text" id="qrResponsible" placeholder="–§–ò–û –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ">
                    </div>
                </div>
                
                <button class="btn btn-primary" onclick="generateQRCode()" style="margin-top: 20px;">
                    üéØ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å QR-–∫–æ–¥
                </button>
                
                <div class="qr-preview" id="qrPreview" style="display: none;">
                    <h3>‚úÖ QR-–∫–æ–¥ –≥–æ—Ç–æ–≤!</h3>
                    <div id="qrcode" style="margin: 15px 0;"></div>
                    <div class="info-box">
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            <div><strong>–ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ:</strong> <span id="previewDept"></span></div>
                            <div><strong>–ú–µ—Å—Ç–æ:</strong> <span id="previewLocation"></span></div>
                            <div><strong>–ö–æ–¥:</strong> <code id="previewCode"></code></div>
                            <div><strong>–°–æ–∑–¥–∞–Ω:</strong> <span id="previewDate"></span></div>
                        </div>
                    </div>
                    
                    <div class="form-grid" style="margin-top: 20px;">
                        <button class="btn btn-success" onclick="printQRCode()">üñ®Ô∏è –ü–µ—á–∞—Ç—å</button>
                        <button class="btn btn-primary" onclick="saveQRAsImage()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å PNG</button>
                        <button class="btn btn-warning" onclick="testQRCode()">üì± –¢–µ—Å—Ç</button>
                    </div>
                </div>
            </div>
            
            <div class="page" id="listNSPage">
                <h2>üìã –í—Å–µ –ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è</h2>
                <div class="status-badges">
                    <button class="status-badge active" onclick="filterNS('all')" style="background: #6c757d; color: white;">–í—Å–µ</button>
                    <button class="status-badge" onclick="filterNS('checking')" style="background: #ffc107;">–ù–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ</button>
                    <button class="status-badge" onclick="filterNS('analysis')" style="background: #2196F3; color: white;">–ê–Ω–∞–ª–∏–∑</button>
                    <button class="status-badge" onclick="filterNS('correction')" style="background: #9C27B0; color: white;">–ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞</button>
                    <button class="status-badge" onclick="filterNS('execution')" style="background: #FF5722; color: white;">–ò—Å–ø–æ–ª–Ω–µ–Ω–∏–µ</button>
                    <button class="status-badge" onclick="filterNS('verification')" style="background: #4CAF50; color: white;">–í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è</button>
                    <button class="status-badge" onclick="filterNS('closed')" style="background: #607D8B; color: white;">–ó–∞–∫—Ä—ã—Ç—ã–µ</button>
                </div>
                <div id="nsListContainer" style="margin-top: 20px;"></div>
            </div>
            
            <div class="page" id="workflowPage">
                <h2>üîÑ Workflow —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è–º–∏</h2>
                <div class="info-box">
                    <p><strong>–ü—Ä–æ—Ü–µ—Å—Å –ø–æ ISO 13485:</strong></p>
                    <ol style="margin: 10px 0 0 15px; font-size: 14px;">
                        <li><strong>–ò–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞–Ω–∏–µ:</strong> –°–æ—Ç—Ä—É–¥–Ω–∏–∫ –æ–±–Ω–∞—Ä—É–∂–∏–≤–∞–µ—Ç –∏ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç –ù–°</li>
                        <li><strong>–ê–Ω–∞–ª–∏–∑:</strong> –ú–µ–Ω–µ–¥–∂–µ—Ä –°–ú–ö –Ω–∞–∑–Ω–∞—á–∞–µ—Ç –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ</li>
                        <li><strong>–ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞:</strong> –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –∫–æ—Ä–µ–Ω–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã –∏ –ö–î</li>
                        <li><strong>–ò—Å–ø–æ–ª–Ω–µ–Ω–∏–µ:</strong> –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å –≤—ã–ø–æ–ª–Ω—è–µ—Ç –ö–î</li>
                        <li><strong>–í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è:</strong> –ú–µ–Ω–µ–¥–∂–µ—Ä –°–ú–ö –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</li>
                        <li><strong>–ó–∞–∫—Ä—ã—Ç–∏–µ:</strong> –ü–æ–¥–ø–∏—Å–∞–Ω–∏–µ –∏ –∞—Ä—Ö–∏–≤–∞—Ü–∏—è</li>
                    </ol>
                </div>
                
                <div id="workflowList" style="margin-top: 20px;"></div>
            </div>
            
            <div class="page" id="directoriesPage">
                <h2>üìö –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏</h2>
                <div class="info-box" style="border-color: #1e3c72;">
                    <h3>üë• –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–µ –ª–∏—Ü–∞</h3>
                    <div id="responsiblesList" style="margin-bottom: 15px; max-height: 200px; overflow-y: auto; padding: 10px; background: white; border-radius: 8px; border: 1px solid #ddd;"></div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>–§–ò–û:</label>
                            <input type="text" id="responsibleName" placeholder="–ò–≤–∞–Ω–æ–≤ –ò.–ò.">
                        </div>
                        <div class="form-group">
                            <label>–î–æ–ª–∂–Ω–æ—Å—Ç—å:</label>
                            <input type="text" id="responsiblePosition" placeholder="–ù–∞—á–∞–ª—å–Ω–∏–∫ —Ü–µ—Ö–∞">
                        </div>
                        <div class="form-group">
                            <label>Email:</label>
                            <input type="email" id="responsibleEmail" placeholder="email@example.com">
                        </div>
                    </div>
                    <button class="btn btn-success" onclick="addResponsible()" style="margin-top: 10px;">‚ûï –î–æ–±–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ</button>
                </div>
                
                <div class="info-box" style="border-color: #28a745; margin-top: 20px;">
                    <h3 style="color: #28a745;">üè≠ –û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ</h3>
                    <div id="equipmentList" style="margin-bottom: 15px; max-height: 200px; overflow-y: auto; padding: 10px; background: white; border-radius: 8px; border: 1px solid #ddd;"></div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ:</label>
                            <input type="text" id="equipmentName" placeholder="–°—Ç–∞–Ω–æ–∫ –ß–ü–£">
                        </div>
                        <div class="form-group">
                            <label>–ò–Ω–≤. –Ω–æ–º–µ—Ä:</label>
                            <input type="text" id="equipmentCode" placeholder="–°–¢-001">
                        </div>
                    </div>
                    <button class="btn btn-success" onclick="addEquipment()" style="margin-top: 10px;">‚ûï –î–æ–±–∞–≤–∏—Ç—å –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ</button>
                </div>
                
                <div class="info-box" style="border-color: #ffc107; background: #fff3cd; margin-top: 20px;">
                    <h3 style="color: #856404;">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ API</h3>
                    <div style="margin-bottom: 15px;">
                        <label>üìß Email –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –°–ú–ö:</label>
                        <input type="email" id="managerEmail" value="finkart23@mail.ru" style="margin-top: 5px;">
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label>üîó Google Sheets API URL:</label>
                        <input type="text" id="googleSheetsUrl" placeholder="https://script.google.com/macros/s/..." style="margin-top: 5px; font-family: monospace; font-size: 12px;">
                    </div>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn btn-primary" onclick="saveAPISettings()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                        <button class="btn btn-warning" onclick="testGoogleSheets()">üß™ –¢–µ—Å—Ç Google Sheets</button>
                        <button class="btn btn-info" onclick="syncWithGoogleSheets()">üîÑ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å</button>
                    </div>
                </div>
            </div>
            
            <div class="page" id="adminPage">
                <h2>‚öôÔ∏è –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ</h2>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 30px;">
                    <div class="info-box" style="text-align: center;">
                        <div style="font-size: 32px; font-weight: bold; color: #1e3c72;" id="totalNS">0</div>
                        <div style="color: #666; font-size: 14px;">–í—Å–µ–≥–æ –ù–°</div>
                    </div>
                    <div class="info-box" style="text-align: center;">
                        <div style="font-size: 32px; font-weight: bold; color: #ffc107;" id="checkingNS">0</div>
                        <div style="color: #666; font-size: 14px;">–ù–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ</div>
                    </div>
                    <div class="info-box" style="text-align: center;">
                        <div style="font-size: 32px; font-weight: bold; color: #2196F3;" id="analysisNS">0</div>
                        <div style="color: #666; font-size: 14px;">–í –∞–Ω–∞–ª–∏–∑–µ</div>
                    </div>
                    <div class="info-box" style="text-align: center;">
                        <div style="font-size: 32px; font-weight: bold; color: #4CAF50;" id="closedNS">0</div>
                        <div style="color: #666; font-size: 14px;">–ó–∞–∫—Ä—ã—Ç—ã–µ</div>
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="btn btn-primary" onclick="backupData()">üíæ –†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è</button>
                    <button class="btn" style="background: #6c757d; color: white;" onclick="restoreData()">üîÑ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
                    <button class="btn btn-warning" onclick="forceSync()">üîÑ –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è</button>
                    <button class="btn btn-info" onclick="clearLocalData()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</button>
                </div>
                
                <div class="info-box" style="margin-top: 30px;">
                    <h3>–°—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã</h3>
                    <div id="systemStatus"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ==========
        const CONFIG = {
            // Google Sheets API (–∑–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ —Å–≤–æ–π URL –ø–æ—Å–ª–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Apps Script)
            GOOGLE_SHEETS_API: '',
            
            // Email –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
            WEB3FORMS_KEY: '0f9ce86d-9834-4669-b86e-c0cc782cca96',
            WEB3FORMS_URL: 'https://api.web3forms.com/submit',
            
            // –°—Ç–∞—Ç—É—Å—ã –ø–æ ISO 13485
            STATUSES: {
                'checking': { name: '–ù–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ –°–ú–ö', color: '#ffc107', stage: 'initiation' },
                'analysis': { name: '–ê–Ω–∞–ª–∏–∑ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–º', color: '#2196F3', stage: 'analysis' },
                'correction': { name: '–ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É—é—â–∏–µ –¥–µ–π—Å—Ç–≤–∏—è', color: '#9C27B0', stage: 'correction' },
                'execution': { name: '–ò—Å–ø–æ–ª–Ω–µ–Ω–∏–µ', color: '#FF5722', stage: 'execution' },
                'verification': { name: '–í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏', color: '#4CAF50', stage: 'verification' },
                'closed': { name: '–ó–∞–∫—Ä—ã—Ç–æ', color: '#607D8B', stage: 'closed' },
                'rework': { name: '–î–æ—Ä–∞–±–æ—Ç–∫–∞', color: '#dc3545', stage: 'rework' }
            }
        };
        
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let currentQRData = null;
        let photos = [];
        let audioNotes = [];
        let currentNSFilter = 'all';
        let speechRecognition = null;
        let isListening = false;
        let currentEditingNS = null;
        let selectedStatus = 'checking';
        let mediaRecorder = null;
        let audioChunks = [];
        let isRecording = false;
        
        // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
        const isSecure = window.location.protocol === 'https:';
        
        // ========== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ==========
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ –°–∏—Å—Ç–µ–º–∞ –§–ê–†–ú–°–¢–ò–õ ISO 13485 –∑–∞–ø—É—â–µ–Ω–∞');
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
            loadSettings();
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∂–∏–º
            checkMode();
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏
            loadDirectories();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            updateStats();
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –¥–ª—è iOS
            if (isIOS && !isSecure) {
                console.warn('‚ö†Ô∏è –î–ª—è –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ –≤–≤–æ–¥–∞ –Ω–∞ iOS —Ç—Ä–µ–±—É–µ—Ç—Å—è HTTPS');
            }
        });
        
        // ========== GOOGLE SHEETS API ==========
        
        async function saveToGoogleSheets(nsData) {
            try {
                const apiUrl = localStorage.getItem('google_sheets_url') || CONFIG.GOOGLE_SHEETS_API;
                
                if (!apiUrl) {
                    console.warn('‚ùå Google Sheets URL –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω');
                    saveToLocalStorage(nsData);
                    showNotification('Google Sheets URL –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω. –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –ª–æ–∫–∞–ª—å–Ω–æ.', 'warning');
                    return false;
                }
                
                // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
                const dataToSend = {
                    action: 'save',
                    timestamp: new Date().toISOString(),
                    nsNumber: nsData.nsNumber,
                    detectionDate: nsData.detectionDate,
                    department: nsData.department,
                    location: nsData.location,
                    applicant: nsData.applicant,
                    productName: nsData.productName || '',
                    productCode: nsData.productCode || '',
                    description: nsData.description,
                    status: nsData.status || 'checking',
                    responsible: nsData.responsible || '',
                    photos: JSON.stringify(nsData.photos || []),
                    corrections: JSON.stringify(nsData.corrections || []),
                    correctiveActions: JSON.stringify(nsData.correctiveActions || []),
                    executor: nsData.executor || '',
                    verificationDate: nsData.verificationDate || '',
                    closedDate: nsData.closedDate || '',
                    signatures: JSON.stringify(nsData.signatures || []),
                    notes: nsData.notes || ''
                };
                
                console.log('–û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≤ Google Sheets:', dataToSend);
                
                // –î–ª—è –æ—Ç–ª–∞–¥–∫–∏ - —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
                if (!apiUrl.startsWith('http')) {
                    saveToLocalStorage(nsData);
                    showNotification('Google Sheets URL –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω. –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –ª–æ–∫–∞–ª—å–Ω–æ.', 'warning');
                    return false;
                }
                
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(dataToSend)
                    });
                    
                    console.log('‚úÖ –î–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –≤ Google Sheets');
                } catch (fetchError) {
                    console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ Google Sheets:', fetchError);
                }
                
                // –í—Å–µ–≥–¥–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ
                saveToLocalStorage(nsData);
                return true;
                
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Google Sheets:', error);
                saveToLocalStorage(nsData);
                showNotification('–î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –ª–æ–∫–∞–ª—å–Ω–æ (Google Sheets –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω)', 'warning');
                return false;
            }
        }
        
        async function loadFromGoogleSheets() {
            try {
                const apiUrl = localStorage.getItem('google_sheets_url') || CONFIG.GOOGLE_SHEETS_API;
                
                if (!apiUrl || !apiUrl.startsWith('http')) {
                    console.warn('Google Sheets URL –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω, –∑–∞–≥—Ä—É–∂–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ');
                    return loadFromLocalStorage();
                }
                
                const response = await fetch(`${apiUrl}?action=get`);
                if (!response.ok) {
                    throw new Error(`HTTP error ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data && data.success) {
                    localStorage.setItem('farmstil_ns_cloud', JSON.stringify(data.data));
                    console.log('‚úÖ –î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ Google Sheets:', data.data.length, '–∑–∞–ø–∏—Å–µ–π');
                    return data.data;
                } else {
                    return loadFromLocalStorage();
                }
                
            } catch (error) {
                console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ Google Sheets:', error);
                return loadFromLocalStorage();
            }
        }
        
        function saveToLocalStorage(nsData) {
            try {
                const localData = JSON.parse(localStorage.getItem('farmstil_ns_local') || '[]');
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–µ—Ç –ª–∏ —É–∂–µ —Ç–∞–∫–æ–π –∑–∞–ø–∏—Å–∏
                const existingIndex = localData.findIndex(item => item.nsNumber === nsData.nsNumber);
                
                if (existingIndex >= 0) {
                    localData[existingIndex] = nsData;
                } else {
                    localData.push({
                        ...nsData,
                        localId: `local_${Date.now()}`,
                        synced: false
                    });
                }
                
                localStorage.setItem('farmstil_ns_local', JSON.stringify(localData));
                console.log('‚úÖ –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –ª–æ–∫–∞–ª—å–Ω–æ:', nsData.nsNumber);
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ localStorage:', error);
            }
        }
        
        function loadFromLocalStorage() {
            try {
                const localData = JSON.parse(localStorage.getItem('farmstil_ns_local') || '[]');
                const cloudData = JSON.parse(localStorage.getItem('farmstil_ns_cloud') || '[]');
                
                // –û–±—ä–µ–¥–∏–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ
                const allData = [...cloudData];
                const nsNumbers = new Set(cloudData.map(d => d.nsNumber));
                
                localData.forEach(item => {
                    if (!nsNumbers.has(item.nsNumber)) {
                        allData.push(item);
                    }
                });
                
                return allData;
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑ localStorage:', error);
                return [];
            }
        }
        
        // ========== –û–°–ù–û–í–ù–´–ï –§–£–ù–ö–¶–ò–ò ==========
        
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            document.querySelectorAll('.menu-btn').forEach(btn => btn.classList.remove('active'));
            
            const page = document.getElementById(pageId + 'Page');
            if (page) {
                page.classList.add('active');
                const pageIndex = ['generateQR', 'listNS', 'workflow', 'directories', 'admin'].indexOf(pageId);
                document.querySelectorAll('.menu-btn')[pageIndex]?.classList.add('active');
                
                if (pageId === 'listNS') loadNSList(currentNSFilter);
                if (pageId === 'workflow') loadWorkflow();
                if (pageId === 'directories') loadDirectories();
                if (pageId === 'admin') {
                    updateStats();
                    updateSystemStatus();
                }
            }
        }
        
        function showNotification(message, type = 'success', duration = 3000) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = 'notification ' + type;
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, duration);
        }
        
        // ========== –†–ï–ñ–ò–ú –†–ê–ë–û–ß–ï–ì–û ==========
        
        function checkMode() {
            const urlParams = new URLSearchParams(window.location.search);
            const qrCode = urlParams.get('qrcode');
            
            if (qrCode) {
                document.getElementById('adminMode').style.display = 'none';
                document.getElementById('workerMode').style.display = 'block';
                processQRCode(qrCode);
            } else {
                document.getElementById('adminMode').style.display = 'block';
                document.getElementById('workerMode').style.display = 'none';
            }
        }
        
        function processQRCode(qrCode) {
            console.log('üîç –û–±—Ä–∞–±–æ—Ç–∫–∞ QR-–∫–æ–¥–∞:', qrCode);
            
            // –î–µ–∫–æ–¥–∏—Ä—É–µ–º URL –ø–∞—Ä–∞–º–µ—Ç—Ä
            try {
                qrCode = decodeURIComponent(qrCode);
            } catch (e) {
                console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞—Ç—å QR –∫–æ–¥:', e);
            }
            
            const qrcodes = JSON.parse(localStorage.getItem('farmstil_qrcodes') || '[]');
            let qrData = null;
            
            for (const qr of qrcodes) {
                if (qr.code === qrCode) {
                    qrData = qr;
                    break;
                }
            }
            
            if (qrData) {
                console.log('‚úÖ –ù–∞–π–¥–µ–Ω QR –≤ –±–∞–∑–µ:', qrData);
                showWorkerForm(qrData);
            } else {
                console.log('‚ö†Ô∏è QR –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ');
                showWorkerFormManual(qrCode);
            }
        }
        
        function showWorkerForm(qrData) {
            const employeeOptions = getEmployeeOptions();
            const equipmentOptions = getEquipmentOptions();
            
            const formHTML = `
                <form class="worker-form" id="workerFormElement" onsubmit="event.preventDefault(); submitWorkerForm();">
                    <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∏–∑ QR-–∫–æ–¥–∞ -->
                    <div class="department-info">
                        <h4 style="color: #0d47a1; margin-top: 0;">‚úÖ –î–∞–Ω–Ω—ã–µ –∏–∑ QR-–∫–æ–¥–∞:</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <div>
                                <strong>–ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ:</strong><br>
                                <span style="font-size: 16px; font-weight: bold; color: #1e3c72;">
                                    ${qrData.department || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}
                                </span>
                            </div>
                            <div>
                                <strong>–ú–µ—Å—Ç–æ:</strong><br>
                                <span style="font-size: 16px; font-weight: bold; color: #1e3c72;">
                                    ${qrData.location || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}
                                </span>
                            </div>
                        </div>
                    </div>
                    
                    <h3 style="color: #1e3c72; margin-bottom: 15px;">üìù –ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ñ–æ—Ä–º—É –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è</h3>
                    
                    <div class="form-group">
                        <label>üìÖ –î–∞—Ç–∞ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è:</label>
                        <input type="date" id="detectionDate" value="${new Date().toISOString().split('T')[0]}" required>
                    </div>
                    
                    <div class="form-group">
                        <label>üë§ –í–∞—à–µ –§–ò–û:</label>
                        <select id="applicantSelect" onchange="fillApplicantData()" required>
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å–µ–±—è</option>
                            ${employeeOptions}
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>‚úçÔ∏è –§–ò–û –∑–∞—è–≤–∏—Ç–µ–ª—è:</label>
                        <input type="text" id="applicant" placeholder="–í–∞—à–µ –§–ò–û" required>
                    </div>
                    
                    ${isIOS ? `
                    <div class="ios-warning">
                        <strong>üé§ –ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥ –Ω–∞ iOS:</strong>
                        <p>1. –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É "üé§ –ì–æ–ª–æ—Å–æ–º" —Ä—è–¥–æ–º —Å –ø–æ–ª–µ–º –æ–ø–∏—Å–∞–Ω–∏—è</p>
                        <p>2. –ï—Å–ª–∏ –ø–æ—è–≤–∏—Ç—Å—è –∑–∞–ø—Ä–æ—Å - —Ä–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É</p>
                        <p>3. –ì–æ–≤–æ—Ä–∏—Ç–µ —á–µ—Ç–∫–æ –∏ –Ω–µ —Å–ø–µ—à–∞</p>
                    </div>
                    ` : ''}
                    
                    <div class="form-group">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <label>üìã –û–ø–∏—Å–∞–Ω–∏–µ –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è:</label>
                            <button type="button" class="btn btn-warning" onclick="startVoiceInput()" style="padding: 8px 12px; font-size: 14px;">
                                üé§ –ì–æ–ª–æ—Å–æ–º
                            </button>
                        </div>
                        <div class="voice-indicator" id="voiceIndicator">üé§ –ì–æ–≤–æ—Ä–∏—Ç–µ —Å–µ–π—á–∞—Å...</div>
                        <textarea id="description" rows="4" placeholder="–û–ø–∏—à–∏—Ç–µ –ø—Ä–æ–±–ª–µ–º—É –ø–æ–¥—Ä–æ–±–Ω–æ..." required></textarea>
                    </div>
                    
                    <!-- –ê—É–¥–∏–æ–∑–∞–ø–∏—Å—å -->
                    <div class="form-group">
                        <label>üé§ –ê—É–¥–∏–æ–∑–∞–º–µ—Ç–∫–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):</label>
                        ${getAudioControlsHTML()}
                    </div>
                    
                    <!-- –§–û–¢–û -->
                    <div class="form-group">
                        <label>üì∑ –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ (–¥–æ 3 —à—Ç—É–∫):</label>
                        <div class="photo-upload-area" onclick="document.getElementById('photoInput').click()">
                            <div style="font-size: 40px; margin-bottom: 10px;">üì∏</div>
                            <div style="font-weight: bold; color: #28a745;">–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ</div>
                            <input type="file" id="photoInput" accept="image/*" multiple style="display: none;" 
                                   onchange="handlePhotoUpload(event)" capture="environment">
                        </div>
                        <div class="preview-container" id="photoPreview"></div>
                    </div>
                    
                    <!-- –°–ö–†–´–¢–´–ï –ü–û–õ–Ø -->
                    <input type="hidden" id="hiddenDepartment" value="${qrData.department || ''}">
                    <input type="hidden" id="hiddenLocation" value="${qrData.location || ''}">
                    <input type="hidden" id="hiddenResponsible" value="${qrData.responsible || ''}">
                    <input type="hidden" id="hiddenQRCode" value="${qrData.code || ''}">
                    
                    <!-- –ö–ù–û–ü–ö–ò -->
                    <div style="display: flex; gap: 10px; margin-top: 25px;">
                        <button type="submit" class="btn btn-success" style="flex: 2;">
                            üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ
                        </button>
                        <button type="button" class="btn btn-danger" onclick="cancelWorkerForm()" style="flex: 1;">
                            ‚ùå –û—Ç–º–µ–Ω–∞
                        </button>
                    </div>
                </form>
            `;
            
            document.getElementById('workerForm').innerHTML = formHTML;
            currentQRData = qrData;
            console.log('‚úÖ –§–æ—Ä–º–∞ —Ä–∞–±–æ—á–µ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∞');
        }
        
        function showWorkerFormManual(qrCode) {
            const employeeOptions = getEmployeeOptions();
            const equipmentOptions = getEquipmentOptions();
            
            const formHTML = `
                <form class="worker-form" id="workerFormElement" onsubmit="event.preventDefault(); submitWorkerFormManual();">
                    <!-- –†—É—á–Ω–æ–π –≤–≤–æ–¥ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ -->
                    <div class="manual-input-box">
                        <h4 style="color: #856404; margin-top: 0;">‚ö†Ô∏è QR-–∫–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ</h4>
                        <p>–ö–æ–¥: <strong>${qrCode}</strong></p>
                        <p>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –≤—Ä—É—á–Ω—É—é:</p>
                    </div>
                    
                    <h3 style="color: #1e3c72; margin-bottom: 15px;">üìù –ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ñ–æ—Ä–º—É –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è</h3>
                    
                    <div class="form-group">
                        <label>üè≠ –ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ:</label>
                        <select id="manualDepartment" required>
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ</option>
                            <option value="–¶–ú–û">–¶–ú–û (–¶–µ—Ö –º–µ—Ç–∞–ª–ª–æ–æ–±—Ä–∞–±–æ—Ç–∫–∏)</option>
                            <option value="–û–¢–ö">–û–¢–ö (–û—Ç–¥–µ–ª —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–≥–æ –∫–æ–Ω—Ç—Ä–æ–ª—è)</option>
                            <option value="–¶–µ—Ö —Å–±–æ—Ä–∫–∏">–¶–µ—Ö —Å–±–æ—Ä–∫–∏</option>
                            <option value="–°–∫–ª–∞–¥">–°–∫–ª–∞–¥ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤</option>
                            <option value="–¶–µ—Ö –ø–æ–∫—Ä–∞—Å–∫–∏">–¶–µ—Ö –ø–æ–∫—Ä–∞—Å–∫–∏</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>üìç –ú–µ—Å—Ç–æ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è:</label>
                        <input type="text" id="manualLocation" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –£—á–∞—Å—Ç–æ–∫ ‚Ññ3, –°—Ç–∞–Ω–æ–∫ ‚Ññ5" required>
                    </div>
                    
                    <div class="form-group">
                        <label>üìÖ –î–∞—Ç–∞ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è:</label>
                        <input type="date" id="manualDetectionDate" value="${new Date().toISOString().split('T')[0]}" required>
                    </div>
                    
                    <div class="form-group">
                        <label>üë§ –í–∞—à–µ –§–ò–û:</label>
                        <select id="manualApplicantSelect" onchange="fillManualApplicantData()" required>
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å–µ–±—è</option>
                            ${employeeOptions}
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>‚úçÔ∏è –§–ò–û –∑–∞—è–≤–∏—Ç–µ–ª—è:</label>
                        <input type="text" id="manualApplicant" placeholder="–í–∞—à–µ –§–ò–û" required>
                    </div>
                    
                    <!-- –û—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ–ª—è –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ showWorkerForm -->
                    <div class="form-group">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <label>üìã –û–ø–∏—Å–∞–Ω–∏–µ –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è:</label>
                            <button type="button" class="btn btn-warning" onclick="startVoiceInputManual()" style="padding: 8px 12px; font-size: 14px;">
                                üé§ –ì–æ–ª–æ—Å–æ–º
                            </button>
                        </div>
                        <div class="voice-indicator" id="voiceIndicatorManual">üé§ –ì–æ–≤–æ—Ä–∏—Ç–µ —Å–µ–π—á–∞—Å...</div>
                        <textarea id="manualDescription" rows="4" placeholder="–û–ø–∏—à–∏—Ç–µ –ø—Ä–æ–±–ª–µ–º—É –ø–æ–¥—Ä–æ–±–Ω–æ..." required></textarea>
                    </div>
                    
                    <!-- –§–û–¢–û -->
                    <div class="form-group">
                        <label>üì∑ –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ (–¥–æ 3 —à—Ç—É–∫):</label>
                        <div class="photo-upload-area" onclick="document.getElementById('manualPhotoInput').click()">
                            <div style="font-size: 40px; margin-bottom: 10px;">üì∏</div>
                            <div style="font-weight: bold; color: #28a745;">–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ</div>
                            <input type="file" id="manualPhotoInput" accept="image/*" multiple style="display: none;" 
                                   onchange="handleManualPhotoUpload(event)" capture="environment">
                        </div>
                        <div class="preview-container" id="manualPhotoPreview"></div>
                    </div>
                    
                    <!-- –°–ö–†–´–¢–´–ï –ü–û–õ–Ø -->
                    <input type="hidden" id="manualQRCode" value="${qrCode}">
                    
                    <!-- –ö–ù–û–ü–ö–ò -->
                    <div style="display: flex; gap: 10px; margin-top: 25px;">
                        <button type="submit" class="btn btn-success" style="flex: 2;">
                            üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ
                        </button>
                        <button type="button" class="btn btn-danger" onclick="cancelWorkerForm()" style="flex: 1;">
                            ‚ùå –û—Ç–º–µ–Ω–∞
                        </button>
                    </div>
                </form>
            `;
            
            document.getElementById('workerForm').innerHTML = formHTML;
            currentQRData = { code: qrCode };
            console.log('‚úÖ –§–æ—Ä–º–∞ —Ä—É—á–Ω–æ–≥–æ –≤–≤–æ–¥–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∞');
        }
        
        function fillManualApplicantData() {
            const select = document.getElementById('manualApplicantSelect');
            if (select && select.value) {
                const [name] = select.value.split('|');
                const applicantField = document.getElementById('manualApplicant');
                if (applicantField) {
                    applicantField.value = name;
                }
            }
        }
        
        async function submitWorkerFormManual() {
            try {
                console.log('üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º—ã (—Ä—É—á–Ω–æ–π –≤–≤–æ–¥)...');
                
                const department = document.getElementById('manualDepartment').value;
                const location = document.getElementById('manualLocation').value;
                const detectionDate = document.getElementById('manualDetectionDate').value;
                const applicant = document.getElementById('manualApplicant').value;
                const description = document.getElementById('manualDescription').value;
                
                if (!department || !location || !applicant || !description) {
                    showNotification('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è', 'error');
                    return;
                }
                
                const nsNumber = generateNSNumber();
                
                const nsData = {
                    nsNumber: nsNumber,
                    detectionDate: detectionDate,
                    department: department,
                    location: location,
                    applicant: applicant,
                    description: description,
                    photos: photos,
                    status: 'checking',
                    stage: 'initiation',
                    created: new Date().toISOString(),
                    createdBy: applicant,
                    qrCode: currentQRData?.code || 'manual',
                    
                    corrections: [],
                    correctiveActions: [],
                    signatures: [],
                    notes: ''
                };
                
                const saved = await saveToGoogleSheets(nsData);
                await sendEmailNotification(nsData);
                
                showSuccessScreen(nsData);
                resetForm();
                
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ (—Ä—É—á–Ω–æ–π –≤–≤–æ–¥):', error);
                showNotification('–û—à–∏–±–∫–∞: ' + error.message, 'error');
            }
        }
        
        function getAudioControlsHTML() {
            return `
                <div class="audio-controls">
                    <button type="button" id="startAudioBtn" class="btn btn-warning" onclick="startAudioRecording()" style="padding: 10px 15px;">
                        üé§ –ù–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—å
                    </button>
                    <button type="button" id="stopAudioBtn" class="btn btn-danger" onclick="stopAudioRecording()" style="padding: 10px 15px;" disabled>
                        ‚èπÔ∏è –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
                    </button>
                </div>
                <div class="audio-visualizer">
                    <div class="audio-wave" id="audioWave"></div>
                </div>
                <div id="audioPreview" class="audio-preview"></div>
            `;
        }
        
        // ========== –ê–£–î–ò–û–ó–ê–ü–ò–°–¨ ==========
        
        async function startAudioRecording() {
            try {
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    throw new Error('–ë—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∑–∞–ø–∏—Å—å –∞—É–¥–∏–æ');
                }
                
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        sampleRate: 44100
                    }
                });
                
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                
                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        audioChunks.push(event.data);
                    }
                };
                
                mediaRecorder.onstop = () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    const audioUrl = URL.createObjectURL(audioBlob);
                    
                    window.currentAudio = {
                        blob: audioBlob,
                        url: audioUrl,
                        timestamp: new Date().toISOString()
                    };
                    
                    const preview = document.getElementById('audioPreview');
                    preview.innerHTML = `
                        <p><strong>–ê—É–¥–∏–æ–∑–∞–ø–∏—Å—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞</strong></p>
                        <audio controls src="${audioUrl}" style="width: 100%;"></audio>
                        <button class="btn btn-sm btn-danger" onclick="removeAudioRecording()" style="margin-top: 10px;">
                            ‚ùå –£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å
                        </button>
                    `;
                    
                    document.getElementById('stopAudioBtn').disabled = true;
                    document.getElementById('startAudioBtn').disabled = false;
                    stopAudioVisualizer();
                    
                    showNotification('–ê—É–¥–∏–æ–∑–∞–ø–∏—Å—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞', 'success');
                };
                
                mediaRecorder.start();
                isRecording = true;
                
                document.getElementById('startAudioBtn').disabled = true;
                document.getElementById('stopAudioBtn').disabled = false;
                
                startAudioVisualizer();
                showNotification('–ó–∞–ø–∏—Å—å –Ω–∞—á–∞—Ç–∞...', 'info');
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏ –∞—É–¥–∏–æ:', error);
                showNotification('–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—å. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≥–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥ —Ç–µ–∫—Å—Ç–∞.', 'warning');
            }
        }
        
        function stopAudioRecording() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                isRecording = false;
                
                mediaRecorder.stream.getTracks().forEach(track => track.stop());
            }
        }
        
        function removeAudioRecording() {
            window.currentAudio = null;
            document.getElementById('audioPreview').innerHTML = '';
        }
        
        function startAudioVisualizer() {
            const visualizer = document.getElementById('audioWave');
            if (!visualizer) return;
            
            let scale = 0;
            const interval = setInterval(() => {
                scale = 0.3 + Math.random() * 0.7;
                visualizer.style.transform = `scaleX(${scale})`;
            }, 100);
            
            window.visualizerInterval = interval;
        }
        
        function stopAudioVisualizer() {
            if (window.visualizerInterval) {
                clearInterval(window.visualizerInterval);
                const visualizer = document.getElementById('audioWave');
                if (visualizer) {
                    visualizer.style.transform = 'scaleX(0)';
                }
            }
        }
        
        // ========== –û–¢–ü–†–ê–í–ö–ê –§–û–†–ú–´ ==========
        
        async function submitWorkerForm() {
            try {
                console.log('üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º—ã...');
                
                let department, location, responsible;
                
                if (currentQRData) {
                    department = document.getElementById('hiddenDepartment').value;
                    location = document.getElementById('hiddenLocation').value;
                    responsible = document.getElementById('hiddenResponsible').value;
                } else {
                    department = document.getElementById('manualDepartment')?.value || '';
                    location = document.getElementById('manualLocation')?.value || '';
                    responsible = '';
                }
                
                const detectionDate = document.getElementById('detectionDate').value;
                const applicant = document.getElementById('applicant').value;
                const description = document.getElementById('description').value;
                
                if (!department || !location) {
                    showNotification('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –∏ –º–µ—Å—Ç–æ', 'error');
                    return;
                }
                
                if (!applicant || !description) {
                    showNotification('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –§–ò–û –∏ –æ–ø–∏—Å–∞–Ω–∏–µ', 'error');
                    return;
                }
                
                const nsNumber = generateNSNumber();
                
                let audioData = null;
                if (window.currentAudio) {
                    audioData = await convertAudioToBase64(window.currentAudio.blob);
                }
                
                const nsData = {
                    nsNumber: nsNumber,
                    detectionDate: detectionDate,
                    department: department,
                    location: location,
                    applicant: applicant,
                    productName: document.getElementById('productName')?.value || '',
                    productCode: document.getElementById('productCode')?.value || '',
                    description: description,
                    photos: photos,
                    audioNote: audioData,
                    status: 'checking',
                    stage: 'initiation',
                    created: new Date().toISOString(),
                    createdBy: applicant,
                    qrCode: currentQRData?.code || 'manual',
                    qrResponsible: responsible,
                    
                    corrections: [],
                    correctiveActions: [],
                    signatures: [],
                    notes: ''
                };
                
                const saved = await saveToGoogleSheets(nsData);
                await sendEmailNotification(nsData);
                
                showSuccessScreen(nsData);
                resetForm();
                
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏:', error);
                showNotification('–û—à–∏–±–∫–∞: ' + error.message, 'error');
            }
        }
        
        function generateNSNumber() {
            const year = new Date().getFullYear().toString().slice(-2);
            const month = (new Date().getMonth() + 1).toString().padStart(2, '0');
            const random = Math.floor(Math.random() * 999).toString().padStart(3, '0');
            return `NS-${year}${month}-${random}`;
        }
        
        async function convertAudioToBase64(blob) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onloadend = () => {
                    resolve(reader.result);
                };
                reader.onerror = reject;
                reader.readAsDataURL(blob);
            });
        }
        
        async function sendEmailNotification(nsData) {
            try {
                const managerEmail = localStorage.getItem('manager_email') || 'finkart23@mail.ru';
                
                const emailBody = `
                    <h2>üìã –ù–æ–≤–æ–µ –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–æ</h2>
                    <h3>${nsData.nsNumber}</h3>
                    
                    <table style="width: 100%; border-collapse: collapse; margin: 20px 0; border: 1px solid #ddd;">
                        <tr><td style="padding: 10px; background: #f9f9f9;"><strong>–ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ:</strong></td><td style="padding: 10px;">${nsData.department}</td></tr>
                        <tr><td style="padding: 10px; background: #f9f9f9;"><strong>–ú–µ—Å—Ç–æ:</strong></td><td style="padding: 10px;">${nsData.location}</td></tr>
                        <tr><td style="padding: 10px; background: #f9f9f9;"><strong>–ó–∞—è–≤–∏—Ç–µ–ª—å:</strong></td><td style="padding: 10px;">${nsData.applicant}</td></tr>
                        <tr><td style="padding: 10px; background: #f9f9f9;"><strong>–î–∞—Ç–∞:</strong></td><td style="padding: 10px;">${nsData.detectionDate}</td></tr>
                    </table>
                    
                    <h4>–û–ø–∏—Å–∞–Ω–∏–µ:</h4>
                    <div style="background: #f5f5f5; padding: 15px; border-radius: 5px; margin: 10px 0;">
                        ${nsData.description.replace(/\n/g, '<br>')}
                    </div>
                    
                    <p><strong>üì∑ –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏:</strong> ${nsData.photos.length} —à—Ç.</p>
                    ${nsData.audioNote ? '<p><strong>üé§ –ê—É–¥–∏–æ–∑–∞–º–µ—Ç–∫–∞:</strong> –ï—Å—Ç—å</p>' : ''}
                    
                    <div style="margin: 20px 0; padding: 15px; background: #e3f2fd; border-radius: 8px;">
                        <strong>–î–µ–π—Å—Ç–≤–∏—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –°–ú–ö:</strong>
                        <ol>
                            <li>–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–ª–Ω–æ—Ç—É –¥–∞–Ω–Ω—ã—Ö –≤ —Å–∏—Å—Ç–µ–º–µ</li>
                            <li>–ù–∞–∑–Ω–∞—á—å—Ç–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∑–∞ –∞–Ω–∞–ª–∏–∑</li>
                            <li>–ò–∑–º–µ–Ω–∏—Ç–µ —Å—Ç–∞—Ç—É—Å –Ω–∞ "–í —Ä–∞–±–æ—Ç–µ"</li>
                        </ol>
                    </div>
                    
                    <p><a href="${window.location.origin}" style="
                        display: inline-block; padding: 12px 24px; background: #1e3c72; 
                        color: white; text-decoration: none; border-radius: 5px; font-weight: bold;
                    ">–ü–µ—Ä–µ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É</a></p>
                `;
                
                const response = await fetch(CONFIG.WEB3FORMS_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        access_key: CONFIG.WEB3FORMS_KEY,
                        subject: `–§–ê–†–ú–°–¢–ò–õ: –ù–æ–≤–æ–µ –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ ${nsData.nsNumber}`,
                        from_name: '–°–∏—Å—Ç–µ–º–∞ –§–ê–†–ú–°–¢–ò–õ',
                        to: managerEmail,
                        html: emailBody,
                        reply_to: managerEmail
                    })
                });
                
                console.log('‚úÖ Email –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω');
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ email:', error);
            }
        }
        
        function showSuccessScreen(nsData) {
            const formHTML = `
                <div style="text-align: center; padding: 30px;">
                    <div style="font-size: 60px; color: #28a745; margin-bottom: 20px;">‚úÖ</div>
                    <h2 style="color: #1e3c72; margin-bottom: 20px;">–ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–æ!</h2>
                    
                    <div class="info-box" style="max-width: 500px; margin: 0 auto 30px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; text-align: left;">
                            <div><strong>–ù–æ–º–µ—Ä –ù–°:</strong><br><span style="font-size: 18px; font-weight: bold;">${nsData.nsNumber}</span></div>
                            <div><strong>–°—Ç–∞—Ç—É—Å:</strong><br><span class="ln-status status-checking">–ù–ê –ü–†–û–í–ï–†–ö–ï –°–ú–ö</span></div>
                            <div><strong>–î–∞—Ç–∞:</strong><br>${new Date(nsData.detectionDate).toLocaleDateString('ru-RU')}</div>
                            <div><strong>–ó–∞—è–≤–∏—Ç–µ–ª—å:</strong><br>${nsData.applicant}</div>
                            <div style="grid-column: 1 / -1;"><strong>–ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ:</strong><br>${nsData.department}</div>
                            <div style="grid-column: 1 / -1;"><strong>–ú–µ—Å—Ç–æ:</strong><br>${nsData.location}</div>
                        </div>
                    </div>
                    
                    <div style="margin: 20px 0; padding: 15px; background: #e3f2fd; border-radius: 10px;">
                        <p><strong>–ß—Ç–æ –¥–∞–ª—å—à–µ?</strong></p>
                        <p>1. –ú–µ–Ω–µ–¥–∂–µ—Ä –°–ú–ö –ø–æ–ª—É—á–∏—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –Ω–∞ email</p>
                        <p>2. –û–Ω –ø—Ä–æ–≤–µ—Ä–∏—Ç –¥–∞–Ω–Ω—ã–µ –∏ –Ω–∞–∑–Ω–∞—á–∏—Ç –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ</p>
                        <p>3. –í—ã –ø–æ–ª—É—á–∏—Ç–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –¥–∞–ª—å–Ω–µ–π—à–∏—Ö –¥–µ–π—Å—Ç–≤–∏—è—Ö</p>
                    </div>
                    
                    <div style="display: flex; gap: 10px; justify-content: center;">
                        <button class="btn btn-primary" onclick="cancelWorkerForm()" style="padding: 14px 28px;">
                            üìù –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –∑–∞—è–≤–∫—É
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('workerForm').innerHTML = formHTML;
            showNotification('–ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —É—Å–ø–µ—à–Ω–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–æ!', 'success');
        }
        
        function resetForm() {
            photos = [];
            window.currentAudio = null;
            const photoInput = document.getElementById('photoInput');
            if (photoInput) photoInput.value = '';
            const manualPhotoInput = document.getElementById('manualPhotoInput');
            if (manualPhotoInput) manualPhotoInput.value = '';
        }
        
        // ========== –ì–û–õ–û–°–û–í–û–ô –í–í–û–î ==========
        
        function initSpeechRecognition() {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                return null;
            }
            
            if (isIOS && !isSecure) {
                return null;
            }
            
            try {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                const recognition = new SpeechRecognition();
                
                recognition.lang = 'ru-RU';
                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.maxAlternatives = 1;
                
                return recognition;
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è:', error);
                return null;
            }
        }
        
        function startVoiceInput() {
            if (isListening && speechRecognition) {
                speechRecognition.stop();
                isListening = false;
                document.getElementById('voiceIndicator').classList.remove('active');
                showNotification('–ó–∞–ø–∏—Å—å –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞', 'info');
                return;
            }
            
            speechRecognition = initSpeechRecognition();
            if (!speechRecognition) {
                showNotification('–ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –∏–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è HTTPS', 'error');
                return;
            }
            
            speechRecognition.onstart = function() {
                isListening = true;
                console.log('üé§ –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –Ω–∞—á–∞–ª–æ—Å—å');
                document.getElementById('voiceIndicator').classList.add('active');
            };
            
            speechRecognition.onresult = function(event) {
                const transcript = event.results[0][0].transcript;
                console.log('‚úÖ –†–∞—Å–ø–æ–∑–Ω–∞–Ω–æ:', transcript);
                
                const descriptionField = document.getElementById('description');
                if (descriptionField) {
                    const currentText = descriptionField.value;
                    descriptionField.value = currentText + (currentText ? ' ' : '') + transcript;
                    showNotification('–¢–µ–∫—Å—Ç –¥–æ–±–∞–≤–ª–µ–Ω', 'success');
                }
            };
            
            speechRecognition.onerror = function(event) {
                console.error('‚ùå –û—à–∏–±–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è:', event.error);
                isListening = false;
                document.getElementById('voiceIndicator').classList.remove('active');
                
                if (event.error === 'not-allowed') {
                    showNotification('–†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞', 'error');
                }
            };
            
            speechRecognition.onend = function() {
                console.log('üé§ –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ');
                isListening = false;
                document.getElementById('voiceIndicator').classList.remove('active');
            };
            
            try {
                speechRecognition.start();
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è:', error);
                showNotification('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É', 'error');
            }
        }
        
        function startVoiceInputManual() {
            // –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ startVoiceInput –Ω–æ –¥–ª—è —Ä—É—á–Ω–æ–π —Ñ–æ—Ä–º—ã
            if (isListening && speechRecognition) {
                speechRecognition.stop();
                isListening = false;
                document.getElementById('voiceIndicatorManual').classList.remove('active');
                showNotification('–ó–∞–ø–∏—Å—å –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞', 'info');
                return;
            }
            
            speechRecognition = initSpeechRecognition();
            if (!speechRecognition) {
                showNotification('–ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –∏–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è HTTPS', 'error');
                return;
            }
            
            speechRecognition.onstart = function() {
                isListening = true;
                document.getElementById('voiceIndicatorManual').classList.add('active');
            };
            
            speechRecognition.onresult = function(event) {
                const transcript = event.results[0][0].transcript;
                const descriptionField = document.getElementById('manualDescription');
                if (descriptionField) {
                    const currentText = descriptionField.value;
                    descriptionField.value = currentText + (currentText ? ' ' : '') + transcript;
                    showNotification('–¢–µ–∫—Å—Ç –¥–æ–±–∞–≤–ª–µ–Ω', 'success');
                }
            };
            
            speechRecognition.onerror = function(event) {
                isListening = false;
                document.getElementById('voiceIndicatorManual').classList.remove('active');
                showNotification('–û—à–∏–±–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è: ' + event.error, 'error');
            };
            
            speechRecognition.onend = function() {
                isListening = false;
                document.getElementById('voiceIndicatorManual').classList.remove('active');
            };
            
            try {
                speechRecognition.start();
            } catch (error) {
                showNotification('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É', 'error');
            }
        }
        
        // ========== –§–û–¢–û–ì–†–ê–§–ò–ò ==========
        
        function handlePhotoUpload(event) {
            const files = event.target.files;
            const preview = document.getElementById('photoPreview');
            
            if (!preview) return;
            
            const remainingSlots = 3 - photos.length;
            const fileCount = Math.min(files.length, remainingSlots);
            
            if (fileCount <= 0) {
                showNotification('–ú–∞–∫—Å–∏–º—É–º 3 —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏', 'warning');
                return;
            }
            
            for (let i = 0; i < fileCount; i++) {
                const file = files[i];
                
                if (file.size > 2 * 1024 * 1024) {
                    showNotification(`–§–æ—Ç–æ "${file.name}" —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–µ (–º–∞–∫—Å. 2MB)`, 'warning');
                    continue;
                }
                
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    const img = new Image();
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        
                        const maxWidth = 1024;
                        const maxHeight = 768;
                        
                        let width = img.width;
                        let height = img.height;
                        
                        if (width > height) {
                            if (width > maxWidth) {
                                height *= maxWidth / width;
                                width = maxWidth;
                            }
                        } else {
                            if (height > maxHeight) {
                                width *= maxHeight / height;
                                height = maxHeight;
                            }
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        const compressedData = canvas.toDataURL('image/jpeg', 0.7);
                        
                        const photoDiv = document.createElement('div');
                        photoDiv.className = 'photo-preview';
                        photoDiv.innerHTML = `
                            <img src="${compressedData}" alt="–§–æ—Ç–æ ${photos.length + 1}">
                            <button onclick="removePhoto(${photos.length})" style="
                                position: absolute; top: 5px; right: 5px; 
                                background: rgba(220, 53, 69, 0.9); color: white; 
                                border: none; border-radius: 50%; width: 24px; 
                                height: 24px; font-size: 14px; cursor: pointer;
                            ">√ó</button>
                        `;
                        preview.appendChild(photoDiv);
                        
                        photos.push({
                            name: file.name,
                            data: compressedData,
                            type: 'image/jpeg',
                            size: file.size
                        });
                    };
                    
                    img.src = e.target.result;
                };
                
                reader.readAsDataURL(file);
            }
            
            showNotification(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${fileCount} —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π`, 'success');
        }
        
        function handleManualPhotoUpload(event) {
            handlePhotoUpload(event);
        }
        
        function removePhoto(index) {
            photos.splice(index, 1);
            const preview = document.getElementById('photoPreview');
            const manualPreview = document.getElementById('manualPhotoPreview');
            
            if (preview) {
                preview.innerHTML = '';
                
                photos.forEach((photo, i) => {
                    const photoDiv = document.createElement('div');
                    photoDiv.className = 'photo-preview';
                    photoDiv.innerHTML = `
                        <img src="${photo.data}" alt="–§–æ—Ç–æ ${i + 1}">
                        <button onclick="removePhoto(${i})" style="
                            position: absolute; top: 5px; right: 5px; 
                            background: rgba(220, 53, 69, 0.9); color: white; 
                            border: none; border-radius: 50%; width: 24px; 
                            height: 24px; font-size: 14px; cursor: pointer;
                        ">√ó</button>
                    `;
                    preview.appendChild(photoDiv);
                });
            }
            
            if (manualPreview) {
                manualPreview.innerHTML = '';
                photos.forEach((photo, i) => {
                    const photoDiv = document.createElement('div');
                    photoDiv.className = 'photo-preview';
                    photoDiv.innerHTML = `
                        <img src="${photo.data}" alt="–§–æ—Ç–æ ${i + 1}">
                        <button onclick="removePhoto(${i})" style="
                            position: absolute; top: 5px; right: 5px; 
                            background: rgba(220, 53, 69, 0.9); color: white; 
                            border: none; border-radius: 50%; width: 24px; 
                            height: 24px; font-size: 14px; cursor: pointer;
                        ">√ó</button>
                    `;
                    manualPreview.appendChild(photoDiv);
                });
            }
            
            showNotification('–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è —É–¥–∞–ª–µ–Ω–∞', 'info');
        }
        
        // ========== –†–ê–ë–û–¢–ê –° –ù–° ==========
        
        async function loadNSList(filterStatus = 'all') {
            currentNSFilter = filterStatus;
            const container = document.getElementById('nsListContainer');
            if (!container) return;
            
            try {
                const nsList = await loadFromGoogleSheets();
                
                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
                document.querySelectorAll('.status-badge').forEach(badge => {
                    badge.classList.remove('active');
                });
                
                const activeFilterBtn = document.querySelector(`.status-badge[onclick*="filterNS('${filterStatus}')"]`);
                if (activeFilterBtn) {
                    activeFilterBtn.classList.add('active');
                }
                
                let filteredNS = nsList;
                if (filterStatus !== 'all') {
                    filteredNS = nsList.filter(ns => ns.status === filterStatus);
                }
                
                filteredNS.sort((a, b) => new Date(b.created || b.timestamp) - new Date(a.created || a.timestamp));
                
                if (filteredNS.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #666;">
                            <h3 style="color: #1e3c72;">–ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–π –Ω–µ—Ç</h3>
                            <p>–°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤–æ–µ –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —á–µ—Ä–µ–∑ QR-–∫–æ–¥</p>
                        </div>
                    `;
                    return;
                }
                
                let html = '<div class="ln-list">';
                
                filteredNS.forEach((ns, index) => {
                    if (!ns || !ns.nsNumber) return;
                    
                    const date = new Date(ns.detectionDate || ns.timestamp).toLocaleDateString('ru-RU');
                    const status = ns.status || 'checking';
                    const statusConfig = CONFIG.STATUSES[status] || CONFIG.STATUSES.checking;
                    
                    html += `
                        <div class="ln-card">
                            <div class="ln-card-header">
                                <div class="ln-number">${ns.nsNumber}</div>
                                <div class="ln-status" style="background: ${statusConfig.color}">${statusConfig.name}</div>
                            </div>
                            
                            <div style="font-size: 14px;">
                                <div><strong>üìÖ –î–∞—Ç–∞:</strong> ${date}</div>
                                <div><strong>üè≠ –ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ:</strong> ${ns.department || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</div>
                                <div><strong>üìç –ú–µ—Å—Ç–æ:</strong> ${ns.location || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</div>
                                <div><strong>üë§ –ó–∞—è–≤–∏—Ç–µ–ª—å:</strong> ${ns.applicant || '–ù–µ —É–∫–∞–∑–∞–Ω'}</div>
                                <div><strong>üìã –û–ø–∏—Å–∞–Ω–∏–µ:</strong></div>
                                <div style="margin-top: 5px; padding: 8px; background: #f8f9fa; border-radius: 5px; font-size: 13px; max-height: 60px; overflow: hidden;">
                                    ${ns.description ? (ns.description.length > 100 ? ns.description.substring(0, 100) + '...' : ns.description) : '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è'}
                                </div>
                                
                                <div style="display: flex; gap: 10px; margin-top: 15px;">
                                    <button class="btn btn-info" onclick="viewNSDetails('${ns.nsNumber}')" style="flex: 1; padding: 8px; font-size: 13px;">
                                        üëÅÔ∏è –ü—Ä–æ—Å–º–æ—Ç—Ä
                                    </button>
                                    <button class="btn btn-warning" onclick="editNS('${ns.nsNumber}')" style="flex: 1; padding: 8px; font-size: 13px;">
                                        üìù –ò–∑–º–µ–Ω–∏—Ç—å
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
                container.innerHTML = html;
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ –ù–°:', error);
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <h3 style="color: #dc3545;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }
        
        async function viewNSDetails(nsNumber) {
            try {
                const nsList = await loadFromGoogleSheets();
                const ns = nsList.find(item => item.nsNumber === nsNumber);
                
                if (!ns) {
                    showNotification('–ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ', 'error');
                    return;
                }
                
                const date = new Date(ns.detectionDate || ns.timestamp).toLocaleDateString('ru-RU');
                const statusConfig = CONFIG.STATUSES[ns.status] || CONFIG.STATUSES.checking;
                
                let photosHTML = '';
                if (ns.photos && ns.photos.length > 0) {
                    let photosArray = [];
                    try {
                        photosArray = JSON.parse(ns.photos);
                    } catch (e) {
                        photosArray = ns.photos;
                    }
                    
                    if (photosArray.length > 0) {
                        photosHTML = `
                            <div style="margin-top: 15px;">
                                <h4>üì∑ –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ (${photosArray.length}):</h4>
                                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; margin-top: 10px;">
                        `;
                        
                        photosArray.forEach((photo, i) => {
                            const photoData = photo.data || photo;
                            photosHTML += `
                                <div class="photo-preview">
                                    <img src="${photoData}" alt="–§–æ—Ç–æ ${i + 1}" onclick="showFullPhoto('${photoData.replace(/'/g, "\\'")}')" style="cursor: pointer;">
                                </div>
                            `;
                        });
                        
                        photosHTML += '</div></div>';
                    }
                }
                
                const modalContent = `
                    <h3 style="color: #1e3c72; margin-bottom: 20px;">${ns.nsNumber}</h3>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                        <div><strong>–î–∞—Ç–∞ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è:</strong><br>${date}</div>
                        <div><strong>–°—Ç–∞—Ç—É—Å:</strong><br><span class="ln-status" style="background: ${statusConfig.color}">${statusConfig.name}</span></div>
                        <div><strong>–ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ:</strong><br>${ns.department || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</div>
                        <div><strong>–ú–µ—Å—Ç–æ:</strong><br>${ns.location || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</div>
                        <div><strong>–ó–∞—è–≤–∏—Ç–µ–ª—å:</strong><br>${ns.applicant || '–ù–µ —É–∫–∞–∑–∞–Ω'}</div>
                        <div><strong>–°–æ–∑–¥–∞–Ω–æ:</strong><br>${new Date(ns.created || ns.timestamp).toLocaleDateString('ru-RU')}</div>
                    </div>
                    
                    ${ns.productName ? `<div style="margin-bottom: 15px;"><strong>–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ:</strong> ${ns.productName} ${ns.productCode ? '(' + ns.productCode + ')' : ''}</div>` : ''}
                    
                    <div style="margin-top: 15px;">
                        <h4>üìã –û–ø–∏—Å–∞–Ω–∏–µ:</h4>
                        <div style="padding: 15px; background: #f8f9fa; border-radius: 8px; margin-top: 10px; white-space: pre-line;">
                            ${ns.description || '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è'}
                        </div>
                    </div>
                    
                    ${photosHTML}
                    
                    ${ns.corrections && ns.corrections !== '[]' ? `
                        <div style="margin-top: 15px;">
                            <h4>üõ†Ô∏è –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É—é—â–∏–µ –¥–µ–π—Å—Ç–≤–∏—è:</h4>
                            <div style="padding: 15px; background: #fff3cd; border-radius: 8px; margin-top: 10px;">
                                ${JSON.parse(ns.corrections).join('<br>')}
                            </div>
                        </div>
                    ` : ''}
                    
                    <div style="margin-top: 25px; text-align: center;">
                        <button class="btn btn-primary" onclick="closeModal()">
                            –ó–∞–∫—Ä—ã—Ç—å
                        </button>
                    </div>
                `;
                
                document.getElementById('modalTitle').textContent = '–î–µ—Ç–∞–ª–∏ –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è';
                document.getElementById('modalContent').innerHTML = modalContent;
                document.getElementById('statusModal').style.display = 'flex';
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥–µ—Ç–∞–ª–µ–π –ù–°:', error);
                showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–µ—Ç–∞–ª–µ–π: ' + error.message, 'error');
            }
        }
        
        async function editNS(nsNumber) {
            try {
                const nsList = await loadFromGoogleSheets();
                const ns = nsList.find(item => item.nsNumber === nsNumber);
                
                if (!ns) return;
                
                const responsibles = JSON.parse(localStorage.getItem('farmstil_responsibles') || '[]');
                const statusConfig = CONFIG.STATUSES[ns.status] || CONFIG.STATUSES.checking;
                
                const modalContent = `
                    <h3 style="color: #1e3c72; margin-bottom: 20px;">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: ${ns.nsNumber}</h3>
                    
                    <div style="margin-bottom: 15px;">
                        <strong>–¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å:</strong> <span class="ln-status" style="background: ${statusConfig.color}">${statusConfig.name}</span>
                    </div>
                    
                    <div class="form-group">
                        <label>–ù–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å:</label>
                        <select id="editStatus" style="width: 100%; padding: 10px; border-radius: 5px; border: 2px solid #ddd;">
                            ${Object.entries(CONFIG.STATUSES).map(([key, value]) => 
                                `<option value="${key}" ${ns.status === key ? 'selected' : ''}>${value.name}</option>`
                            ).join('')}
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>–ù–∞–∑–Ω–∞—á–∏—Ç—å –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ:</label>
                        <select id="editResponsible" style="width: 100%; padding: 10px; border-radius: 5px; border: 2px solid #ddd;">
                            <option value="">–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω</option>
                            ${responsibles.map(resp => 
                                `<option value="${resp.name}|${resp.email}" ${ns.responsible === resp.name ? 'selected' : ''}>${resp.name} - ${resp.position}</option>`
                            ).join('')}
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</label>
                        <textarea id="editComment" rows="3" placeholder="–î–æ–±–∞–≤—å—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..." style="width: 100%; padding: 10px; border-radius: 5px; border: 2px solid #ddd;">${ns.notes || ''}</textarea>
                    </div>
                    
                    <div style="display: flex; gap: 10px; margin-top: 25px;">
                        <button class="btn btn-success" onclick="saveNSChanges('${nsNumber}')" style="flex: 2;">
                            üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
                        </button>
                        <button class="btn btn-danger" onclick="closeModal()" style="flex: 1;">
                            ‚ùå –û—Ç–º–µ–Ω–∞
                        </button>
                    </div>
                `;
                
                document.getElementById('modalTitle').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è';
                document.getElementById('modalContent').innerHTML = modalContent;
                document.getElementById('statusModal').style.display = 'flex';
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ù–°:', error);
                showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ' + error.message, 'error');
            }
        }
        
        async function saveNSChanges(nsNumber) {
            try {
                const nsList = await loadFromGoogleSheets();
                const nsIndex = nsList.findIndex(item => item.nsNumber === nsNumber);
                
                if (nsIndex === -1) {
                    showNotification('–ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ', 'error');
                    return;
                }
                
                const newStatus = document.getElementById('editStatus').value;
                const responsible = document.getElementById('editResponsible').value;
                const comment = document.getElementById('editComment').value;
                
                nsList[nsIndex].status = newStatus;
                nsList[nsIndex].notes = comment;
                
                if (responsible) {
                    const [name, email] = responsible.split('|');
                    nsList[nsIndex].responsible = name;
                    nsList[nsIndex].responsibleEmail = email;
                    
                    if (newStatus === 'checking') {
                        nsList[nsIndex].status = 'analysis';
                    }
                }
                
                nsList[nsIndex].updated = new Date().toISOString();
                nsList[nsIndex].updatedBy = '–ú–µ–Ω–µ–¥–∂–µ—Ä –°–ú–ö';
                
                await saveToGoogleSheets(nsList[nsIndex]);
                
                loadNSList(currentNSFilter);
                updateStats();
                
                closeModal();
                showNotification('–ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã', 'success');
                
                if (responsible) {
                    const [name, email] = responsible.split('|');
                    await sendAssignmentEmail(nsList[nsIndex], name, email);
                }
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', error);
                showNotification('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + error.message, 'error');
            }
        }
        
        async function sendAssignmentEmail(nsData, responsibleName, responsibleEmail) {
            try {
                const emailBody = `
                    <h2>üéØ –í–∞–º –Ω–∞–∑–Ω–∞—á–µ–Ω–æ –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ</h2>
                    <h3>${nsData.nsNumber}</h3>
                    
                    <table style="width: 100%; border-collapse: collapse; margin: 20px 0; border: 1px solid #ddd;">
                        <tr><td style="padding: 10px; background: #f9f9f9;"><strong>–ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ:</strong></td><td style="padding: 10px;">${nsData.department}</td></tr>
                        <tr><td style="padding: 10px; background: #f9f9f9;"><strong>–ú–µ—Å—Ç–æ:</strong></td><td style="padding: 10px;">${nsData.location}</td></tr>
                        <tr><td style="padding: 10px; background: #f9f9f9;"><strong>–ó–∞—è–≤–∏—Ç–µ–ª—å:</strong></td><td style="padding: 10px;">${nsData.applicant}</td></tr>
                        <tr><td style="padding: 10px; background: #f9f9f9;"><strong>–î–∞—Ç–∞:</strong></td><td style="padding: 10px;">${nsData.detectionDate}</td></tr>
                    </table>
                    
                    <h4>–û–ø–∏—Å–∞–Ω–∏–µ:</h4>
                    <div style="background: #f5f5f5; padding: 15px; border-radius: 5px; margin: 10px 0;">
                        ${nsData.description.replace(/\n/g, '<br>')}
                    </div>
                    
                    <div style="margin: 20px 0; padding: 15px; background: #fff3cd; border-radius: 8px;">
                        <strong>–í–∞—à–∞ –∑–∞–¥–∞—á–∞:</strong>
                        <ol>
                            <li>–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ –∫–æ—Ä–µ–Ω–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è</li>
                            <li>–†–∞–∑—Ä–∞–±–æ—Ç–∞–π—Ç–µ –ø–ª–∞–Ω –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É—é—â–∏—Ö –¥–µ–π—Å—Ç–≤–∏–π</li>
                            <li>–ù–∞–∑–Ω–∞—á—å—Ç–µ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–π –∏ —Å—Ä–æ–∫–∏</li>
                            <li>–ü—Ä–µ–¥–æ—Å—Ç–∞–≤—å—Ç–µ –ø–ª–∞–Ω –Ω–∞ —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –º–µ–Ω–µ–¥–∂–µ—Ä—É –°–ú–ö</li>
                        </ol>
                    </div>
                    
                    <p><a href="${window.location.origin}" style="
                        display: inline-block; padding: 12px 24px; background: #1e3c72; 
                        color: white; text-decoration: none; border-radius: 5px; font-weight: bold;
                    ">–ü–µ—Ä–µ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É</a></p>
                `;
                
                const response = await fetch(CONFIG.WEB3FORMS_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        access_key: CONFIG.WEB3FORMS_KEY,
                        subject: `–§–ê–†–ú–°–¢–ò–õ: –í–∞–º –Ω–∞–∑–Ω–∞—á–µ–Ω–æ –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ ${nsData.nsNumber}`,
                        from_name: '–°–∏—Å—Ç–µ–º–∞ –§–ê–†–ú–°–¢–ò–õ',
                        to: responsibleEmail,
                        html: emailBody,
                        reply_to: responsibleEmail
                    })
                });
                
                console.log('‚úÖ Email –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–º—É –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω');
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ email:', error);
            }
        }
        
        // ========== –°–ü–†–ê–í–û–ß–ù–ò–ö–ò ==========
        
        function loadDirectories() {
            loadResponsibles();
            loadEquipment();
            loadSettings();
        }
        
        function loadResponsibles() {
            try {
                const responsibles = JSON.parse(localStorage.getItem('farmstil_responsibles') || '[]');
                const container = document.getElementById('responsiblesList');
                
                if (!container) return;
                
                if (responsibles.length === 0) {
                    container.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">–ù–µ—Ç –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã—Ö</div>';
                    return;
                }
                
                let html = '';
                responsibles.forEach((resp, index) => {
                    html += `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #eee;">
                            <div>
                                <strong>${resp.name}</strong><br>
                                <small style="color: #666;">${resp.position} ‚Ä¢ ${resp.email}</small>
                            </div>
                            <button onclick="deleteResponsible(${index})" style="
                                background: #dc3545; color: white; border: none; 
                                border-radius: 50%; width: 26px; height: 26px; 
                                font-size: 14px; cursor: pointer;
                            ">
                                √ó
                            </button>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã—Ö:', error);
            }
        }
        
        function addResponsible() {
            const name = document.getElementById('responsibleName').value.trim();
            const position = document.getElementById('responsiblePosition').value.trim();
            const email = document.getElementById('responsibleEmail').value.trim();
            
            if (!name || !position || !email) {
                showNotification('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è', 'error');
                return;
            }
            
            try {
                const responsibles = JSON.parse(localStorage.getItem('farmstil_responsibles') || '[]');
                responsibles.push({ name, position, email });
                localStorage.setItem('farmstil_responsibles', JSON.stringify(responsibles));
                
                document.getElementById('responsibleName').value = '';
                document.getElementById('responsiblePosition').value = '';
                document.getElementById('responsibleEmail').value = '';
                
                loadResponsibles();
                showNotification('–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π –¥–æ–±–∞–≤–ª–µ–Ω', 'success');
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ:', error);
                showNotification('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è: ' + error.message, 'error');
            }
        }
        
        function deleteResponsible(index) {
            if (confirm('–£–¥–∞–ª–∏—Ç—å –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ?')) {
                try {
                    const responsibles = JSON.parse(localStorage.getItem('farmstil_responsibles') || '[]');
                    responsibles.splice(index, 1);
                    localStorage.setItem('farmstil_responsibles', JSON.stringify(responsibles));
                    loadResponsibles();
                    showNotification('–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π —É–¥–∞–ª–µ–Ω', 'success');
                } catch (error) {
                    console.error('‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ:', error);
                    showNotification('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è', 'error');
                }
            }
        }
        
        function loadEquipment() {
            try {
                const equipment = JSON.parse(localStorage.getItem('farmstil_equipment') || '[]');
                const container = document.getElementById('equipmentList');
                
                if (!container) return;
                
                if (equipment.length === 0) {
                    container.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">–ù–µ—Ç –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è</div>';
                    return;
                }
                
                let html = '';
                equipment.forEach((eq, index) => {
                    html += `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #eee;">
                            <div>
                                <strong>${eq.name}</strong><br>
                                <small style="color: #666;">${eq.code}</small>
                            </div>
                            <button onclick="deleteEquipment(${index})" style="
                                background: #dc3545; color: white; border: none; 
                                border-radius: 50%; width: 26px; height: 26px; 
                                font-size: 14px; cursor: pointer;
                            ">
                                √ó
                            </button>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è:', error);
            }
        }
        
        function getEquipmentOptions() {
            try {
                const equipment = JSON.parse(localStorage.getItem('farmstil_equipment') || '[]');
                let options = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ</option>';
                equipment.forEach(eq => {
                    options += `<option value="${eq.name}|${eq.code}">${eq.name} (${eq.code})</option>`;
                });
                return options;
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è:', error);
                return '<option value="">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</option>';
            }
        }
        
        function addEquipment() {
            const name = document.getElementById('equipmentName').value.trim();
            const code = document.getElementById('equipmentCode').value.trim();
            
            if (!name || !code) {
                showNotification('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –∏ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–Ω—ã–π –Ω–æ–º–µ—Ä', 'error');
                return;
            }
            
            try {
                const equipment = JSON.parse(localStorage.getItem('farmstil_equipment') || '[]');
                equipment.push({ name, code });
                localStorage.setItem('farmstil_equipment', JSON.stringify(equipment));
                
                document.getElementById('equipmentName').value = '';
                document.getElementById('equipmentCode').value = '';
                
                loadEquipment();
                showNotification('–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ', 'success');
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è:', error);
                showNotification('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è: ' + error.message, 'error');
            }
        }
        
        function deleteEquipment(index) {
            if (confirm('–£–¥–∞–ª–∏—Ç—å –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ?')) {
                try {
                    const equipment = JSON.parse(localStorage.getItem('farmstil_equipment') || '[]');
                    equipment.splice(index, 1);
                    localStorage.setItem('farmstil_equipment', JSON.stringify(equipment));
                    loadEquipment();
                    showNotification('–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ', 'success');
                } catch (error) {
                    console.error('‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è:', error);
                    showNotification('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è', 'error');
                }
            }
        }
        
        function loadSettings() {
            try {
                const managerEmail = localStorage.getItem('manager_email') || 'finkart23@mail.ru';
                const googleSheetsUrl = localStorage.getItem('google_sheets_url') || CONFIG.GOOGLE_SHEETS_API;
                
                document.getElementById('managerEmail').value = managerEmail;
                document.getElementById('googleSheetsUrl').value = googleSheetsUrl;
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫:', error);
            }
        }
        
        function saveAPISettings() {
            try {
                const managerEmail = document.getElementById('managerEmail').value;
                const googleSheetsUrl = document.getElementById('googleSheetsUrl').value;
                
                if (!managerEmail.includes('@')) {
                    showNotification('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π email', 'error');
                    return;
                }
                
                localStorage.setItem('manager_email', managerEmail);
                localStorage.setItem('google_sheets_url', googleSheetsUrl);
                
                showNotification('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã', 'success');
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫:', error);
                showNotification('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + error.message, 'error');
            }
        }
        
        async function testGoogleSheets() {
            try {
                showNotification('–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è...', 'info');
                
                const apiUrl = localStorage.getItem('google_sheets_url') || CONFIG.GOOGLE_SHEETS_API;
                
                if (!apiUrl || !apiUrl.startsWith('http')) {
                    showNotification('‚ùå URL Google Sheets –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω', 'error');
                    return;
                }
                
                const response = await fetch(`${apiUrl}?action=get`);
                if (!response.ok) {
                    throw new Error(`HTTP error ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data && data.success) {
                    showNotification(`‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ. –ó–∞–ø–∏—Å–µ–π: ${data.data.length}`, 'success');
                } else {
                    showNotification('‚ö†Ô∏è –°–µ—Ä–≤–µ—Ä –æ—Ç–≤–µ—Ç–∏–ª, –Ω–æ —Å –æ—à–∏–±–∫–æ–π', 'warning');
                }
                
            } catch (error) {
                showNotification('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ' + error.message, 'error');
            }
        }
        
        async function syncWithGoogleSheets() {
            try {
                showNotification('–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å Google Sheets...', 'info');
                
                const data = await loadFromGoogleSheets();
                updateStats();
                loadNSList(currentNSFilter);
                
                showNotification(`‚úÖ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ. –ó–∞–ø–∏—Å–µ–π: ${data.length}`, 'success');
                
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏:', error);
                showNotification('‚ö†Ô∏è –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –Ω–µ —É–¥–∞–ª–∞—Å—å. –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ.', 'warning');
            }
        }
        
        function forceSync() {
            localStorage.removeItem('farmstil_ns_cloud');
            syncWithGoogleSheets();
        }
        
        // ========== –ê–î–ú–ò–ù–ò–°–¢–†–ò–†–û–í–ê–ù–ò–ï ==========
        
        async function updateStats() {
            try {
                const nsList = await loadFromGoogleSheets();
                
                const totalNS = nsList.length;
                const checkingNS = nsList.filter(ns => ns.status === 'checking').length;
                const analysisNS = nsList.filter(ns => ns.status === 'analysis').length;
                const closedNS = nsList.filter(ns => ns.status === 'closed').length;
                
                if (document.getElementById('totalNS')) {
                    document.getElementById('totalNS').textContent = totalNS;
                    document.getElementById('checkingNS').textContent = checkingNS;
                    document.getElementById('analysisNS').textContent = analysisNS;
                    document.getElementById('closedNS').textContent = closedNS;
                }
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', error);
            }
        }
        
        function updateSystemStatus() {
            const statusDiv = document.getElementById('systemStatus');
            if (!statusDiv) return;
            
            try {
                const managerEmail = localStorage.getItem('manager_email') || '–ù–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω';
                const googleSheetsUrl = localStorage.getItem('google_sheets_url') || CONFIG.GOOGLE_SHEETS_API;
                const qrCount = JSON.parse(localStorage.getItem('farmstil_qrcodes') || '[]').length;
                const responsiblesCount = JSON.parse(localStorage.getItem('farmstil_responsibles') || '[]').length;
                
                statusDiv.innerHTML = `
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 14px;">
                        <div><strong>Email –º–µ–Ω–µ–¥–∂–µ—Ä–∞:</strong></div>
                        <div>${managerEmail}</div>
                        
                        <div><strong>Google Sheets:</strong></div>
                        <div>${googleSheetsUrl && googleSheetsUrl.startsWith('http') ? '‚úÖ –ù–∞—Å—Ç—Ä–æ–µ–Ω' : '‚ùå –ù–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω'}</div>
                        
                        <div><strong>QR-–∫–æ–¥–æ–≤ —Å–æ–∑–¥–∞–Ω–æ:</strong></div>
                        <div>${qrCount}</div>
                        
                        <div><strong>–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã—Ö –ª–∏—Ü:</strong></div>
                        <div>${responsiblesCount}</div>
                        
                        <div><strong>–õ–æ–∫–∞–ª—å–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π:</strong></div>
                        <div>${JSON.parse(localStorage.getItem('farmstil_ns_local') || '[]').length}</div>
                    </div>
                `;
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ —Å–∏—Å—Ç–µ–º—ã:', error);
                statusDiv.innerHTML = `<div style="color: #dc3545;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç—É—Å–∞: ${error.message}</div>`;
            }
        }
        
        function backupData() {
            try {
                const data = {
                    qrcodes: JSON.parse(localStorage.getItem('farmstil_qrcodes') || '[]'),
                    responsibles: JSON.parse(localStorage.getItem('farmstil_responsibles') || '[]'),
                    equipment: JSON.parse(localStorage.getItem('farmstil_equipment') || '[]'),
                    settings: {
                        manager_email: localStorage.getItem('manager_email'),
                        google_sheets_url: localStorage.getItem('google_sheets_url')
                    },
                    date: new Date().toISOString()
                };
                
                const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `farmstil_backup_${new Date().toISOString().slice(0,10)}.json`;
                a.click();
                
                URL.revokeObjectURL(url);
                showNotification('–†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è —Å–æ–∑–¥–∞–Ω–∞', 'success');
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏:', error);
                showNotification('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏', 'error');
            }
        }
        
        function restoreData() {
            try {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                
                input.onchange = function(e) {
                    const file = e.target.files[0];
                    if (!file) return;
                    
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        try {
                            const data = JSON.parse(event.target.result);
                            
                            if (confirm('–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏? –¢–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –∑–∞–º–µ–Ω–µ–Ω—ã.')) {
                                if (data.qrcodes) localStorage.setItem('farmstil_qrcodes', JSON.stringify(data.qrcodes));
                                if (data.responsibles) localStorage.setItem('farmstil_responsibles', JSON.stringify(data.responsibles));
                                if (data.equipment) localStorage.setItem('farmstil_equipment', JSON.stringify(data.equipment));
                                if (data.settings) {
                                    if (data.settings.manager_email) {
                                        localStorage.setItem('manager_email', data.settings.manager_email);
                                    }
                                    if (data.settings.google_sheets_url) {
                                        localStorage.setItem('google_sheets_url', data.settings.google_sheets_url);
                                    }
                                }
                                
                                loadDirectories();
                                updateSystemStatus();
                                
                                showNotification('–î–∞–Ω–Ω—ã–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã', 'success');
                            }
                        } catch (error) {
                            console.error('–û—à–∏–±–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è:', error);
                            showNotification('–û—à–∏–±–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö', 'error');
                        }
                    };
                    
                    reader.readAsText(file);
                };
                
                input.click();
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö:', error);
                showNotification('–û—à–∏–±–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è', 'error');
            }
        }
        
        function clearLocalData() {
            if (confirm('–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ? –≠—Ç–æ –Ω–µ –∑–∞—Ç—Ä–æ–Ω–µ—Ç Google Sheets.')) {
                try {
                    localStorage.removeItem('farmstil_ns_local');
                    localStorage.removeItem('farmstil_qrcodes');
                    localStorage.removeItem('farmstil_responsibles');
                    localStorage.removeItem('farmstil_equipment');
                    
                    loadNSList('all');
                    loadDirectories();
                    updateStats();
                    updateSystemStatus();
                    
                    showNotification('–õ–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ—á–∏—â–µ–Ω—ã', 'success');
                } catch (error) {
                    console.error('‚ùå –û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', error);
                    showNotification('–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö', 'error');
                }
            }
        }
        
        // ========== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ==========
        
        function getEmployeeOptions() {
            try {
                const responsibles = JSON.parse(localStorage.getItem('farmstil_responsibles') || '[]');
                let options = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å–µ–±—è</option>';
                responsibles.forEach(resp => {
                    options += `<option value="${resp.name}|${resp.position}">${resp.name} - ${resp.position}</option>`;
                });
                return options;
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤:', error);
                return '<option value="">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</option>';
            }
        }
        
        function fillApplicantData() {
            const select = document.getElementById('applicantSelect');
            if (select && select.value) {
                const [name] = select.value.split('|');
                const applicantField = document.getElementById('applicant');
                if (applicantField) {
                    applicantField.value = name;
                }
            }
        }
        
        function cancelWorkerForm() {
            const urlParams = new URLSearchParams(window.location.search);
            const qrCode = urlParams.get('qrcode');
            
            if (qrCode) {
                window.location.href = window.location.pathname + '?qrcode=' + encodeURIComponent(qrCode);
            } else {
                window.location.href = window.location.pathname;
            }
        }
        
        // ========== QR –ö–û–î–´ ==========
        
        function generateQRCode() {
            try {
                const department = document.getElementById('qrDepartment').value;
                const location = document.getElementById('qrLocationInput').value;
                const responsible = document.getElementById('qrResponsible').value;
                
                if (!department || !location) {
                    showNotification('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è', 'error');
                    return;
                }
                
                const timestamp = Date.now().toString().slice(-6);
                const random = Math.random().toString(36).substr(2, 4).toUpperCase();
                const code = `FS-${timestamp}-${random}`;
                
                const currentUrl = window.location.origin + window.location.pathname;
                const qrUrl = `${currentUrl}?qrcode=${encodeURIComponent(code)}`;
                
                currentQRData = {
                    code: code,
                    department: department,
                    location: location,
                    responsible: responsible || '',
                    url: qrUrl,
                    created: new Date().toISOString()
                };
                
                const qrcodes = JSON.parse(localStorage.getItem('farmstil_qrcodes') || '[]');
                qrcodes.push(currentQRData);
                localStorage.setItem('farmstil_qrcodes', JSON.stringify(qrcodes));
                
                const qrcodeDiv = document.getElementById('qrcode');
                if (qrcodeDiv) {
                    qrcodeDiv.innerHTML = '';
                    
                    if (typeof QRCode !== 'undefined') {
                        new QRCode(qrcodeDiv, {
                            text: qrUrl,
                            width: 200,
                            height: 200,
                            colorDark: "#1e3c72",
                            colorLight: "#ffffff",
                            correctLevel: QRCode.CorrectLevel.H
                        });
                    }
                }
                
                document.getElementById('qrPreview').style.display = 'block';
                document.getElementById('previewDept').textContent = department;
                document.getElementById('previewLocation').textContent = location;
                document.getElementById('previewCode').textContent = code;
                document.getElementById('previewDate').textContent = new Date().toLocaleDateString('ru-RU');
                
                showNotification('QR-–∫–æ–¥ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!', 'success');
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ QR-–∫–æ–¥–∞:', error);
                showNotification('–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ QR-–∫–æ–¥–∞', 'error');
            }
        }
        
        function printQRCode() {
            const printWindow = window.open('', '_blank');
            if (printWindow) {
                printWindow.document.write(`
                    <html>
                    <head>
                        <title>–ü–µ—á–∞—Ç—å QR-–∫–æ–¥–∞</title>
                        <style>
                            body { font-family: Arial, sans-serif; text-align: center; padding: 20px; }
                            .qr-code { margin: 20px auto; }
                            .info { margin: 20px 0; }
                        </style>
                    </head>
                    <body>
                        <h2>QR-–∫–æ–¥ –¥–ª—è —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</h2>
                        <div class="info">
                            <p><strong>–ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ:</strong> ${currentQRData?.department}</p>
                            <p><strong>–ú–µ—Å—Ç–æ:</strong> ${currentQRData?.location}</p>
                            <p><strong>–ö–æ–¥:</strong> ${currentQRData?.code}</p>
                            <p><strong>–°–æ–∑–¥–∞–Ω:</strong> ${new Date(currentQRData?.created).toLocaleDateString('ru-RU')}</p>
                        </div>
                        <div class="qr-code">${document.getElementById('qrcode').innerHTML}</div>
                        <script>
                            window.onload = function() { window.print(); window.close(); }
                        </script>
                    </body>
                    </html>
                `);
                printWindow.document.close();
            }
        }
        
        function saveQRAsImage() {
            const qrCanvas = document.querySelector('#qrcode canvas');
            if (qrCanvas) {
                const link = document.createElement('a');
                link.download = `QR-${currentQRData?.code}.png`;
                link.href = qrCanvas.toDataURL('image/png');
                link.click();
                showNotification('QR-–∫–æ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω –∫–∞–∫ PNG', 'success');
            }
        }
        
        function testQRCode() {
            if (currentQRData?.url) {
                window.open(currentQRData.url, '_blank');
                showNotification('–¢–µ—Å—Ç QR-–∫–æ–¥–∞: –æ—Ç–∫—Ä–æ–π—Ç–µ —ç—Ç—É —Å—Å—ã–ª–∫—É –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ', 'info');
            }
        }
        
        // ========== WORKFLOW ==========
        
        async function loadWorkflow() {
            const container = document.getElementById('workflowList');
            if (!container) return;
            
            try {
                const nsList = await loadFromGoogleSheets();
                const activeNS = nsList.filter(ns => ns.status !== 'closed').slice(0, 10);
                
                if (activeNS.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #666;">
                            <h3 style="color: #1e3c72;">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–π</h3>
                            <p>–í—Å–µ –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è –∑–∞–∫—Ä—ã—Ç—ã –∏–ª–∏ –µ—â–µ –Ω–µ —Å–æ–∑–¥–∞–Ω—ã</p>
                        </div>
                    `;
                    return;
                }
                
                let html = '<div class="ln-list">';
                
                activeNS.forEach(ns => {
                    const statusConfig = CONFIG.STATUSES[ns.status] || CONFIG.STATUSES.checking;
                    const stage = statusConfig.stage;
                    
                    html += `
                        <div class="workflow-step ${stage === 'closed' ? 'completed' : stage === ns.status ? 'active' : ''}">
                            <div class="step-number">${getStepNumber(stage)}</div>
                            
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                                <div>
                                    <div class="ln-number">${ns.nsNumber}</div>
                                    <div style="font-size: 12px; color: #666;">${ns.department} ‚Ä¢ ${ns.location}</div>
                                </div>
                                <div>
                                    <span class="stage-badge stage-${stage}">${getStageName(stage)}</span>
                                    <span class="ln-status" style="background: ${statusConfig.color}">${statusConfig.name}</span>
                                </div>
                            </div>
                            
                            <div style="font-size: 14px;">
                                <div><strong>üë§ –ó–∞—è–≤–∏—Ç–µ–ª—å:</strong> ${ns.applicant}</div>
                                <div><strong>üìÖ –°–æ–∑–¥–∞–Ω–æ:</strong> ${new Date(ns.created || ns.timestamp).toLocaleDateString('ru-RU')}</div>
                                
                                ${ns.responsible ? `<div><strong>üéØ –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π:</strong> ${ns.responsible}</div>` : ''}
                                
                                <div style="margin-top: 10px; padding: 8px; background: #f8f9fa; border-radius: 5px;">
                                    ${ns.description ? (ns.description.length > 80 ? ns.description.substring(0, 80) + '...' : ns.description) : '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è'}
                                </div>
                                
                                <div style="display: flex; gap: 10px; margin-top: 15px;">
                                    <button class="btn btn-info" onclick="viewNSDetails('${ns.nsNumber}')" style="padding: 8px 12px; font-size: 13px;">
                                        üëÅÔ∏è –ü—Ä–æ—Å–º–æ—Ç—Ä
                                    </button>
                                    <button class="btn btn-warning" onclick="editNS('${ns.nsNumber}')" style="padding: 8px 12px; font-size: 13px;">
                                        üìù –î–µ–π—Å—Ç–≤–∏—è
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
                container.innerHTML = html;
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ workflow:', error);
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #dc3545;">
                        <h3>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }
        
        function getStepNumber(stage) {
            const stages = {
                'initiation': 1,
                'analysis': 2,
                'correction': 3,
                'execution': 4,
                'verification': 5,
                'closed': 6
            };
            return stages[stage] || 1;
        }
        
        function getStageName(stage) {
            const names = {
                'initiation': '–ò–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞–Ω–∏–µ',
                'analysis': '–ê–Ω–∞–ª–∏–∑',
                'correction': '–ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞',
                'execution': '–ò—Å–ø–æ–ª–Ω–µ–Ω–∏–µ',
                'verification': '–í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è',
                'closed': '–ó–∞–∫—Ä—ã—Ç–æ'
            };
            return names[stage] || stage;
        }
        
        // ========== –≠–ö–°–ü–û–†–¢ –§–£–ù–ö–¶–ò–ô ==========
        
        // –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º –≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –≤ –≥–ª–æ–±–∞–ª—å–Ω—É—é –æ–±–ª–∞—Å—Ç—å –≤–∏–¥–∏–º–æ—Å—Ç–∏
        window.showPage = showPage;
        window.generateQRCode = generateQRCode;
        window.printQRCode = printQRCode;
        window.saveQRAsImage = saveQRAsImage;
        window.testQRCode = testQRCode;
        window.filterNS = filterNS;
        window.viewNSDetails = viewNSDetails;
        window.editNS = editNS;
        window.saveNSChanges = saveNSChanges;
        window.closeModal = closeModal;
        window.addResponsible = addResponsible;
        window.deleteResponsible = deleteResponsible;
        window.addEquipment = addEquipment;
        window.deleteEquipment = deleteEquipment;
        window.saveAPISettings = saveAPISettings;
        window.testGoogleSheets = testGoogleSheets;
        window.syncWithGoogleSheets = syncWithGoogleSheets;
        window.forceSync = forceSync;
        window.submitWorkerForm = submitWorkerForm;
        window.submitWorkerFormManual = submitWorkerFormManual;
        window.fillApplicantData = fillApplicantData;
        window.fillManualApplicantData = fillManualApplicantData;
        window.handlePhotoUpload = handlePhotoUpload;
        window.handleManualPhotoUpload = handleManualPhotoUpload;
        window.removePhoto = removePhoto;
        window.startVoiceInput = startVoiceInput;
        window.startVoiceInputManual = startVoiceInputManual;
        window.cancelWorkerForm = cancelWorkerForm;
        window.startAudioRecording = startAudioRecording;
        window.stopAudioRecording = stopAudioRecording;
        window.removeAudioRecording = removeAudioRecording;
        window.backupData = backupData;
        window.restoreData = restoreData;
        window.clearLocalData = clearLocalData;
        window.showFullPhoto = function(dataUrl) {
            const modalContent = `
                <div style="text-align: center;">
                    <img src="${dataUrl}" style="max-width: 100%; max-height: 70vh; border-radius: 10px;">
                    <div style="margin-top: 15px;">
                        <button class="btn btn-primary" onclick="closeModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
                    </div>
                </div>
            `;
            document.getElementById('modalTitle').textContent = '–ü—Ä–æ—Å–º–æ—Ç—Ä —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏';
            document.getElementById('modalContent').innerHTML = modalContent;
            document.getElementById('statusModal').style.display = 'flex';
        };
        
        window.closeModal = function() {
            document.getElementById('statusModal').style.display = 'none';
        };
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        try {
            if (!localStorage.getItem('farmstil_responsibles')) {
                localStorage.setItem('farmstil_responsibles', JSON.stringify([
                    { name: "–ò–≤–∞–Ω–æ–≤ –ò.–ò.", position: "–ú–∞—Å—Ç–µ—Ä —Ü–µ—Ö–∞", email: "ivanov@example.com" },
                    { name: "–ü–µ—Ç—Ä–æ–≤ –ü.–ü.", position: "–ò–Ω–∂–µ–Ω–µ—Ä", email: "petrov@example.com" },
                    { name: "–°–∏–¥–æ—Ä–æ–≤ –°.–°.", position: "–¢–µ—Ö–Ω–æ–ª–æ–≥", email: "sidorov@example.com" }
                ]));
            }
            
            if (!localStorage.getItem('farmstil_equipment')) {
                localStorage.setItem('farmstil_equipment', JSON.stringify([
                    { name: "–°—Ç–∞–Ω–æ–∫ –ß–ü–£", code: "–°–¢-001" },
                    { name: "–ü—Ä–µ—Å—Å –≥–∏–¥—Ä–∞–≤–ª–∏—á–µ—Å–∫–∏–π", code: "–ü–ì-002" },
                    { name: "–°–≤–∞—Ä–æ—á–Ω—ã–π –∞–ø–ø–∞—Ä–∞—Ç", code: "–°–ê-003" }
                ]));
            }
            
            if (!localStorage.getItem('manager_email')) {
                localStorage.setItem('manager_email', 'finkart23@mail.ru');
            }
            
            if (!localStorage.getItem('google_sheets_url')) {
                localStorage.setItem('google_sheets_url', CONFIG.GOOGLE_SHEETS_API);
            }
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö:', error);
        }
        
    </script>
</body>
</html>

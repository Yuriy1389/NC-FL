<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–§–ê–†–ú–°–¢–ò–õ - –°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è–º–∏</title>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <style>
        /* –û–°–ù–û–í–ù–´–ï –°–¢–ò–õ–ò */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #f0f2f5; padding: 10px; }
        
        /* –®–ê–ü–ö–ê */
        .header { 
            background: linear-gradient(135deg, #1e3c72, #2a5298); 
            color: white; padding: 15px; text-align: center; border-radius: 10px 10px 0 0;
        }
        
        /* –ú–ï–ù–Æ */
        .menu { 
            display: flex; background: #1e3c72; overflow-x: auto;
        }
        .menu-btn { 
            padding: 12px 15px; background: white; border: none; color: #1e3c72; 
            font-weight: bold; cursor: pointer; min-width: 120px; border-right: 1px solid #ddd;
        }
        .menu-btn.active { background: #1e3c72; color: white; }
        
        /* –ö–û–ù–¢–ï–ô–ù–ï–† */
        .container { 
            background: white; border-radius: 0 0 10px 10px; overflow: hidden; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        /* –°–¢–†–ê–ù–ò–¶–´ */
        .page { padding: 20px; display: none; }
        .page.active { display: block; }
        
        /* –§–û–†–ú–´ */
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; color: #333; }
        input, select, textarea { 
            width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; 
            font-size: 16px; font-family: inherit;
        }
        textarea { min-height: 100px; resize: vertical; }
        
        /* –ö–ù–û–ü–ö–ò */
        .btn { 
            padding: 12px 20px; border: none; border-radius: 5px; font-weight: bold; 
            cursor: pointer; display: inline-flex; align-items: center; gap: 8px;
        }
        .btn-primary { background: #1e3c72; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-warning { background: #ffc107; color: #333; }
        
        /* –ì–û–õ–û–°–û–í–û–ô –í–í–û–î */
        .voice-section { 
            display: flex; gap: 10px; margin: 10px 0; align-items: center;
        }
        .voice-btn { 
            background: #ffc107; color: #333; border: none; padding: 10px 15px; 
            border-radius: 5px; font-weight: bold; cursor: pointer; min-width: 120px;
        }
        .voice-btn.listening { background: #dc3545; color: white; }
        
        /* –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø */
        .notification {
            position: fixed; top: 20px; right: 20px; background: white; 
            padding: 15px; border-radius: 5px; box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            display: none; z-index: 1000; border-left: 4px solid #28a745;
        }
        
        /* –†–ï–ñ–ò–ú –†–ê–ë–û–ß–ï–ì–û */
        .worker-mode { max-width: 600px; margin: 20px auto; }
        .worker-header { 
            background: linear-gradient(135deg, #1e3c72, #2a5298); 
            color: white; padding: 20px; text-align: center; border-radius: 10px 10px 0 0;
        }
        .worker-content { padding: 20px; background: white; border-radius: 0 0 10px 10px; }
        
        /* –§–û–¢–û */
        .photo-section { margin: 15px 0; }
        .photo-btn { background: #28a745; color: white; padding: 10px; border-radius: 5px; cursor: pointer; }
        .photo-preview { 
            display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); 
            gap: 10px; margin-top: 10px;
        }
        .photo-item { position: relative; }
        .photo-item img { width: 100%; height: 100px; object-fit: cover; border-radius: 5px; }
        
        /* QR –ö–û–î */
        .qr-preview { text-align: center; margin-top: 20px; padding: 20px; border: 2px dashed #ddd; }
        
        /* –°–ü–ò–°–û–ö –ù–° */
        .ns-card { 
            background: white; border: 1px solid #ddd; border-radius: 5px; 
            padding: 15px; margin-bottom: 10px;
        }
        .ns-number { font-weight: bold; color: #1e3c72; }
        .ns-status { 
            background: #ffc107; color: #333; padding: 3px 10px; 
            border-radius: 15px; font-size: 12px; float: right;
        }
    </style>
</head>
<body>
    <!-- –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø -->
    <div id="notification" class="notification"></div>
    
    <!-- –†–ï–ñ–ò–ú –†–ê–ë–û–ß–ï–ì–û -->
    <div id="workerMode" class="worker-mode" style="display: none;">
        <div class="worker-header">
            <h1>üìù –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è</h1>
            <p>–§–ê–†–ú–°–¢–ò–õ</p>
        </div>
        <div class="worker-content">
            <div id="workerForm"></div>
        </div>
    </div>
    
    <!-- –†–ï–ñ–ò–ú –ê–î–ú–ò–ù–ê -->
    <div id="adminMode">
        <div class="header">
            <h1>–§–ê–†–ú–°–¢–ò–õ - –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–∞—è –ø–∞–Ω–µ–ª—å</h1>
            <p>–°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è–º–∏</p>
        </div>
        
        <div class="container">
            <div class="menu">
                <button class="menu-btn active" onclick="showPage('generateQR')">üéØ –°–æ–∑–¥–∞—Ç—å QR</button>
                <button class="menu-btn" onclick="showPage('listNS')">üìã –í—Å–µ –ù–°</button>
                <button class="menu-btn" onclick="showPage('directories')">üìö –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏</button>
            </div>
            
            <!-- –°–û–ó–î–ê–ù–ò–ï QR -->
            <div id="generateQRPage" class="page active">
                <h2>üéØ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è QR-–∫–æ–¥–∞</h2>
                <div class="form-group">
                    <label>–ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ:</label>
                    <select id="qrDepartment">
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ</option>
                        <option value="–¶–µ—Ö1">–¶–µ—Ö 1</option>
                        <option value="–¶–µ—Ö2">–¶–µ—Ö 2</option>
                        <option value="–°–∫–ª–∞–¥">–°–∫–ª–∞–¥</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>–ú–µ—Å—Ç–æ:</label>
                    <input type="text" id="qrLocation" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –õ–∏–Ω–∏—è 1">
                </div>
                <button class="btn btn-primary" onclick="generateQRCode()">–°–æ–∑–¥–∞—Ç—å QR-–∫–æ–¥</button>
                <div id="qrPreview" class="qr-preview" style="display: none;">
                    <h3>QR-–∫–æ–¥ —Å–æ–∑–¥–∞–Ω!</h3>
                    <div id="qrcode"></div>
                    <button class="btn btn-success" onclick="printQRCode()">–ü–µ—á–∞—Ç—å</button>
                </div>
            </div>
            
            <!-- –°–ü–ò–°–û–ö –ù–° -->
            <div id="listNSPage" class="page">
                <h2>üìã –í—Å–µ –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è</h2>
                <div style="margin-bottom: 20px;">
                    <button class="btn" onclick="filterNS('all')" style="background: #6c757d; color: white;">–í—Å–µ</button>
                    <button class="btn btn-warning" onclick="filterNS('checking')">–ù–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ</button>
                    <button class="btn btn-success" onclick="filterNS('closed')">–ó–∞–∫—Ä—ã—Ç—ã–µ</button>
                </div>
                <div id="nsListContainer"></div>
            </div>
            
            <!-- –°–ü–†–ê–í–û–ß–ù–ò–ö–ò -->
            <div id="directoriesPage" class="page">
                <h2>üìö –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏</h2>
                <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
                    <h3>üë• –°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏</h3>
                    <div id="employeesList" style="margin: 10px 0;"></div>
                    <input type="text" id="employeeName" placeholder="–§–ò–û">
                    <button class="btn btn-success" onclick="addEmployee()">–î–æ–±–∞–≤–∏—Ç—å</button>
                </div>
                <div style="background: #f8f9fa; padding: 15px; border-radius: 5px;">
                    <h3>üìß Email –º–µ–Ω–µ–¥–∂–µ—Ä–∞</h3>
                    <input type="email" id="managerEmail" value="finkart23@mail.ru">
                    <button class="btn btn-primary" onclick="saveEmailSettings()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï
        // ============================================
        let currentQRData = null;
        let photos = [];
        let isListening = false;
        let recognition = null;
        
        // ============================================
        // –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –°–ò–°–¢–ï–ú–´
        // ============================================
        document.addEventListener('DOMContentLoaded', function() {
            console.log('–°–∏—Å—Ç–µ–º–∞ –§–ê–†–ú–°–¢–ò–õ –∑–∞–ø—É—â–µ–Ω–∞');
            checkMode();
            initDefaultData();
        });
        
        function checkMode() {
            const urlParams = new URLSearchParams(window.location.search);
            const qrCode = urlParams.get('qrcode');
            
            if (qrCode) {
                // –†–µ–∂–∏–º —Ä–∞–±–æ—á–µ–≥–æ
                document.getElementById('adminMode').style.display = 'none';
                document.getElementById('workerMode').style.display = 'block';
                showWorkerForm(qrCode);
            } else {
                // –†–µ–∂–∏–º –∞–¥–º–∏–Ω–∞
                document.getElementById('adminMode').style.display = 'block';
                document.getElementById('workerMode').style.display = 'none';
                showPage('generateQR');
            }
        }
        
        function initDefaultData() {
            if (!localStorage.getItem('farmstil_employees')) {
                const employees = [
                    { name: "–ò–≤–∞–Ω–æ–≤ –ò.–ò.", position: "–ú–∞—Å—Ç–µ—Ä" },
                    { name: "–ü–µ—Ç—Ä–æ–≤ –ü.–ü.", position: "–ò–Ω–∂–µ–Ω–µ—Ä" },
                    { name: "–°–∏–¥–æ—Ä–æ–≤ –°.–°.", position: "–¢–µ—Ö–Ω–æ–ª–æ–≥" }
                ];
                localStorage.setItem('farmstil_employees', JSON.stringify(employees));
            }
            
            if (!localStorage.getItem('farmstil_ns')) {
                localStorage.setItem('farmstil_ns', '[]');
            }
            
            if (!localStorage.getItem('farmstil_qrcodes')) {
                localStorage.setItem('farmstil_qrcodes', '[]');
            }
        }
        
        // ============================================
        // –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø
        // ============================================
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.style.display = 'block';
            notification.style.borderLeftColor = type === 'error' ? '#dc3545' : 
                                                type === 'warning' ? '#ffc107' : '#28a745';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }
        
        // ============================================
        // –£–ü–†–ê–í–õ–ï–ù–ò–ï –°–¢–†–ê–ù–ò–¶–ê–ú–ò
        // ============================================
        function showPage(pageId) {
            // –°–∫—Ä—ã—Ç—å –≤—Å–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            // –°–∫—Ä—ã—Ç—å –≤—Å–µ –∫–Ω–æ–ø–∫–∏ –º–µ–Ω—é
            document.querySelectorAll('.menu-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // –ü–æ–∫–∞–∑–∞—Ç—å –Ω—É–∂–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
            const page = document.getElementById(pageId + 'Page');
            if (page) {
                page.classList.add('active');
                
                // –ù–∞–π—Ç–∏ –∏ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –∫–Ω–æ–ø–∫—É –º–µ–Ω—é
                const buttons = document.querySelectorAll('.menu-btn');
                const pageIndex = ['generateQR', 'listNS', 'directories'].indexOf(pageId);
                if (buttons[pageIndex]) {
                    buttons[pageIndex].classList.add('active');
                }
                
                // –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
                if (pageId === 'listNS') {
                    loadNSList('all');
                }
                if (pageId === 'directories') {
                    loadEmployees();
                }
            }
        }
        
        // ============================================
        // –†–ï–ñ–ò–ú –†–ê–ë–û–ß–ï–ì–û
        // ============================================
        function showWorkerForm(qrCode) {
            console.log('QR –∫–æ–¥:', qrCode);
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ QR –≤ –±–∞–∑–µ
            let qrData = null;
            const qrcodes = JSON.parse(localStorage.getItem('farmstil_qrcodes') || '[]');
            for (const qr of qrcodes) {
                if (qr.code === qrCode || decodeURIComponent(qr.code) === qrCode) {
                    qrData = qr;
                    break;
                }
            }
            
            let formHTML = '';
            
            if (qrData) {
                // –§–æ—Ä–º–∞ —Å –¥–∞–Ω–Ω—ã–º–∏ –∏–∑ QR
                formHTML = `
                    <h3>üìù –§–æ—Ä–º–∞ –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è</h3>
                    
                    <div style="background: #e3f2fd; padding: 15px; border-radius: 5px; margin: 15px 0;">
                        <p><strong>–ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ:</strong> ${qrData.department}</p>
                        <p><strong>–ú–µ—Å—Ç–æ:</strong> ${qrData.location}</p>
                    </div>
                    
                    <div class="form-group">
                        <label>üë§ –í–∞—à–µ –§–ò–û:</label>
                        <select id="applicantSelect">
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ</option>
                            ${getEmployeeOptions()}
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>üìÖ –î–∞—Ç–∞ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è:</label>
                        <input type="date" id="detectionDate" value="${new Date().toISOString().split('T')[0]}">
                    </div>
                    
                    <div class="form-group">
                        <label>üè≠ –û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ:</label>
                        <input type="text" id="equipment" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –°–≤–∞—Ä–æ—á–Ω—ã–π –∞–ø–ø–∞—Ä–∞—Ç">
                    </div>
                    
                    <div class="form-group">
                        <label>üìã –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã:</label>
                        <div class="voice-section">
                            <button class="voice-btn" onclick="startVoiceInput()" id="voiceBtn">üé§ –ì–æ–ª–æ—Å–æ–º</button>
                            <span id="voiceStatus"></span>
                        </div>
                        <textarea id="description" placeholder="–û–ø–∏—à–∏—Ç–µ –ø—Ä–æ–±–ª–µ–º—É..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>üì∑ –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):</label>
                        <input type="file" id="photoInput" multiple accept="image/*" style="display: none;" 
                               onchange="handlePhotoUpload(event)">
                        <button type="button" class="photo-btn" onclick="document.getElementById('photoInput').click()">
                            üì∏ –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ
                        </button>
                        <div class="photo-preview" id="photoPreview"></div>
                    </div>
                    
                    <input type="hidden" id="qrDepartment" value="${qrData.department}">
                    <input type="hidden" id="qrLocation" value="${qrData.location}">
                    
                    <button class="btn btn-success" onclick="submitForm()" style="width: 100%; margin-top: 20px;">
                        üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É
                    </button>
                `;
                
                currentQRData = qrData;
            } else {
                // –§–æ—Ä–º–∞ –±–µ–∑ QR
                formHTML = `
                    <h3>üìù –§–æ—Ä–º–∞ –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è</h3>
                    
                    <div class="form-group">
                        <label>üè≠ –ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ:</label>
                        <input type="text" id="manualDepartment" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –¶–µ—Ö1">
                    </div>
                    
                    <div class="form-group">
                        <label>üìç –ú–µ—Å—Ç–æ:</label>
                        <input type="text" id="manualLocation" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –£—á–∞—Å—Ç–æ–∫ 1">
                    </div>
                    
                    <div class="form-group">
                        <label>üë§ –í–∞—à–µ –§–ò–û:</label>
                        <select id="applicantSelect">
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ</option>
                            ${getEmployeeOptions()}
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>üìÖ –î–∞—Ç–∞ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è:</label>
                        <input type="date" id="detectionDate" value="${new Date().toISOString().split('T')[0]}">
                    </div>
                    
                    <div class="form-group">
                        <label>üè≠ –û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ:</label>
                        <input type="text" id="equipment" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –°–≤–∞—Ä–æ—á–Ω—ã–π –∞–ø–ø–∞—Ä–∞—Ç">
                    </div>
                    
                    <div class="form-group">
                        <label>üìã –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã:</label>
                        <div class="voice-section">
                            <button class="voice-btn" onclick="startVoiceInput()" id="voiceBtn">üé§ –ì–æ–ª–æ—Å–æ–º</button>
                            <span id="voiceStatus"></span>
                        </div>
                        <textarea id="description" placeholder="–û–ø–∏—à–∏—Ç–µ –ø—Ä–æ–±–ª–µ–º—É..."></textarea>
                    </div>
                    
                    <button class="btn btn-success" onclick="submitManualForm()" style="width: 100%; margin-top: 20px;">
                        üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É
                    </button>
                `;
            }
            
            document.getElementById('workerForm').innerHTML = formHTML;
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ –≤–≤–æ–¥–∞
            initVoiceRecognition();
        }
        
        // ============================================
        // –ì–û–õ–û–°–û–í–û–ô –í–í–û–î - –ü–†–û–°–¢–û–ô –ò –†–ê–ë–û–ß–ò–ô
        // ============================================
        function initVoiceRecognition() {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                console.log('–ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è');
                return;
            }
            
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.lang = 'ru-RU';
            recognition.continuous = false;
            recognition.interimResults = false;
            
            recognition.onstart = function() {
                isListening = true;
                const voiceBtn = document.getElementById('voiceBtn');
                if (voiceBtn) {
                    voiceBtn.classList.add('listening');
                    voiceBtn.textContent = 'üõë –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å';
                }
                showNotification('–ì–æ–≤–æ—Ä–∏—Ç–µ...', 'info');
            };
            
            recognition.onresult = function(event) {
                const transcript = event.results[0][0].transcript;
                console.log('–†–∞—Å–ø–æ–∑–Ω–∞–Ω–æ:', transcript);
                
                // –û—á–∏—â–∞–µ–º —Ç–µ–∫—Å—Ç –æ—Ç –æ–±—Ä—ã–≤–∫–æ–≤
                let cleanedText = transcript;
                
                // –£–¥–∞–ª—è–µ–º —Ü–∏—Ñ—Ä—ã –≤ –Ω–∞—á–∞–ª–µ
                cleanedText = cleanedText.replace(/^[\d\s]+/, '');
                
                // –£–±–∏—Ä–∞–µ–º –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è
                const words = cleanedText.split(' ');
                const uniqueWords = [];
                for (let i = 0; i < words.length; i++) {
                    if (words[i] !== words[i-1]) {
                        uniqueWords.push(words[i]);
                    }
                }
                cleanedText = uniqueWords.join(' ');
                
                // –î–æ–±–∞–≤–ª—è–µ–º –≤ –ø–æ–ª–µ –≤–≤–æ–¥–∞
                const descriptionField = document.getElementById('description');
                if (descriptionField) {
                    if (descriptionField.value) {
                        descriptionField.value += ' ' + cleanedText;
                    } else {
                        descriptionField.value = cleanedText;
                    }
                }
                
                showNotification('–¢–µ–∫—Å—Ç –¥–æ–±–∞–≤–ª–µ–Ω', 'success');
            };
            
            recognition.onerror = function(event) {
                console.error('–û—à–∏–±–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è:', event.error);
                isListening = false;
                updateVoiceButton();
                
                if (event.error === 'not-allowed') {
                    showNotification('–†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É', 'error');
                }
            };
            
            recognition.onend = function() {
                isListening = false;
                updateVoiceButton();
            };
        }
        
        function startVoiceInput() {
            if (!recognition) {
                showNotification('–ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è', 'error');
                return;
            }
            
            if (isListening) {
                recognition.stop();
            } else {
                try {
                    recognition.start();
                } catch (error) {
                    showNotification('–û—à–∏–±–∫–∞ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞', 'error');
                }
            }
        }
        
        function updateVoiceButton() {
            const voiceBtn = document.getElementById('voiceBtn');
            if (voiceBtn) {
                if (isListening) {
                    voiceBtn.classList.add('listening');
                    voiceBtn.textContent = 'üõë –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å';
                } else {
                    voiceBtn.classList.remove('listening');
                    voiceBtn.textContent = 'üé§ –ì–æ–ª–æ—Å–æ–º';
                }
            }
        }
        
        // ============================================
        // –û–¢–ü–†–ê–í–ö–ê –§–û–†–ú–´
        // ============================================
        function submitForm() {
            try {
                // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ñ–æ—Ä–º—ã
                const applicantSelect = document.getElementById('applicantSelect');
                const applicant = applicantSelect.value || '';
                const detectionDate = document.getElementById('detectionDate').value;
                const equipment = document.getElementById('equipment').value || '';
                const description = document.getElementById('description').value;
                
                // –î–∞–Ω–Ω—ã–µ –∏–∑ QR
                const department = document.getElementById('qrDepartment').value;
                const location = document.getElementById('qrLocation').value;
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è
                if (!applicant) {
                    showNotification('–í—ã–±–µ—Ä–∏—Ç–µ —Å–≤–æ–µ –§–ò–û', 'error');
                    return;
                }
                
                if (!description.trim()) {
                    showNotification('–í–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã', 'error');
                    return;
                }
                
                // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–æ–º–µ—Ä –ù–°
                const nsNumber = 'HC-' + Math.floor(Math.random() * 9000 + 1000) + '-' + new Date().getFullYear();
                
                // –°–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç –ù–°
                const nsData = {
                    id: Date.now().toString(),
                    nsNumber: nsNumber,
                    detectionDate: detectionDate,
                    department: department,
                    location: location,
                    applicant: applicant,
                    equipment: equipment,
                    description: description,
                    photos: photos.map((photo, i) => `–§–æ—Ç–æ ${i + 1}`), // –¢–æ–ª—å–∫–æ –∏–º–µ–Ω–∞ —Ñ–∞–π–ª–æ–≤
                    status: 'checking',
                    created: new Date().toISOString(),
                    source: 'QR-–∫–æ–¥'
                };
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
                const nsList = JSON.parse(localStorage.getItem('farmstil_ns') || '[]');
                nsList.push(nsData);
                localStorage.setItem('farmstil_ns', JSON.stringify(nsList));
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º email
                sendEmailNotification(nsData);
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω —É—Å–ø–µ—Ö–∞
                showSuccessScreen(nsData);
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏:', error);
                showNotification('–û—à–∏–±–∫–∞: ' + error.message, 'error');
            }
        }
        
        function submitManualForm() {
            try {
                const department = document.getElementById('manualDepartment').value;
                const location = document.getElementById('manualLocation').value;
                const applicantSelect = document.getElementById('applicantSelect');
                const applicant = applicantSelect.value || '';
                const detectionDate = document.getElementById('detectionDate').value;
                const equipment = document.getElementById('equipment').value || '';
                const description = document.getElementById('description').value;
                
                if (!department || !location) {
                    showNotification('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –∏ –º–µ—Å—Ç–æ', 'error');
                    return;
                }
                
                if (!applicant) {
                    showNotification('–í—ã–±–µ—Ä–∏—Ç–µ —Å–≤–æ–µ –§–ò–û', 'error');
                    return;
                }
                
                if (!description.trim()) {
                    showNotification('–í–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã', 'error');
                    return;
                }
                
                const nsNumber = 'HC-' + Math.floor(Math.random() * 9000 + 1000) + '-' + new Date().getFullYear();
                
                const nsData = {
                    id: Date.now().toString(),
                    nsNumber: nsNumber,
                    detectionDate: detectionDate,
                    department: department,
                    location: location,
                    applicant: applicant,
                    equipment: equipment,
                    description: description,
                    photos: [],
                    status: 'checking',
                    created: new Date().toISOString(),
                    source: '–†—É—á–Ω–æ–π –≤–≤–æ–¥'
                };
                
                const nsList = JSON.parse(localStorage.getItem('farmstil_ns') || '[]');
                nsList.push(nsData);
                localStorage.setItem('farmstil_ns', JSON.stringify(nsData));
                
                sendEmailNotification(nsData);
                showSuccessScreen(nsData);
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                showNotification('–û—à–∏–±–∫–∞', 'error');
            }
        }
        
        function showSuccessScreen(nsData) {
            const successHTML = `
                <div style="text-align: center; padding: 30px 0;">
                    <div style="font-size: 60px; color: #28a745;">‚úÖ</div>
                    <h2 style="color: #1e3c72;">–ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞!</h2>
                    
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin: 20px 0; text-align: left;">
                        <p><strong>–ù–æ–º–µ—Ä:</strong> ${nsData.nsNumber}</p>
                        <p><strong>–î–∞—Ç–∞:</strong> ${new Date(nsData.detectionDate).toLocaleDateString('ru-RU')}</p>
                        <p><strong>–ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ:</strong> ${nsData.department}</p>
                        <p><strong>–ú–µ—Å—Ç–æ:</strong> ${nsData.location}</p>
                        <p><strong>–ó–∞—è–≤–∏—Ç–µ–ª—å:</strong> ${nsData.applicant}</p>
                    </div>
                    
                    <div style="display: flex; gap: 10px; justify-content: center;">
                        <button class="btn btn-primary" onclick="createAnotherReport()">
                            üìù –°–æ–∑–¥–∞—Ç—å –µ—â–µ
                        </button>
                        <button class="btn" onclick="returnToMain()" style="background: #6c757d; color: white;">
                            üè† –ù–∞ –≥–ª–∞–≤–Ω—É—é
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('workerForm').innerHTML = successHTML;
            showNotification('‚úÖ –ó–∞—è–≤–∫–∞ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞!', 'success');
        }
        
        function createAnotherReport() {
            // –ï—Å–ª–∏ –µ—Å—Ç—å QR –¥–∞–Ω–Ω—ã–µ, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∏—Ö
            if (currentQRData && currentQRData.code) {
                window.location.href = window.location.pathname + '?qrcode=' + encodeURIComponent(currentQRData.code);
            } else {
                // –ò–Ω–∞—á–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é
                const scanHTML = `
                    <div style="text-align: center; padding: 30px 0;">
                        <div style="font-size: 60px;">üì±</div>
                        <h2>–û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR-–∫–æ–¥</h2>
                        <p>–î–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–π –∑–∞—è–≤–∫–∏ –æ—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR-–∫–æ–¥ –Ω–∞ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–∏</p>
                        <button class="btn btn-primary" onclick="returnToMain()" style="margin-top: 20px;">
                            üè† –ù–∞ –≥–ª–∞–≤–Ω—É—é
                        </button>
                    </div>
                `;
                document.getElementById('workerForm').innerHTML = scanHTML;
            }
        }
        
        function returnToMain() {
            window.location.href = window.location.pathname;
        }
        
        // ============================================
        // EMAIL –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø
        // ============================================
        async function sendEmailNotification(nsData) {
            try {
                const settings = JSON.parse(localStorage.getItem('farmstil_email_settings') || '{}');
                const recipient = settings.managerEmail || 'finkart23@mail.ru';
                
                // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Ç–µ–ª–æ –ø–∏—Å—å–º–∞
                const emailBody = `
–ù–æ–≤–æ–µ –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–æ –≤ —Å–∏—Å—Ç–µ–º–µ –§–ê–†–ú–°–¢–ò–õ

–î–ï–¢–ê–õ–ò:
- –ù–æ–º–µ—Ä: ${nsData.nsNumber}
- –î–∞—Ç–∞ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è: ${new Date(nsData.detectionDate).toLocaleDateString('ru-RU')}
- –ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ: ${nsData.department}
- –ú–µ—Å—Ç–æ: ${nsData.location}
- –ó–∞—è–≤–∏—Ç–µ–ª—å: ${nsData.applicant}
- –û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ: ${nsData.equipment || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}

–û–ü–ò–°–ê–ù–ò–ï:
${nsData.description}

${nsData.photos.length > 0 ? `–ü—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–æ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π: ${nsData.photos.length}` : '–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –Ω–µ –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω—ã'}

–°–¢–ê–¢–£–°: –ù–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ
–î–ê–¢–ê –°–û–ó–î–ê–ù–ò–Ø: ${new Date(nsData.created).toLocaleString('ru-RU')}
–ò–°–¢–û–ß–ù–ò–ö: ${nsData.source}

–î–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥–µ—Ç–∞–ª–µ–π –ø–µ—Ä–µ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É –§–ê–†–ú–°–¢–ò–õ.
                `;
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —á–µ—Ä–µ–∑ Web3Forms
                const response = await fetch('https://api.web3forms.com/submit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        access_key: '68e70096-0aed-4fd2-ba43-a9f06163e05b',
                        subject: `–ù–æ–≤–æ–µ –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ: ${nsData.nsNumber}`,
                        from_name: '–°–∏—Å—Ç–µ–º–∞ –§–ê–†–ú–°–¢–ò–õ',
                        to: recipient,
                        message: emailBody,
                        reply_to: recipient
                    })
                });
                
                const result = await response.json();
                console.log('–†–µ–∑—É–ª—å—Ç–∞—Ç –æ—Ç–ø—Ä–∞–≤–∫–∏:', result);
                
                if (!result.success) {
                    console.error('–û—à–∏–±–∫–∞ email:', result.message);
                }
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ email:', error);
            }
        }
        
        // ============================================
        // –ó–ê–ì–†–£–ó–ö–ê –§–û–¢–û
        // ============================================
        function handlePhotoUpload(event) {
            const files = event.target.files;
            const preview = document.getElementById('photoPreview');
            
            if (!preview) return;
            
            // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ —Ñ–æ—Ç–æ
            photos = [];
            preview.innerHTML = '';
            
            // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
            const fileCount = Math.min(files.length, 3);
            
            for (let i = 0; i < fileCount; i++) {
                const file = files[i];
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä
                if (file.size > 5 * 1024 * 1024) {
                    showNotification(`–§–æ—Ç–æ ${file.name} —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–µ (–º–∞–∫—Å 5MB)`, 'warning');
                    continue;
                }
                
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    const photoDiv = document.createElement('div');
                    photoDiv.className = 'photo-item';
                    photoDiv.innerHTML = `
                        <img src="${e.target.result}" alt="–§–æ—Ç–æ">
                        <button onclick="removePhoto(${i})" style="
                            position: absolute; top: 5px; right: 5px;
                            background: red; color: white; border: none;
                            border-radius: 50%; width: 20px; height: 20px;
                        ">√ó</button>
                    `;
                    preview.appendChild(photoDiv);
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–æ—Ç–æ
                    photos.push({
                        name: file.name,
                        data: e.target.result
                    });
                };
                
                reader.readAsDataURL(file);
            }
            
            if (fileCount > 0) {
                showNotification(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${fileCount} —Ñ–æ—Ç–æ`, 'success');
            }
        }
        
        function removePhoto(index) {
            photos.splice(index, 1);
            updatePhotoPreview();
        }
        
        function updatePhotoPreview() {
            const preview = document.getElementById('photoPreview');
            if (!preview) return;
            
            preview.innerHTML = '';
            
            photos.forEach((photo, i) => {
                const photoDiv = document.createElement('div');
                photoDiv.className = 'photo-item';
                photoDiv.innerHTML = `
                    <img src="${photo.data}" alt="–§–æ—Ç–æ">
                    <button onclick="removePhoto(${i})" style="
                        position: absolute; top: 5px; right: 5px;
                        background: red; color: white; border: none;
                        border-radius: 50%; width: 20px; height: 20px;
                    ">√ó</button>
                `;
                preview.appendChild(photoDiv);
            });
        }
        
        // ============================================
        // –ì–ï–ù–ï–†–ê–¶–ò–Ø QR-–ö–û–î–û–í
        // ============================================
        function generateQRCode() {
            const department = document.getElementById('qrDepartment').value;
            const location = document.getElementById('qrLocation').value;
            
            if (!department || !location) {
                showNotification('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è', 'error');
                return;
            }
            
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–æ–¥
            const code = 'FS-' + Date.now().toString().slice(-8);
            const qrUrl = window.location.origin + window.location.pathname + '?qrcode=' + encodeURIComponent(code);
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ
            currentQRData = {
                code: code,
                department: department,
                location: location,
                url: qrUrl,
                created: new Date().toISOString()
            };
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –±–∞–∑—É
            const qrcodes = JSON.parse(localStorage.getItem('farmstil_qrcodes') || '[]');
            qrcodes.push(currentQRData);
            localStorage.setItem('farmstil_qrcodes', JSON.stringify(qrcodes));
            
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º QR
            const qrcodeDiv = document.getElementById('qrcode');
            qrcodeDiv.innerHTML = '';
            
            if (typeof QRCode !== 'undefined') {
                new QRCode(qrcodeDiv, {
                    text: qrUrl,
                    width: 200,
                    height: 200,
                    colorDark: "#1e3c72",
                    colorLight: "#ffffff"
                });
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–≤—å—é
            document.getElementById('qrPreview').style.display = 'block';
            showNotification('QR-–∫–æ–¥ —Å–æ–∑–¥–∞–Ω', 'success');
        }
        
        function printQRCode() {
            if (!currentQRData) return;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head><title>QR-–∫–æ–¥</title></head>
                <body style="text-align: center; padding: 20px;">
                    <h3>–§–ê–†–ú–°–¢–ò–õ</h3>
                    <p>QR –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–π</p>
                    <div id="qrcode"></div>
                    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
                    <script>
                        new QRCode(document.getElementById('qrcode'), {
                            text: '${currentQRData.url}',
                            width: 200,
                            height: 200
                        });
                        setTimeout(() => window.print(), 500);
                    </script>
                </body>
                </html>
            `);
            printWindow.document.close();
        }
        
        // ============================================
        // –°–ü–†–ê–í–û–ß–ù–ò–ö–ò
        // ============================================
        function getEmployeeOptions() {
            const employees = JSON.parse(localStorage.getItem('farmstil_employees') || '[]');
            let options = '';
            employees.forEach(emp => {
                options += `<option value="${emp.name}">${emp.name}</option>`;
            });
            return options;
        }
        
        function loadEmployees() {
            const employees = JSON.parse(localStorage.getItem('farmstil_employees') || '[]');
            const container = document.getElementById('employeesList');
            
            if (!container) return;
            
            let html = '';
            employees.forEach((emp, index) => {
                html += `
                    <div style="padding: 8px; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between;">
                        <span>${emp.name}</span>
                        <button onclick="deleteEmployee(${index})" style="background: red; color: white; border: none; border-radius: 3px; padding: 2px 8px;">√ó</button>
                    </div>
                `;
            });
            
            container.innerHTML = html || '<div style="padding: 10px; color: #666;">–ù–µ—Ç —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</div>';
        }
        
        function addEmployee() {
            const name = document.getElementById('employeeName').value.trim();
            if (!name) {
                showNotification('–í–≤–µ–¥–∏—Ç–µ –§–ò–û', 'error');
                return;
            }
            
            const employees = JSON.parse(localStorage.getItem('farmstil_employees') || '[]');
            employees.push({ name: name, position: '–°–æ—Ç—Ä—É–¥–Ω–∏–∫' });
            localStorage.setItem('farmstil_employees', JSON.stringify(employees));
            
            document.getElementById('employeeName').value = '';
            loadEmployees();
            showNotification('–°–æ—Ç—Ä—É–¥–Ω–∏–∫ –¥–æ–±–∞–≤–ª–µ–Ω', 'success');
        }
        
        function deleteEmployee(index) {
            if (confirm('–£–¥–∞–ª–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞?')) {
                const employees = JSON.parse(localStorage.getItem('farmstil_employees') || '[]');
                employees.splice(index, 1);
                localStorage.setItem('farmstil_employees', JSON.stringify(employees));
                loadEmployees();
                showNotification('–°–æ—Ç—Ä—É–¥–Ω–∏–∫ —É–¥–∞–ª–µ–Ω', 'success');
            }
        }
        
        function saveEmailSettings() {
            const email = document.getElementById('managerEmail').value;
            if (!email) {
                showNotification('–í–≤–µ–¥–∏—Ç–µ email', 'error');
                return;
            }
            
            localStorage.setItem('farmstil_email_settings', JSON.stringify({ managerEmail: email }));
            showNotification('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã', 'success');
        }
        
        // ============================================
        // –°–ü–ò–°–û–ö –ù–°
        // ============================================
        function loadNSList(filter) {
            const container = document.getElementById('nsListContainer');
            if (!container) return;
            
            const nsList = JSON.parse(localStorage.getItem('farmstil_ns') || '[]');
            let filtered = nsList;
            
            if (filter !== 'all') {
                filtered = nsList.filter(ns => ns.status === filter);
            }
            
            filtered.sort((a, b) => new Date(b.created) - new Date(a.created));
            
            if (filtered.length === 0) {
                container.innerHTML = '<div style="padding: 40px; text-align: center; color: #666;">–ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–π –Ω–µ—Ç</div>';
                return;
            }
            
            let html = '';
            filtered.forEach(ns => {
                html += `
                    <div class="ns-card">
                        <div class="ns-number">${ns.nsNumber}</div>
                        <div class="ns-status">${ns.status === 'checking' ? '–ù–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ' : '–ó–∞–∫—Ä—ã—Ç–æ'}</div>
                        <div style="clear: both;"></div>
                        <div><strong>–î–∞—Ç–∞:</strong> ${new Date(ns.detectionDate).toLocaleDateString('ru-RU')}</div>
                        <div><strong>–ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ:</strong> ${ns.department}</div>
                        <div><strong>–ú–µ—Å—Ç–æ:</strong> ${ns.location}</div>
                        <div><strong>–ó–∞—è–≤–∏—Ç–µ–ª—å:</strong> ${ns.applicant}</div>
                        <div style="margin-top: 10px; padding: 8px; background: #f8f9fa; border-radius: 5px;">
                            ${ns.description.substring(0, 100)}${ns.description.length > 100 ? '...' : ''}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        function filterNS(status) {
            loadNSList(status);
        }
        
        // ============================================
        // –≠–ö–°–ü–û–†–¢ –§–£–ù–ö–¶–ò–ô
        // ============================================
        window.showPage = showPage;
        window.generateQRCode = generateQRCode;
        window.printQRCode = printQRCode;
        window.startVoiceInput = startVoiceInput;
        window.handlePhotoUpload = handlePhotoUpload;
        window.removePhoto = removePhoto;
        window.submitForm = submitForm;
        window.submitManualForm = submitManualForm;
        window.createAnotherReport = createAnotherReport;
        window.returnToMain = returnToMain;
        window.addEmployee = addEmployee;
        window.deleteEmployee = deleteEmployee;
        window.saveEmailSettings = saveEmailSettings;
        window.filterNS = filterNS;
    </script>
</body>
</html>

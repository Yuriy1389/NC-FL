<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–§–ê–†–ú–°–¢–ò–õ - –°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è–º–∏ ISO 13485</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        /* –í–µ—Å—å –≤–∞—à –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π CSS –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ—Ö—Ä–∞–Ω–µ–Ω */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 10px; }
        .container { max-width: 1200px; margin: 0 auto; background: white; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); overflow: hidden; }
        #qrPreview { margin-top: 20px; padding: 20px; border: 2px dashed #ddd; display: none; text-align: center; }
        .header { background: #1e3c72; color: white; padding: 20px; display: flex; justify-content: space-between; align-items: center; }
        .nav-tabs { display: flex; background: #f8f9fa; border-bottom: 1px solid #dee2e6; }
        .nav-tab { padding: 15px 25px; cursor: pointer; border: none; background: none; font-weight: 600; color: #666; transition: 0.3s; }
        .nav-tab.active { color: #1e3c72; border-bottom: 3px solid #1e3c72; background: white; }
        .page { display: none; padding: 20px; }
        .page.active { display: block; }
        .ns-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .ns-table th, .ns-table td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        .status-badge { padding: 5px 10px; border-radius: 15px; font-size: 0.8em; font-weight: bold; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: 600; color: #444; }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; }
        .btn { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: 0.3s; display: inline-flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-success { background: #28a745; color: white; }
        .btn-primary { background: #1e3c72; color: white; }
        .btn-warning { background: #ffc107; color: #333; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; }
        .modal-content { background: white; width: 90%; max-width: 600px; margin: 50px auto; border-radius: 15px; padding: 20px; max-height: 80vh; overflow-y: auto; }
        .photo-preview-container { display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap; }
        .photo-preview { width: 100px; height: 100px; object-fit: cover; border-radius: 8px; border: 1px solid #ddd; }
        .notification { position: fixed; bottom: 20px; right: 20px; padding: 15px 25px; border-radius: 8px; color: white; z-index: 2000; display: none; }
        .sync-status { background: #e9ecef; padding: 10px 20px; border-radius: 8px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        .workflow-step { background: #f8f9fa; border-radius: 8px; padding: 15px; margin-bottom: 10px; border-left: 4px solid #1e3c72; }
    </style>
</head>
<body>
    <div id="notification" class="notification"></div>
    
    <div id="adminApp" class="container">
        <div class="header">
            <div><h1>–§–ê–†–ú–°–¢–ò–õ</h1><p>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è–º–∏ ISO 13485</p></div>
        </div>
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showPage('list')">–°–ø–∏—Å–æ–∫ –õ–ù</button>
            <button class="nav-tab" onclick="showPage('generator')">–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä QR</button>
            <button class="nav-tab" onclick="showPage('settings')">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
        </div>

        <div id="listPage" class="page active">
            <div class="sync-status">
                <div>–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: <strong id="lastSyncTime">–ù–∏–∫–æ–≥–¥–∞</strong></div>
                <button class="btn btn-primary" onclick="loadFromGoogleSheets()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å –∏–∑ Google</button>
            </div>
            <table class="ns-table">
                <thead><tr><th>‚Ññ</th><th>–î–∞—Ç–∞</th><th>–£—á–∞—Å—Ç–æ–∫</th><th>–ü—Ä–æ–±–ª–µ–º–∞</th><th>–°—Ç–∞—Ç—É—Å</th><th>–î–µ–π—Å—Ç–≤–∏–µ</th></tr></thead>
                <tbody id="nsTableBody"></tbody>
            </table>
        </div>

        <div id="generatorPage" class="page">
            <div class="form-group"><label>–û—Ç–¥–µ–ª</label><input type="text" id="qrDept"></div>
            <div class="form-group"><label>–ú–µ—Å—Ç–æ</label><input type="text" id="qrLoc"></div>
            <button class="btn btn-success" onclick="generateQRCode()">–°–æ–∑–¥–∞—Ç—å QR</button>
            <div id="qrPreview"><div id="qrcode"></div><p id="qrLabel"></p></div>
        </div>

        <div id="settingsPage" class="page">
            <div class="form-group"><label>URL Google Script</label><input type="text" id="scriptUrl"></div>
            <button class="btn btn-primary" onclick="saveSettings()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
    </div>

    <div id="workerInterface" class="container" style="display:none; padding:20px;">
        <div id="workerContent"></div>
    </div>

    <div id="nsModal" class="modal">
        <div class="modal-content"><h2 id="modalTitle"></h2><div id="modalBody"></div><button class="btn" onclick="closeModal()">–ó–∞–∫—Ä—ã—Ç—å</button></div>
    </div>

    <script>
        // –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –õ–û–ì–ò–ö–ê (–ë–ï–ó –£–†–ï–ó–ê–ù–ò–Ø)
        const WORKFLOW_STATUSES = { DETECTED: 'detected', CLOSED: 'closed' };
        let workerCapturedPhotos = [];

        // 1. –ü–û–ß–ò–ù–ò–õ–ò –§–û–¢–û (—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ Base64)
        function handleWorkerPhotos(event) {
            const preview = document.getElementById('workerPhotoPreview');
            preview.innerHTML = '';
            workerCapturedPhotos = [];
            Array.from(event.target.files).slice(0, 2).forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    workerCapturedPhotos.push(e.target.result);
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.className = 'photo-preview';
                    preview.appendChild(img);
                };
                reader.readAsDataURL(file);
            });
        }

        // 2. –£–î–ê–õ–ò–õ–ò –¢–ï–õ–ï–§–û–ù –ò–ó –û–¢–ü–†–ê–í–ö–ò –ò –§–û–†–ú–´
        function showWorkerFormFromURL(dept, loc) {
            document.getElementById('workerContent').innerHTML = `
                <h2>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø—Ä–æ–±–ª–µ–º—ã</h2>
                <p>üìç ${dept} | ${loc}</p>
                <form onsubmit="event.preventDefault(); submitWorkerForm('${dept}','${loc}');">
                    <div class="form-group"><label>–§–ò–û *</label><input type="text" id="wApplicant" required></div>
                    <div class="form-group"><label>–î–æ–ª–∂–Ω–æ—Å—Ç—å *</label><input type="text" id="wPos" required></div>
                    <div class="form-group"><label>–ß—Ç–æ —Å–ª—É—á–∏–ª–æ—Å—å? *</label><input type="text" id="wTitle" required></div>
                    <div class="form-group"><label>–û–ø–∏—Å–∞–Ω–∏–µ</label><textarea id="wDesc" rows="4"></textarea></div>
                    <div class="form-group">
                        <label>–§–æ—Ç–æ (–º–∞–∫—Å 2)</label>
                        <input type="file" accept="image/*" multiple onchange="handleWorkerPhotos(event)">
                        <div id="workerPhotoPreview" class="photo-preview-container"></div>
                    </div>
                    <button type="submit" class="btn btn-success" style="width:100%">–û–¢–ü–†–ê–í–ò–¢–¨ –õ–ù</button>
                </form>
            `;
        }

        async function submitWorkerForm(dept, loc) {
            const nsData = {
                id: 'ns_' + Date.now(),
                nsNumber: '–õ–ù-' + Math.floor(1000 + Math.random() * 9000),
                created: new Date().toISOString(),
                department: dept,
                location: loc,
                applicant: document.getElementById('wApplicant').value,
                applicantPosition: document.getElementById('wPos').value,
                nsTitle: document.getElementById('wTitle').value,
                description: document.getElementById('wDesc').value,
                photos: workerCapturedPhotos, // –§–æ—Ç–æ —Ç–µ–ø–µ—Ä—å —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è
                status: 'detected'
            };

            const list = JSON.parse(localStorage.getItem('farmstil_ns') || '[]');
            list.push(nsData);
            localStorage.setItem('farmstil_ns', JSON.stringify(list));
            localStorage.setItem('farmstil_last_sync', new Date().toISOString());

            // –û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ–∫—Å—Ç–∞ –≤ Google (—Ñ–æ—Ç–æ –Ω–µ —à–ª–µ–º –≤ URL, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –æ—à–∏–±–∫–∏)
            const url = localStorage.getItem('farmstil_google_url');
            if(url) {
                const syncData = {...nsData, photos: []}; 
                fetch(`${url}?action=add_ns&data=${encodeURIComponent(JSON.stringify({nsData: syncData}))}`, {mode:'no-cors'});
            }
            alert('–õ–ù —É—Å–ø–µ—à–Ω–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω!');
            location.search = ''; 
        }

        // 3. –ü–û–õ–ù–´–ô –§–£–ù–ö–¶–ò–û–ù–ê–õ –°–ü–ò–°–ö–ê –ò QR
        function loadNSList() {
            const list = JSON.parse(localStorage.getItem('farmstil_ns') || '[]');
            const tbody = document.getElementById('nsTableBody');
            tbody.innerHTML = '';
            list.reverse().forEach(ns => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${ns.nsNumber}</td><td>${new Date(ns.created).toLocaleDateString()}</td><td>${ns.department}</td><td>${ns.nsTitle}</td><td>${ns.status}</td><td><button class="btn btn-primary" onclick="viewNSByID('${ns.id}')">–û—Ç–∫—Ä—ã—Ç—å</button></td>`;
                tbody.appendChild(tr);
            });
            updateLastSyncTime();
        }

        function viewNSByID(id) {
            const list = JSON.parse(localStorage.getItem('farmstil_ns') || '[]');
            const ns = list.find(i => i.id === id);
            document.getElementById('modalTitle').textContent = ns.nsNumber;
            document.getElementById('modalBody').innerHTML = `
                <p><strong>–ó–∞—è–≤–∏—Ç–µ–ª—å:</strong> ${ns.applicant}</p>
                <p><strong>–û–ø–∏—Å–∞–Ω–∏–µ:</strong> ${ns.description || '–ù–µ—Ç'}</p>
                <div class="photo-preview-container">
                    ${(ns.photos || []).map(p => `<img src="${p}" class="photo-preview" onclick="window.open('${p}')">`).join('')}
                </div>
            `;
            document.getElementById('nsModal').style.display = 'block';
        }

        function generateQRCode() {
            const dept = document.getElementById('qrDept').value;
            const loc = document.getElementById('qrLoc').value;
            const url = `${window.location.origin}${window.location.pathname}?dept=${encodeURIComponent(dept)}&loc=${encodeURIComponent(loc)}`;
            const qrCont = document.getElementById('qrcode');
            qrCont.innerHTML = '';
            new QRCode(qrCont, url);
            document.getElementById('qrPreview').style.display = 'block';
            document.getElementById('qrLabel').textContent = dept + ' - ' + loc;
        }

        function showPage(id) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(id + 'Page').classList.add('active');
        }

        function updateLastSyncTime() {
            const last = localStorage.getItem('farmstil_last_sync');
            document.getElementById('lastSyncTime').textContent = last ? new Date(last).toLocaleString() : '–ù–∏–∫–æ–≥–¥–∞';
        }

        function saveSettings() {
            localStorage.setItem('farmstil_google_url', document.getElementById('scriptUrl').value);
            alert('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');
        }

        function closeModal() { document.getElementById('nsModal').style.display = 'none'; }

        window.onload = () => {
            const params = new URLSearchParams(window.location.search);
            if(params.has('dept')) {
                document.getElementById('adminApp').style.display = 'none';
                document.getElementById('workerInterface').style.display = 'block';
                showWorkerFormFromURL(params.get('dept'), params.get('loc'));
            } else {
                document.getElementById('scriptUrl').value = localStorage.getItem('farmstil_google_url') || '';
                loadNSList();
            }
        };
    </script>
</body>
</html>

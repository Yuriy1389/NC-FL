<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–§–ê–†–ú–°–¢–ò–õ - –°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è–º–∏</title>
    <!-- –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –¥–ª—è QR-–∫–æ–¥–æ–≤ -->
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <style>
        /* [–í–°–ï –°–¢–ò–õ–ò –û–°–¢–ê–Æ–¢–°–Ø –¢–ê–ö–ò–ú–ò –ñ–ï] */
        /* ... –≤—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å—Ç–∏–ª–∏ ... */
    </style>
</head>
<body>
    <!-- [–í–°–Ø HTML –°–¢–†–£–ö–¢–£–†–ê –û–°–¢–ê–ï–¢–°–Ø –¢–ê–ö–û–ô –ñ–ï] -->
    <!-- ... –≤—Å—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∞—è HTML —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ ... -->

    <script>
        // ============================================
        // –ö–û–ù–°–¢–ê–ù–¢–´ –ò –ù–ê–°–¢–†–û–ô–ö–ò
        // ============================================
        const WEB3FORMS_ACCESS_KEY = '68e70096-0aed-4fd2-ba43-a9f06163e05b';
        const WEB3FORMS_API_URL = 'https://api.web3forms.com/submit';
        
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let currentQRData = null;
        let photos = [];
        let currentNSFilter = 'all';
        let speechRecognition = null;
        let isListening = false;
        let currentEditingNS = null;
        let selectedStatus = 'checking';
        
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
        const isAndroid = /Android/.test(navigator.userAgent);
        
        // ============================================
        // –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –°–ò–°–¢–ï–ú–´
        // ============================================
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ –°–∏—Å—Ç–µ–º–∞ –§–ê–†–ú–°–¢–ò–õ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è...');
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è —Ä–µ—á–∏
            initSpeechRecognition();
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∂–∏–º–∞
            checkMode();
            
            // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
            loadDirectories();
            updateStats();
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–æ–≤
            initDirectories();
            
            console.log('‚úÖ –°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ —Ä–∞–±–æ—Ç–µ');
        });
        
        function initDirectories() {
            if (!localStorage.getItem('farmstil_employees')) {
                const defaultEmployees = [
                    { name: "–ò–≤–∞–Ω–æ–≤ –ò.–ò.", position: "–ú–∞—Å—Ç–µ—Ä —Ü–µ—Ö–∞" },
                    { name: "–ü–µ—Ç—Ä–æ–≤ –ü.–ü.", position: "–ò–Ω–∂–µ–Ω–µ—Ä" },
                    { name: "–°–∏–¥–æ—Ä–æ–≤ –°.–°.", position: "–¢–µ—Ö–Ω–æ–ª–æ–≥" }
                ];
                localStorage.setItem('farmstil_employees', JSON.stringify(defaultEmployees));
            }
            
            if (!localStorage.getItem('farmstil_equipment')) {
                const defaultEquipment = [
                    { name: "–°—Ç–∞–Ω–æ–∫ –ß–ü–£", code: "–°–¢-001" },
                    { name: "–ü—Ä–µ—Å—Å –≥–∏–¥—Ä–∞–≤–ª–∏—á–µ—Å–∫–∏–π", code: "–ü–ì-002" },
                    { name: "–°–≤–∞—Ä–æ—á–Ω—ã–π –∞–ø–ø–∞—Ä–∞—Ç", code: "–°–ê-003" }
                ];
                localStorage.setItem('farmstil_equipment', JSON.stringify(defaultEquipment));
            }
            
            if (!localStorage.getItem('farmstil_ns')) {
                localStorage.setItem('farmstil_ns', '[]');
            }
            
            if (!localStorage.getItem('farmstil_qrcodes')) {
                localStorage.setItem('farmstil_qrcodes', '[]');
            }
        }
        
        // ============================================
        // –ì–û–õ–û–°–û–í–û–ô –í–í–û–î - –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô –î–õ–Ø IPHONE
        // ============================================
        function initSpeechRecognition() {
            console.log('üé§ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è —Ä–µ—á–∏...');
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                console.warn('‚ö†Ô∏è –ë—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ä–µ—á–∏');
                showNotification('–ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤ —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ', 'warning');
                return;
            }
            
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            
            try {
                speechRecognition = new SpeechRecognition();
                
                // –û–°–ù–û–í–ù–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –î–õ–Ø IPHONE:
                // –î–ª—è iOS –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥—Ä—É–≥–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
                if (isIOS) {
                    console.log('üì± iOS: –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ –¥–ª—è iPhone');
                    speechRecognition.continuous = true; // –î–ª—è iOS –ª—É—á—à–µ continuous
                    speechRecognition.interimResults = true; // –ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
                    speechRecognition.maxAlternatives = 3; // –ë–æ–ª—å—à–µ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤
                } else {
                    speechRecognition.continuous = false;
                    speechRecognition.interimResults = false;
                    speechRecognition.maxAlternatives = 1;
                }
                
                speechRecognition.lang = 'ru-RU';
                
                // –°–æ–±—ã—Ç–∏—è
                speechRecognition.onstart = function() {
                    isListening = true;
                    console.log('üé§ –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ä–µ—á–∏ –Ω–∞—á–∞–ª–æ—Å—å');
                    showNotification('–ì–æ–≤–æ—Ä–∏—Ç–µ —Å–µ–π—á–∞—Å...', 'info');
                    updateVoiceButton();
                };
                
                speechRecognition.onresult = function(event) {
                    let finalTranscript = '';
                    let interimTranscript = '';
                    
                    // –°–æ–±–∏—Ä–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        const transcript = event.results[i][0].transcript;
                        if (event.results[i].isFinal) {
                            finalTranscript += transcript;
                        } else {
                            interimTranscript += transcript;
                        }
                    }
                    
                    // –î–ª—è iOS –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
                    if (isIOS && interimTranscript) {
                        console.log('üì± iOS –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:', interimTranscript);
                    }
                    
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                    if (finalTranscript) {
                        console.log('‚úÖ –†–∞—Å–ø–æ–∑–Ω–∞–Ω–æ:', finalTranscript);
                        
                        // –û–ß–ò–°–¢–ö–ê –¢–ï–ö–°–¢–ê –û–¢ –û–ë–†–´–í–ö–û–í –§–†–ê–ó
                        let cleanedText = cleanVoiceText(finalTranscript);
                        
                        const descriptionField = document.getElementById('description');
                        if (descriptionField && cleanedText) {
                            // –î–æ–±–∞–≤–ª—è–µ–º –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–º—É —Ç–µ–∫—Å—Ç—É
                            if (descriptionField.value) {
                                descriptionField.value += ' ' + cleanedText;
                            } else {
                                descriptionField.value = cleanedText;
                            }
                            showNotification('–¢–µ–∫—Å—Ç –¥–æ–±–∞–≤–ª–µ–Ω', 'success');
                        }
                    }
                };
                
                speechRecognition.onerror = function(event) {
                    console.error('‚ùå –û—à–∏–±–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è:', event.error);
                    isListening = false;
                    updateVoiceButton();
                    
                    // –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è iOS
                    if (isIOS) {
                        if (event.error === 'not-allowed') {
                            showNotification('–î–ª—è –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ –≤–≤–æ–¥–∞ –Ω–∞ iPhone –Ω—É–∂–Ω–æ —Ä–∞–∑—Ä–µ—à–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É:<br>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ > Safari > –ú–∏–∫—Ä–æ—Ñ–æ–Ω', 'error');
                        } else if (event.error === 'audio-capture') {
                            showNotification('–ú–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞.', 'error');
                        } else {
                            showNotification('–û—à–∏–±–∫–∞ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ –≤–≤–æ–¥–∞ –Ω–∞ iPhone. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.', 'error');
                        }
                    } else {
                        if (event.error === 'not-allowed') {
                            showNotification('–†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞', 'error');
                        } else if (event.error === 'no-speech') {
                            showNotification('–†–µ—á—å –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.', 'warning');
                        } else {
                            showNotification('–û—à–∏–±–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è —Ä–µ—á–∏: ' + event.error, 'error');
                        }
                    }
                };
                
                speechRecognition.onend = function() {
                    console.log('üé§ –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ä–µ—á–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–æ');
                    isListening = false;
                    updateVoiceButton();
                    
                    // –î–ª—è iOS –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º –µ—Å–ª–∏ –±—ã–ª–æ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–µ
                    if (isIOS && isListening) {
                        setTimeout(() => {
                            try {
                                speechRecognition.start();
                            } catch (e) {
                                console.log('üì± iOS: –ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ');
                            }
                        }, 100);
                    }
                };
                
                console.log('‚úÖ –ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
                
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è SpeechRecognition:', error);
                showNotification('–ù–µ —É–¥–∞–ª–æ—Å—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –≥–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥', 'error');
            }
        }
        
        // –§–£–ù–ö–¶–ò–Ø –û–ß–ò–°–¢–ö–ò –¢–ï–ö–°–¢–ê –û–¢ –û–ë–†–´–í–ö–û–í
        function cleanVoiceText(text) {
            if (!text) return '';
            
            // –£–¥–∞–ª—è–µ–º —Ü–∏—Ñ—Ä—ã –≤ –Ω–∞—á–∞–ª–µ —Ç–∏–ø–∞ "1 2 3 4 5"
            let cleaned = text.replace(/^[\d\s]+/, '');
            
            // –£–±–∏—Ä–∞–µ–º –ø–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è —Å–ª–æ–≤–∞
            const words = cleaned.split(' ');
            const uniqueWords = [];
            for (let i = 0; i < words.length; i++) {
                if (words[i] !== words[i-1]) {
                    uniqueWords.push(words[i]);
                }
            }
            cleaned = uniqueWords.join(' ');
            
            // –£–¥–∞–ª—è–µ–º —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –æ–±—Ä—ã–≤–∫–∏ "1 2 3 4 5 –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç"
            cleaned = cleaned.replace(/^(\d+\s+){2,}\d+\s+/, '');
            
            return cleaned.trim();
        }
        
        function startVoiceInput() {
            console.log('üé§ –ó–∞–ø—É—Å–∫ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ –≤–≤–æ–¥–∞...');
            
            if (!speechRecognition) {
                showNotification('–ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤ —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ', 'error');
                return;
            }
            
            if (isListening) {
                // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–ø–∏—Å—å
                try {
                    speechRecognition.stop();
                    showNotification('–ó–∞–ø–∏—Å—å –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞', 'info');
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏:', error);
                }
            } else {
                try {
                    // –î–ª—è iOS —Å–Ω–∞—á–∞–ª–∞ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –µ—Å–ª–∏ —É–∂–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
                    if (isIOS) {
                        try {
                            speechRecognition.stop();
                        } catch (e) {
                            // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏
                        }
                        setTimeout(() => {
                            speechRecognition.start();
                        }, 200);
                    } else {
                        speechRecognition.start();
                    }
                } catch (error) {
                    console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è:', error);
                    showNotification('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è.', 'error');
                }
            }
        }
        
        function updateVoiceButton() {
            const voiceBtns = document.querySelectorAll('.btn-warning');
            voiceBtns.forEach(btn => {
                if (btn.textContent.includes('–ì–æ–ª–æ—Å–æ–º') || btn.textContent.includes('–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å')) {
                    if (isListening) {
                        btn.innerHTML = 'üõë –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å';
                        btn.style.background = '#dc3545';
                        btn.style.color = 'white';
                    } else {
                        btn.innerHTML = 'üé§ –ì–æ–ª–æ—Å–æ–º';
                        btn.style.background = '#ffc107';
                        btn.style.color = '#212529';
                    }
                }
            });
        }
        
        // ============================================
        // –û–°–ù–û–í–ù–´–ï –§–£–ù–ö–¶–ò–ò - –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ï
        // ============================================
        function showPage(pageId) {
            // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            // –î–µ–∞–∫—Ç–∏–≤–∏—Ä—É–µ–º –≤—Å–µ –∫–Ω–æ–ø–∫–∏ –º–µ–Ω—é
            document.querySelectorAll('.menu-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω—É–∂–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
            const page = document.getElementById(pageId + 'Page');
            if (page) {
                page.classList.add('active');
                
                // –ù–∞—Ö–æ–¥–∏–º –∏ –∞–∫—Ç–∏–≤–∏—Ä—É–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é –∫–Ω–æ–ø–∫—É –º–µ–Ω—é
                const pageIndex = ['generateQR', 'listNS', 'directories', 'admin'].indexOf(pageId);
                const buttons = document.querySelectorAll('.menu-btn');
                if (buttons[pageIndex]) {
                    buttons[pageIndex].classList.add('active');
                }
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
                switch(pageId) {
                    case 'listNS': 
                        loadNSList(currentNSFilter); 
                        break;
                    case 'directories': 
                        loadDirectories(); 
                        break;
                    case 'admin': 
                        updateStats(); 
                        break;
                }
            }
        }
        
        function showNotification(message, type = 'success', duration = 3000) {
            const notification = document.getElementById('notification');
            if (!notification) return;
            
            notification.textContent = message;
            notification.style.borderLeftColor = {
                success: '#28a745',
                error: '#dc3545',
                warning: '#ffc107',
                info: '#17a2b8'
            }[type] || '#28a745';
            
            notification.style.display = 'block';
            setTimeout(() => {
                notification.style.display = 'none';
            }, duration);
        }
        
        // ============================================
        // –ü–†–û–í–ï–†–ö–ê –†–ï–ñ–ò–ú–ê –†–ê–ë–û–¢–´
        // ============================================
        function checkMode() {
            const urlParams = new URLSearchParams(window.location.search);
            const qrCode = urlParams.get('qrcode');
            
            console.log('üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ URL:', window.location.search);
            console.log('üîç QR –∫–æ–¥ –∏–∑ URL:', qrCode);
            
            if (qrCode) {
                // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –≤ —Ä–µ–∂–∏–º —Ä–∞–±–æ—á–µ–≥–æ
                document.getElementById('adminMode').style.display = 'none';
                document.getElementById('workerMode').style.display = 'block';
                
                // –î–ª—è iPhone –¥–æ–±–∞–≤–ª—è–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
                if (isIOS) {
                    setTimeout(() => {
                        const formDiv = document.getElementById('workerForm');
                        if (formDiv) {
                            const warning = document.createElement('div');
                            warning.className = 'ios-warning';
                            warning.innerHTML = `
                                <strong>üì± –î–ª—è iPhone:</strong>
                                <p>1. –ù–∞–∂–º–∏—Ç–µ "üé§ –ì–æ–ª–æ—Å–æ–º" –¥–ª—è –Ω–∞—á–∞–ª–∞ –∑–∞–ø–∏—Å–∏</p>
                                <p>2. –ì–æ–≤–æ—Ä–∏—Ç–µ —á–µ—Ç–∫–æ –∏ –Ω–µ —Å–ø–µ—à–∞</p>
                                <p>3. –ù–∞–∂–º–∏—Ç–µ "üõë –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å" –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è</p>
                                <p>4. –ï—Å–ª–∏ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç - –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É –≤ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ > Safari</p>
                            `;
                            formDiv.prepend(warning);
                        }
                    }, 100);
                }
                
                // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º QR-–∫–æ–¥
                processQRCode(qrCode);
            } else {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–¥–º–∏–Ω—Å–∫–∏–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
                document.getElementById('adminMode').style.display = 'block';
                document.getElementById('workerMode').style.display = 'none';
            }
        }
        
        function processQRCode(qrCode) {
            console.log('üîç –û–±—Ä–∞–±–æ—Ç–∫–∞ QR-–∫–æ–¥–∞:', qrCode);
            
            // –î–µ–∫–æ–¥–∏—Ä—É–µ–º –¥–ª—è iOS
            let decodedQR = qrCode;
            if (isIOS) {
                try {
                    decodedQR = decodeURIComponent(qrCode);
                    console.log('üì± iOS: –î–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã–π QR:', decodedQR);
                } catch (e) {
                    console.log('üì± iOS: –ù–µ —É–¥–∞–ª–æ—Å—å –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞—Ç—å QR');
                }
            }
            
            // –ò—â–µ–º QR –≤ –±–∞–∑–µ
            const qrcodes = JSON.parse(localStorage.getItem('farmstil_qrcodes') || '[]');
            console.log('üìã QR –∫–æ–¥—ã –≤ –±–∞–∑–µ:', qrcodes.length);
            
            let qrData = null;
            for (const qr of qrcodes) {
                if (qr.code === decodedQR || qr.code === qrCode) {
                    qrData = qr;
                    break;
                }
            }
            
            if (qrData) {
                console.log('‚úÖ –ù–∞–π–¥–µ–Ω QR –≤ –±–∞–∑–µ:', qrData);
                showWorkerForm(qrData);
            } else {
                console.log('‚ö†Ô∏è QR –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ');
                showWorkerFormManual(decodedQR);
            }
        }
        
        // ============================================
        // –†–ê–ë–û–ß–ò–ô –†–ï–ñ–ò–ú - –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô
        // ============================================
        function showWorkerForm(qrData) {
            const employeeOptions = getEmployeeOptions();
            const equipmentOptions = getEquipmentOptions();
            
            const formHTML = `
                <form class="worker-form" id="workerFormElement" onsubmit="event.preventDefault(); submitWorkerForm();">
                    <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∏–∑ QR-–∫–æ–¥–∞ -->
                    <div class="qr-info-box">
                        <h4 style="color: #0d47a1; margin-top: 0;">üìç –î–∞–Ω–Ω—ã–µ –∏–∑ QR-–∫–æ–¥–∞:</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <div><strong>–ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ:</strong><br>${qrData.department || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</div>
                            <div><strong>–ú–µ—Å—Ç–æ:</strong><br>${qrData.location || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</div>
                            ${qrData.responsible ? `<div style="grid-column: 1 / -1;"><strong>–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π:</strong> ${qrData.responsible}</div>` : ''}
                        </div>
                    </div>
                    
                    <h3 style="color: #1e3c72; margin-bottom: 15px;">üìù –ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ñ–æ—Ä–º—É –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è</h3>
                    
                    <!-- –û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–ª—è -->
                    <div class="form-group">
                        <label>üìÖ –î–∞—Ç–∞ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è:</label>
                        <input type="date" id="detectionDate" value="${new Date().toISOString().split('T')[0]}" required>
                    </div>
                    
                    <div class="form-group">
                        <label>üë§ –í–∞—à–µ –§–ò–û:</label>
                        <select id="applicantSelect" onchange="fillApplicantData()" required>
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å–µ–±—è</option>
                            ${employeeOptions}
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>‚úçÔ∏è –§–ò–û –∑–∞—è–≤–∏—Ç–µ–ª—è:</label>
                        <input type="text" id="applicant" placeholder="–í–∞—à–µ –§–ò–û" required>
                    </div>
                    
                    <div class="form-group">
                        <label>üè≠ –û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ:</label>
                        <select id="productSelect" onchange="fillProductData()">
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ</option>
                            ${equipmentOptions}
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>üìù –ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è:</label>
                        <input type="text" id="productName" placeholder="–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è">
                    </div>
                    
                    <div class="form-group">
                        <label>üî¢ –ò–Ω–≤–µ–Ω—Ç–∞—Ä–Ω—ã–π –Ω–æ–º–µ—Ä:</label>
                        <input type="text" id="productCode" placeholder="–ò–Ω–≤–µ–Ω—Ç–∞—Ä–Ω—ã–π –Ω–æ–º–µ—Ä">
                    </div>
                    
                    <!-- –û–ø–∏—Å–∞–Ω–∏–µ —Å –≥–æ–ª–æ—Å–æ–≤—ã–º –≤–≤–æ–¥–æ–º -->
                    <div class="form-group">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <label>üìã –û–ø–∏—Å–∞–Ω–∏–µ –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è:</label>
                            <button type="button" class="btn btn-warning" onclick="startVoiceInput()" style="padding: 8px 12px; font-size: 14px;">
                                üé§ –ì–æ–ª–æ—Å–æ–º
                            </button>
                        </div>
                        <textarea id="description" rows="4" placeholder="–û–ø–∏—à–∏—Ç–µ –ø—Ä–æ–±–ª–µ–º—É –ø–æ–¥—Ä–æ–±–Ω–æ..." required></textarea>
                    </div>
                    
                    <!-- –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ -->
                    <div class="form-group">
                        <label>üì∑ –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ (–¥–æ 3 —à—Ç—É–∫):</label>
                        <div class="photo-upload-area" onclick="document.getElementById('photoInput').click()">
                            <div style="font-size: 40px; margin-bottom: 10px;">üì∏</div>
                            <div style="font-weight: bold; color: #28a745;">–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ</div>
                            <input type="file" id="photoInput" accept="image/*" multiple style="display: none;" onchange="handlePhotoUpload(event)">
                        </div>
                        <div class="preview-container" id="photoPreview"></div>
                    </div>
                    
                    <!-- –ö–Ω–æ–ø–∫–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ -->
                    <div style="display: flex; gap: 10px; margin-top: 25px;">
                        <button type="submit" class="btn btn-success" style="flex: 2;">
                            üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É
                        </button>
                        <button type="button" class="btn btn-danger" onclick="goToAdminMode()" style="flex: 1;">
                            ‚ùå –û—Ç–º–µ–Ω–∞
                        </button>
                    </div>
                    
                    <!-- –°–∫—Ä—ã—Ç—ã–µ –ø–æ–ª—è —Å –¥–∞–Ω–Ω—ã–º–∏ QR -->
                    <input type="hidden" id="hiddenDepartment" value="${qrData.department || ''}">
                    <input type="hidden" id="hiddenLocation" value="${qrData.location || ''}">
                    <input type="hidden" id="hiddenQRCode" value="${qrData.code || ''}">
                </form>
            `;
            
            document.getElementById('workerForm').innerHTML = formHTML;
            currentQRData = qrData;
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—É—é –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é –¥–ª—è iOS
            if (isIOS) {
                const form = document.getElementById('workerFormElement');
                const iosTip = document.createElement('div');
                iosTip.className = 'ios-warning';
                iosTip.style.marginTop = '20px';
                iosTip.innerHTML = `
                    <strong>üí° –ü–æ–¥—Å–∫–∞–∑–∫–∞ –¥–ª—è –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ –≤–≤–æ–¥–∞ –Ω–∞ iPhone:</strong>
                    <p>1. –ù–∞–∂–º–∏—Ç–µ "üé§ –ì–æ–ª–æ—Å–æ–º" –∏ —Ä–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É</p>
                    <p>2. –î–æ–∂–¥–∏—Ç–µ—Å—å –ø–æ—è–≤–ª–µ–Ω–∏—è –Ω–∞–¥–ø–∏—Å–∏ "–ì–æ–≤–æ—Ä–∏—Ç–µ —Å–µ–π—á–∞—Å..."</p>
                    <p>3. –ì–æ–≤–æ—Ä–∏—Ç–µ —á–µ—Ç–∫–æ, –¥–µ—Ä–∂–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω –±–ª–∏–∂–µ –∫ —Ä—Ç—É</p>
                    <p>4. –ù–∞–∂–º–∏—Ç–µ "üõë –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å" –∫–æ–≥–¥–∞ –∑–∞–∫–æ–Ω—á–∏—Ç–µ</p>
                `;
                form.appendChild(iosTip);
            }
        }
        
        function showWorkerFormManual(qrCode) {
            const employeeOptions = getEmployeeOptions();
            const equipmentOptions = getEquipmentOptions();
            
            const formHTML = `
                <form class="worker-form" id="workerFormElement" onsubmit="event.preventDefault(); submitWorkerFormManual();">
                    <!-- –†—É—á–Ω–æ–π –≤–≤–æ–¥ –¥–∞–Ω–Ω—ã—Ö -->
                    <div class="manual-input-box">
                        <h4 style="color: #856404; margin-top: 0;">‚ö†Ô∏è QR-–∫–æ–¥ –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω</h4>
                        <p>–í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –≤—Ä—É—á–Ω—É—é:</p>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>–ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ:</label>
                                <input type="text" id="manualDepartment" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ" required>
                            </div>
                            <div class="form-group">
                                <label>–ú–µ—Å—Ç–æ:</label>
                                <input type="text" id="manualLocation" placeholder="–í–≤–µ–¥–∏—Ç–µ –º–µ—Å—Ç–æ" required>
                            </div>
                        </div>
                        <div style="font-size: 12px; color: #666; margin-top: 10px;">
                            QR-–∫–æ–¥: ${qrCode || '–Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω'}
                        </div>
                    </div>
                    
                    <h3 style="color: #1e3c72; margin-bottom: 15px;">üìù –ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ñ–æ—Ä–º—É –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è</h3>
                    
                    <!-- –û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–ª—è -->
                    <div class="form-group">
                        <label>üìÖ –î–∞—Ç–∞ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è:</label>
                        <input type="date" id="detectionDate" value="${new Date().toISOString().split('T')[0]}" required>
                    </div>
                    
                    <div class="form-group">
                        <label>üë§ –í–∞—à–µ –§–ò–û:</label>
                        <select id="applicantSelect" onchange="fillApplicantData()" required>
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å–µ–±—è</option>
                            ${employeeOptions}
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>‚úçÔ∏è –§–ò–û –∑–∞—è–≤–∏—Ç–µ–ª—è:</label>
                        <input type="text" id="applicant" placeholder="–í–∞—à–µ –§–ò–û" required>
                    </div>
                    
                    <div class="form-group">
                        <label>üè≠ –û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ:</label>
                        <select id="productSelect" onchange="fillProductData()">
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ</option>
                            ${equipmentOptions}
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>üìù –ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è:</label>
                        <input type="text" id="productName" placeholder="–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è">
                    </div>
                    
                    <div class="form-group">
                        <label>üî¢ –ò–Ω–≤–µ–Ω—Ç–∞—Ä–Ω—ã–π –Ω–æ–º–µ—Ä:</label>
                        <input type="text" id="productCode" placeholder="–ò–Ω–≤–µ–Ω—Ç–∞—Ä–Ω—ã–π –Ω–æ–º–µ—Ä">
                    </div>
                    
                    <!-- –û–ø–∏—Å–∞–Ω–∏–µ —Å –≥–æ–ª–æ—Å–æ–≤—ã–º –≤–≤–æ–¥–æ–º -->
                    <div class="form-group">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <label>üìã –û–ø–∏—Å–∞–Ω–∏–µ –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è:</label>
                            <button type="button" class="btn btn-warning" onclick="startVoiceInput()" style="padding: 8px 12px; font-size: 14px;">
                                üé§ –ì–æ–ª–æ—Å–æ–º
                            </button>
                        </div>
                        <textarea id="description" rows="4" placeholder="–û–ø–∏—à–∏—Ç–µ –ø—Ä–æ–±–ª–µ–º—É –ø–æ–¥—Ä–æ–±–Ω–æ..." required></textarea>
                    </div>
                    
                    <!-- –ö–Ω–æ–ø–∫–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ -->
                    <div style="display: flex; gap: 10px; margin-top: 25px;">
                        <button type="submit" class="btn btn-success" style="flex: 2;">
                            üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É
                        </button>
                        <button type="button" class="btn btn-danger" onclick="goToAdminMode()" style="flex: 1;">
                            ‚ùå –û—Ç–º–µ–Ω–∞
                        </button>
                    </div>
                </form>
            `;
            
            document.getElementById('workerForm').innerHTML = formHTML;
            currentQRData = null;
        }
        
        function fillApplicantData() {
            const select = document.getElementById('applicantSelect');
            if (select && select.value) {
                const [name] = select.value.split('|');
                const applicantField = document.getElementById('applicant');
                if (applicantField) {
                    applicantField.value = name;
                }
            }
        }
        
        function fillProductData() {
            const select = document.getElementById('productSelect');
            if (select && select.value) {
                const [name, code] = select.value.split('|');
                const productNameField = document.getElementById('productName');
                const productCodeField = document.getElementById('productCode');
                
                if (productNameField) productNameField.value = name;
                if (productCodeField) productCodeField.value = code;
            }
        }
        
        function handlePhotoUpload(event) {
            const files = event.target.files;
            const preview = document.getElementById('photoPreview');
            
            if (!preview) return;
            
            // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ: –º–∞–∫—Å–∏–º—É–º 3 —Ñ–æ—Ç–æ –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –æ—à–∏–±–æ–∫ email
            const fileCount = Math.min(files.length, 3);
            
            // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ —Ñ–æ—Ç–æ
            photos = [];
            preview.innerHTML = '';
            
            for (let i = 0; i < fileCount; i++) {
                const file = files[i];
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    const photoDiv = document.createElement('div');
                    photoDiv.className = 'photo-preview';
                    photoDiv.innerHTML = `
                        <img src="${e.target.result}" alt="–§–æ—Ç–æ ${i + 1}">
                        <button onclick="removePhoto(${i})" style="
                            position: absolute; top: 5px; right: 5px; 
                            background: rgba(220, 53, 69, 0.9); color: white; 
                            border: none; border-radius: 50%; width: 24px; 
                            height: 24px; font-size: 14px; cursor: pointer;
                        ">√ó</button>
                    `;
                    preview.appendChild(photoDiv);
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–∞–∫ Base64
                    photos.push({
                        name: file.name,
                        data: e.target.result,
                        type: file.type,
                        size: file.size
                    });
                };
                
                reader.readAsDataURL(file);
            }
            
            if (fileCount > 0) {
                showNotification(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${fileCount} —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π`, 'success');
            }
        }
        
        function removePhoto(index) {
            photos.splice(index, 1);
            updatePhotoPreview();
        }
        
        function updatePhotoPreview() {
            const preview = document.getElementById('photoPreview');
            if (!preview) return;
            
            preview.innerHTML = '';
            
            photos.forEach((photo, i) => {
                const photoDiv = document.createElement('div');
                photoDiv.className = 'photo-preview';
                photoDiv.innerHTML = `
                    <img src="${photo.data}" alt="–§–æ—Ç–æ ${i + 1}">
                    <button onclick="removePhoto(${i})" style="
                        position: absolute; top: 5px; right: 5px; 
                        background: rgba(220, 53, 69, 0.9); color: white; 
                        border: none; border-radius: 50%; width: 24px; 
                        height: 24px; font-size: 14px; cursor: pointer;
                    ">√ó</button>
                `;
                preview.appendChild(photoDiv);
            });
        }
        
        // ============================================
        // –û–¢–ü–†–ê–í–ö–ê –§–û–†–ú–´ - –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø
        // ============================================
        async function submitWorkerForm() {
            try {
                console.log('üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º—ã —Ä–∞–±–æ—á–µ–≥–æ...');
                
                // –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
                const detectionDate = document.getElementById('detectionDate').value;
                const applicant = document.getElementById('applicant').value;
                const productName = document.getElementById('productName').value;
                const productCode = document.getElementById('productCode').value;
                const description = document.getElementById('description').value;
                const department = document.getElementById('hiddenDepartment').value;
                const location = document.getElementById('hiddenLocation').value;
                const qrCode = document.getElementById('hiddenQRCode').value;
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π
                if (!applicant.trim()) {
                    showNotification('–í–≤–µ–¥–∏—Ç–µ –§–ò–û –∑–∞—è–≤–∏—Ç–µ–ª—è', 'error');
                    return;
                }
                
                if (!description.trim()) {
                    showNotification('–í–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è', 'error');
                    return;
                }
                
                // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–æ–º–µ—Ä–∞ –ù–°
                const nsNumber = 'HC-' + Math.floor(Math.random() * 9000 + 1000) + '-' + new Date().getFullYear();
                
                // –°–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö
                const nsData = {
                    id: 'ns_' + Date.now(),
                    nsNumber: nsNumber,
                    detectionDate: detectionDate,
                    department: department,
                    location: location,
                    applicant: applicant,
                    productName: productName,
                    productCode: productCode,
                    description: description,
                    photos: [], // –§–æ—Ç–æ –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
                    photoCount: photos.length,
                    status: 'checking',
                    created: new Date().toISOString(),
                    qrCode: qrCode
                };
                
                console.log('–î–∞–Ω–Ω—ã–µ –ù–° –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', nsData);
                
                // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ù–°
                const nsList = JSON.parse(localStorage.getItem('farmstil_ns') || '[]');
                nsList.push(nsData);
                localStorage.setItem('farmstil_ns', JSON.stringify(nsList));
                
                // –û—Ç–ø—Ä–∞–≤–∫–∞ email —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
                await sendEmailNotification(nsData);
                
                // –ü–æ–∫–∞–∑–∞—Ç—å —É—Å–ø–µ—Ö
                showSuccessScreen(nsData);
                
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏:', error);
                showNotification('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞—è–≤–∫–∏: ' + error.message, 'error');
            }
        }
        
        async function submitWorkerFormManual() {
            try {
                const detectionDate = document.getElementById('detectionDate').value;
                const applicant = document.getElementById('applicant').value;
                const productName = document.getElementById('productName').value;
                const productCode = document.getElementById('productCode').value;
                const description = document.getElementById('description').value;
                const department = document.getElementById('manualDepartment').value;
                const location = document.getElementById('manualLocation').value;
                
                if (!department || !location) {
                    showNotification('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –∏ –º–µ—Å—Ç–æ', 'error');
                    return;
                }
                
                if (!applicant.trim()) {
                    showNotification('–í–≤–µ–¥–∏—Ç–µ –§–ò–û –∑–∞—è–≤–∏—Ç–µ–ª—è', 'error');
                    return;
                }
                
                if (!description.trim()) {
                    showNotification('–í–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è', 'error');
                    return;
                }
                
                const nsNumber = 'HC-' + Math.floor(Math.random() * 9000 + 1000) + '-' + new Date().getFullYear();
                
                const nsData = {
                    id: 'ns_' + Date.now(),
                    nsNumber: nsNumber,
                    detectionDate: detectionDate,
                    department: department,
                    location: location,
                    applicant: applicant,
                    productName: productName,
                    productCode: productCode,
                    description: description,
                    photos: [],
                    photoCount: photos.length,
                    status: 'checking',
                    created: new Date().toISOString(),
                    qrCode: 'manual'
                };
                
                const nsList = JSON.parse(localStorage.getItem('farmstil_ns') || '[]');
                nsList.push(nsData);
                localStorage.setItem('farmstil_ns', JSON.stringify(nsList));
                
                await sendEmailNotification(nsData);
                showSuccessScreen(nsData);
                
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞:', error);
                showNotification('–û—à–∏–±–∫–∞: ' + error.message, 'error');
            }
        }
        
        function showSuccessScreen(nsData) {
            const successHTML = `
                <div style="text-align: center; padding: 30px;">
                    <div style="font-size: 60px; color: #28a745; margin-bottom: 20px;">‚úÖ</div>
                    <h2 style="color: #1e3c72; margin-bottom: 20px;">–ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–æ!</h2>
                    
                    <div class="info-box" style="max-width: 500px; margin: 0 auto 30px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; text-align: left;">
                            <div><strong>–ù–æ–º–µ—Ä –ù–°:</strong><br>${nsData.nsNumber}</div>
                            <div><strong>–°—Ç–∞—Ç—É—Å:</strong><br>–ù–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ</div>
                            <div><strong>–î–∞—Ç–∞:</strong><br>${new Date(nsData.detectionDate).toLocaleDateString('ru-RU')}</div>
                            <div><strong>–ó–∞—è–≤–∏—Ç–µ–ª—å:</strong><br>${nsData.applicant}</div>
                            <div style="grid-column: 1 / -1;"><strong>–ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ:</strong><br>${nsData.department}</div>
                            <div style="grid-column: 1 / -1;"><strong>–ú–µ—Å—Ç–æ:</strong><br>${nsData.location}</div>
                        </div>
                    </div>
                    
                    <!-- –û–°–ù–û–í–ù–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ö–Ω–æ–ø–∫–∞ —Å–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—ã–π –õ–ù —Å —Ç–µ–º –∂–µ QR -->
                    <div style="display: flex; gap: 10px; justify-content: center;">
                        <button class="btn btn-primary" onclick="createNewReportFromQR()" style="padding: 14px 28px;">
                            üìù –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –õ–ù
                        </button>
                        <button class="btn" onclick="goToAdminMode()" style="background: #6c757d; color: white; padding: 14px 28px;">
                            üè† –ù–∞ –≥–ª–∞–≤–Ω—É—é
                        </button>
                    </div>
                    
                    <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ QR –∫–æ–¥–µ –¥–ª—è –Ω–æ–≤–æ–≥–æ –õ–ù -->
                    <div style="margin-top: 20px; font-size: 14px; color: #666;">
                        <p>–î–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ –õ–ù –æ—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR-–∫–æ–¥ –µ—â–µ —Ä–∞–∑ –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –≤—ã—à–µ.</p>
                        ${currentQRData ? `<p><strong>–ö–æ–¥ QR:</strong> ${currentQRData.code}</p>` : ''}
                    </div>
                </div>
            `;
            
            document.getElementById('workerForm').innerHTML = successHTML;
            showNotification('‚úÖ –ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!', 'success');
        }
        
        // –û–°–ù–û–í–ù–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –õ–ù —Å —Ç–µ–º –∂–µ QR
        function createNewReportFromQR() {
            if (currentQRData && currentQRData.code) {
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º QR –¥–∞–Ω–Ω—ã–µ –≤ sessionStorage –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
                sessionStorage.setItem('lastQRCode', currentQRData.code);
                
                // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å —Ç–µ–º –∂–µ QR –∫–æ–¥–æ–º
                window.location.href = window.location.pathname + '?qrcode=' + encodeURIComponent(currentQRData.code);
            } else {
                // –ï—Å–ª–∏ –Ω–µ—Ç QR –¥–∞–Ω–Ω—ã—Ö, –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Ñ–æ—Ä–º—É
                window.location.href = window.location.pathname;
            }
        }
        
        // –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ –æ—Ç—á–µ—Ç–∞
        function createAnotherReport() {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π QR –∫–æ–¥
            const lastQRCode = sessionStorage.getItem('lastQRCode');
            if (lastQRCode) {
                window.location.href = window.location.pathname + '?qrcode=' + encodeURIComponent(lastQRCode);
            } else if (currentQRData && currentQRData.code) {
                window.location.href = window.location.pathname + '?qrcode=' + encodeURIComponent(currentQRData.code);
            } else {
                // –ï—Å–ª–∏ –Ω–µ—Ç QR, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é
                showQRScanInstruction();
            }
        }
        
        function showQRScanInstruction() {
            const scanHTML = `
                <div style="text-align: center; padding: 40px 20px;">
                    <div style="font-size: 60px; color: #1e3c72; margin-bottom: 20px;">üì±</div>
                    <h2 style="color: #1e3c72; margin-bottom: 20px;">–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –õ–ù</h2>
                    
                    <div class="info-box" style="max-width: 500px; margin: 0 auto 30px;">
                        <p><strong>–ß—Ç–æ–±—ã —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –ª–∏—Å—Ç –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è:</strong></p>
                        <ol style="text-align: left; margin: 15px 0; padding-left: 20px;">
                            <li>–û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR-–∫–æ–¥ –Ω–∞ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–∏</li>
                            <li>–ò–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –∫–æ–¥ QR –≤—Ä—É—á–Ω—É—é –Ω–∏–∂–µ</li>
                        </ol>
                        
                        <div style="margin-top: 20px;">
                            <input type="text" id="manualQrInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ QR" 
                                   style="width: 100%; padding: 12px; border: 2px solid #1e3c72; border-radius: 8px;">
                            <button class="btn btn-primary" onclick="useManualQRCode()" style="width: 100%; margin-top: 10px;">
                                üìù –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Å —ç—Ç–∏–º –∫–æ–¥–æ–º
                            </button>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 10px; justify-content: center;">
                        <button class="btn btn-primary" onclick="scanQRWithCamera()">
                            üì∑ –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å QR
                        </button>
                        <button class="btn" onclick="goToAdminMode()" style="background: #6c757d; color: white;">
                            üè† –ù–∞ –≥–ª–∞–≤–Ω—É—é
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('workerForm').innerHTML = scanHTML;
        }
        
        function useManualQRCode() {
            const qrCode = document.getElementById('manualQrInput').value.trim();
            if (qrCode) {
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–ª—è –±—É–¥—É—â–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
                sessionStorage.setItem('lastQRCode', qrCode);
                window.location.href = window.location.pathname + '?qrcode=' + encodeURIComponent(qrCode);
            } else {
                showNotification('–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ QR', 'error');
            }
        }
        
        function scanQRWithCamera() {
            // –ù–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö —ç—Ç–æ –æ—Ç–∫—Ä–æ–µ—Ç –∫–∞–º–µ—Ä—É
            showNotification('–ù–∞–≤–µ–¥–∏—Ç–µ –∫–∞–º–µ—Ä—É –Ω–∞ QR-–∫–æ–¥', 'info');
            // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∑–¥–µ—Å—å –±—ã–ª –±—ã –≤—ã–∑–æ–≤ API –∫–∞–º–µ—Ä—ã
        }
        
        function goToAdminMode() {
            // –û—á–∏—â–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π QR –∫–æ–¥
            sessionStorage.removeItem('lastQRCode');
            window.location.href = window.location.pathname;
        }
        
        // ============================================
        // EMAIL –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø - –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ï
        // ============================================
        async function sendEmailNotification(nsData) {
            try {
                console.log('üìß –û—Ç–ø—Ä–∞–≤–∫–∞ email —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è...');
                
                const settings = JSON.parse(localStorage.getItem('farmstil_email_settings') || '{}');
                const recipient = settings.managerEmail || 'finkart23@mail.ru';
                
                // –ö–†–ê–°–ò–í–ê–Ø –§–û–†–ú–ê EMAIL
                const emailBody = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <style>
        body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; max-width: 600px; margin: 0 auto; }
        .header { background: linear-gradient(135deg, #1e3c72, #2a5298); color: white; padding: 20px; text-align: center; border-radius: 10px 10px 0 0; }
        .content { padding: 25px; background: #f8f9fa; border-radius: 0 0 10px 10px; }
        .detail-box { background: white; padding: 15px; border-radius: 8px; margin: 15px 0; border-left: 4px solid #1e3c72; }
        .status { display: inline-block; background: #ffc107; color: #000; padding: 5px 15px; border-radius: 20px; font-weight: bold; font-size: 14px; }
        .footer { margin-top: 20px; padding-top: 15px; border-top: 1px solid #ddd; font-size: 12px; color: #666; }
        table { width: 100%; border-collapse: collapse; }
        td { padding: 8px 0; }
    </style>
</head>
<body>
    <div class="header">
        <h1 style="margin: 0; font-size: 24px;">üîî –§–ê–†–ú–°–¢–ò–õ</h1>
        <p style="margin: 5px 0 0; opacity: 0.9;">–ù–æ–≤–æ–µ –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ</p>
    </div>
    
    <div class="content">
        <h2 style="color: #1e3c72; margin-top: 0;">${nsData.nsNumber}</h2>
        
        <div class="detail-box">
            <table>
                <tr>
                    <td style="width: 40%; color: #666;"><strong>üìÖ –î–∞—Ç–∞:</strong></td>
                    <td>${new Date(nsData.detectionDate).toLocaleDateString('ru-RU')}</td>
                </tr>
                <tr>
                    <td style="color: #666;"><strong>üè≠ –ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ:</strong></td>
                    <td>${nsData.department}</td>
                </tr>
                <tr>
                    <td style="color: #666;"><strong>üìç –ú–µ—Å—Ç–æ:</strong></td>
                    <td>${nsData.location}</td>
                </tr>
                <tr>
                    <td style="color: #666;"><strong>üë§ –ó–∞—è–≤–∏—Ç–µ–ª—å:</strong></td>
                    <td>${nsData.applicant}</td>
                </tr>
                ${nsData.productName ? `
                <tr>
                    <td style="color: #666;"><strong>‚öôÔ∏è –û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ:</strong></td>
                    <td>${nsData.productName} ${nsData.productCode ? '(' + nsData.productCode + ')' : ''}</td>
                </tr>
                ` : ''}
                <tr>
                    <td style="color: #666;"><strong>üìä –°—Ç–∞—Ç—É—Å:</strong></td>
                    <td><span class="status">–ù–ê –ü–†–û–í–ï–†–ö–ï</span></td>
                </tr>
            </table>
        </div>
        
        <div style="background: white; padding: 15px; border-radius: 8px; margin: 15px 0;">
            <strong style="color: #666; display: block; margin-bottom: 8px;">üìã –û–ø–∏—Å–∞–Ω–∏–µ:</strong>
            <div style="padding: 12px; background: #f8f9fa; border-radius: 5px; border: 1px solid #e0e0e0;">
                ${nsData.description.replace(/\n/g, '<br>')}
            </div>
        </div>
        
        <div class="footer">
            <p>üìß –°–æ–∑–¥–∞–Ω–æ: ${new Date(nsData.created).toLocaleString('ru-RU')}</p>
            <p>üìç –ò—Å—Ç–æ—á–Ω–∏–∫: ${nsData.qrCode === 'manual' ? '–†—É—á–Ω–æ–π –≤–≤–æ–¥' : 'QR-–∫–æ–¥'}</p>
            <p>${nsData.photoCount > 0 ? `üì∑ –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏: ${nsData.photoCount} —à—Ç.` : 'üì∑ –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –Ω–µ –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω—ã'}</p>
            <p style="margin-top: 10px; font-style: italic;">–î–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥–µ—Ç–∞–ª–µ–π –ø–µ—Ä–µ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É –§–ê–†–ú–°–¢–ò–õ</p>
        </div>
    </div>
</body>
</html>
                `;
                
                const emailData = {
                    access_key: WEB3FORMS_ACCESS_KEY.trim(),
                    subject: `–ù–æ–≤–æ–µ –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ: ${nsData.nsNumber}`,
                    from_name: '–°–∏—Å—Ç–µ–º–∞ –§–ê–†–ú–°–¢–ò–õ',
                    to: recipient,
                    html: emailBody, // –ò—Å–ø–æ–ª—å–∑—É–µ–º HTML –≤–º–µ—Å—Ç–æ plain text
                    reply_to: recipient
                };
                
                // –û—Ç–ø—Ä–∞–≤–∫–∞ —á–µ—Ä–µ–∑ API
                const response = await fetch(WEB3FORMS_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(emailData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    console.log('‚úÖ Email —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ');
                    return true;
                } else {
                    console.error('–û—à–∏–±–∫–∞ Web3Forms:', result.message);
                    return false;
                }
                
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ email:', error);
                return false;
            }
        }
        
        // ============================================
        // [–í–°–ï –û–°–¢–ê–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò –û–°–¢–ê–Æ–¢–°–Ø –¢–ê–ö–ò–ú–ò –ñ–ï]
        // ============================================
        // ... –≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π ...
        
        // ============================================
        // –≠–ö–°–ü–û–†–¢ –§–£–ù–ö–¶–ò–ô
        // ============================================
        window.showPage = showPage;
        window.generateQRCode = generateQRCode;
        window.printQRCode = printQRCode;
        window.saveQRAsImage = saveQRAsImage;
        window.testQRCode = testQRCode;
        window.filterNS = filterNS;
        window.viewNSDetails = viewNSDetails;
        window.changeNSStatus = changeNSStatus;
        window.selectStatus = selectStatus;
        window.saveStatusChange = saveStatusChange;
        window.closeModal = closeModal;
        window.addEmployee = addEmployee;
        window.deleteEmployee = deleteEmployee;
        window.addEquipment = addEquipment;
        window.deleteEquipment = deleteEquipment;
        window.saveEmailSettings = saveEmailSettings;
        window.testEmailConnection = testEmailConnection;
        window.submitWorkerForm = submitWorkerForm;
        window.submitWorkerFormManual = submitWorkerFormManual;
        window.fillApplicantData = fillApplicantData;
        window.fillProductData = fillProductData;
        window.handlePhotoUpload = handlePhotoUpload;
        window.removePhoto = removePhoto;
        window.startVoiceInput = startVoiceInput;
        window.createNewReportFromQR = createNewReportFromQR;
        window.createAnotherReport = createAnotherReport;
        window.useManualQRCode = useManualQRCode;
        window.scanQRWithCamera = scanQRWithCamera;
        window.goToAdminMode = goToAdminMode;
        window.backupData = backupData;
        window.restoreData = restoreData;
        window.clearAllData = clearAllData;
    </script>
</body>
</html>

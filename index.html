<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–§–ê–†–ú–°–¢–ò–õ - –°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è–º–∏ ISO 13485</title>
    
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 24px;
            margin-bottom: 8px;
        }
        
        .header h2 {
            font-size: 14px;
            font-weight: normal;
            opacity: 0.9;
        }
        
        .menu {
            display: flex;
            background: linear-gradient(90deg, #4b6cb7 0%, #182848 100%);
            padding: 0;
            gap: 1px;
            flex-wrap: wrap;
        }
        
        .menu-btn {
            padding: 12px 15px;
            background: white;
            border: none;
            color: #1e3c72;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            flex: 1;
            min-width: 120px;
            font-size: 14px;
        }
        
        .menu-btn.active {
            background: #1e3c72;
            color: white;
        }
        
        .page {
            display: none;
            padding: 20px;
            min-height: 500px;
        }
        
        .page.active {
            display: block;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            width: 100%;
            margin-bottom: 15px;
        }
        
        label {
            margin-bottom: 6px;
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }
        
        input, select, textarea {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            width: 100%;
        }
        
        select {
            background: white url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%231e3c72' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e") no-repeat right 10px center;
            background-size: 16px;
        }
        
        .btn {
            padding: 14px 20px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin: 5px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
        }
        
        .btn-primary {
            background: #1e3c72;
            color: white;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-warning {
            background: #ffc107;
            color: #212529;
        }
        
        .btn-info {
            background: #17a2b8;
            color: white;
        }
        
        .notification {
            position: fixed;
            top: 10px;
            right: 10px;
            left: 10px;
            background: white;
            color: #333;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.15);
            display: none;
            z-index: 1000;
            border-left: 5px solid #28a745;
            text-align: center;
        }
        
        .notification.error { border-left-color: #dc3545; }
        .notification.warning { border-left-color: #ffc107; }
        .notification.info { border-left-color: #17a2b8; }
        
        .worker-container {
            width: 100%;
            margin: 20px auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        
        .worker-header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 25px;
            text-align: center;
        }
        
        .worker-content {
            padding: 20px;
        }
        
        .worker-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .photo-upload-area {
            border: 3px dashed #28a745;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            background: #f8fff8;
            cursor: pointer;
            margin: 15px 0;
        }
        
        .preview-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        
        .photo-preview {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid #ddd;
            height: 100px;
        }
        
        .photo-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .info-box {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            border-left: 5px solid #1e3c72;
            font-size: 14px;
        }
        
        .ln-card {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
            margin-bottom: 15px;
        }
        
        .ln-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .ln-number {
            font-weight: bold;
            color: #1e3c72;
            font-size: 16px;
        }
        
        .ln-status {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: bold;
            color: white;
        }
        
        .status-checking { background: #ffc107; }
        .status-analysis { background: #2196F3; }
        .status-correction { background: #9C27B0; color: white; }
        .status-execution { background: #FF5722; color: white; }
        .status-verification { background: #4CAF50; color: white; }
        .status-rework { background: #dc3545; }
        .status-closed { background: #607D8B; color: white; }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 25px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-title {
            font-size: 20px;
            color: #1e3c72;
            font-weight: bold;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }
        
        .status-badges {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin: 15px 0;
        }
        
        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            cursor: pointer;
            border: 2px solid transparent;
        }
        
        .status-badge.active {
            border-color: #1e3c72;
            font-weight: bold;
        }
        
        .qr-preview {
            text-align: center;
            padding: 20px;
            border: 3px dashed #1e3c72;
            border-radius: 15px;
            margin-top: 20px;
            background: #f8f9fa;
        }
        
        @media (min-width: 768px) {
            .form-grid {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 20px;
            }
            
            .btn {
                width: auto;
            }
        }
    </style>
</head>
<body>
    <div class="notification" id="notification"></div>
    
    <div class="modal" id="statusModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">–ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –ù–°</div>
                <button class="modal-close" onclick="closeModal()">√ó</button>
            </div>
            <div id="modalContent"></div>
        </div>
    </div>
    
    <div id="workerMode" style="display: none;">
        <div class="worker-container">
            <div class="worker-header">
                <h1>üìù –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è</h1>
                <p>–§–ê–†–ú–°–¢–ò–õ - –°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–∞—á–µ—Å—Ç–≤–æ–º</p>
            </div>
            <div class="worker-content">
                <div id="workerForm"></div>
            </div>
        </div>
    </div>
    
    <div id="adminMode">
        <div class="container">
            <div class="header">
                <h1>–§–ê–†–ú–°–¢–ò–õ - –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–∞—è –ø–∞–Ω–µ–ª—å</h1>
                <h2>–°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è–º–∏ –ø–æ ISO 13485</h2>
            </div>
            
            <div class="menu">
                <button class="menu-btn active" onclick="showPage('generateQR')">üéØ –°–æ–∑–¥–∞—Ç—å QR</button>
                <button class="menu-btn" onclick="showPage('listNS')">üìã –í—Å–µ –ù–°</button>
                <button class="menu-btn" onclick="showPage('directories')">üìö –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏</button>
                <button class="menu-btn" onclick="showPage('admin')">‚öôÔ∏è –ê–¥–º–∏–Ω</button>
            </div>
            
            <div class="page active" id="generateQRPage">
                <h2>üéØ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è QR-–∫–æ–¥–∞ –¥–ª—è —Ü–µ—Ö–∞</h2>
                <div class="info-box">
                    <p>–°–æ–∑–¥–∞–π—Ç–µ QR-–∫–æ–¥ –¥–ª—è –º–µ—Å—Ç–∞ –≤ —Ü–µ—Ö—É. –†–∞–±–æ—á–∏–µ —Å–∫–∞–Ω–∏—Ä—É—é—Ç QR –∏ –∑–∞–ø–æ–ª–Ω—è—é—Ç —Ñ–æ—Ä–º—É.</p>
                </div>
                
                <div class="form-group">
                    <label>üè≠ –ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ:</label>
                    <select id="qrDepartment">
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ</option>
                        <option value="–¶–ú–û">–¶–ú–û (–¶–µ—Ö –º–µ—Ç–∞–ª–ª–æ–æ–±—Ä–∞–±–æ—Ç–∫–∏)</option>
                        <option value="–û–¢–ö">–û–¢–ö (–û—Ç–¥–µ–ª —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–≥–æ –∫–æ–Ω—Ç—Ä–æ–ª—è)</option>
                        <option value="–¶–µ—Ö —Å–±–æ—Ä–∫–∏">–¶–µ—Ö —Å–±–æ—Ä–∫–∏</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>üìç –ú–µ—Å—Ç–æ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è:</label>
                    <input type="text" id="qrLocationInput" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –°—Ç–æ–ª –∑–∞—è–≤–æ–∫, –£—á–∞—Å—Ç–æ–∫ ‚Ññ3">
                </div>
                
                <button class="btn btn-primary" onclick="generateQRCode()" style="margin-top: 20px;">
                    üéØ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å QR-–∫–æ–¥
                </button>
                
                <div class="qr-preview" id="qrPreview" style="display: none;">
                    <h3>‚úÖ QR-–∫–æ–¥ –≥–æ—Ç–æ–≤!</h3>
                    <div id="qrcode" style="margin: 15px 0;"></div>
                    <div class="info-box">
                        <div><strong>–ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ:</strong> <span id="previewDept"></span></div>
                        <div><strong>–ú–µ—Å—Ç–æ:</strong> <span id="previewLocation"></span></div>
                        <div><strong>–ö–æ–¥:</strong> <code id="previewCode"></code></div>
                    </div>
                    
                    <button class="btn btn-warning" onclick="testQRCode()" style="margin-top: 10px;">üì± –¢–µ—Å—Ç QR</button>
                </div>
            </div>
            
            <div class="page" id="listNSPage">
                <h2>üìã –í—Å–µ –ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è</h2>
                <div class="status-badges">
                    <button class="status-badge active" onclick="filterNS('all')">–í—Å–µ</button>
                    <button class="status-badge" onclick="filterNS('checking')">–ù–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ</button>
                    <button class="status-badge" onclick="filterNS('closed')">–ó–∞–∫—Ä—ã—Ç—ã–µ</button>
                </div>
                <div id="nsListContainer" style="margin-top: 20px;"></div>
            </div>
            
            <div class="page" id="directoriesPage">
                <h2>üìö –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏</h2>
                
                <div class="info-box">
                    <h3>üë• –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–µ –ª–∏—Ü–∞</h3>
                    <div id="responsiblesList" style="margin: 10px 0;"></div>
                    <div class="form-group">
                        <input type="text" id="responsibleName" placeholder="–§–ò–û">
                        <input type="text" id="responsiblePosition" placeholder="–î–æ–ª–∂–Ω–æ—Å—Ç—å" style="margin-top: 10px;">
                        <button class="btn btn-success" onclick="addResponsible()" style="margin-top: 10px;">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>
                    </div>
                </div>
                
                <div class="info-box" style="margin-top: 20px;">
                    <h3>‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ API</h3>
                    <div class="form-group">
                        <label>üìß Email –º–µ–Ω–µ–¥–∂–µ—Ä–∞:</label>
                        <input type="email" id="managerEmail" value="finkart23@mail.ru">
                    </div>
                    <div class="form-group">
                        <label>üîó Google Sheets URL:</label>
                        <input type="text" id="googleSheetsUrl" placeholder="https://script.google.com/macros/s/...">
                    </div>
                    <button class="btn btn-primary" onclick="saveAPISettings()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                    <button class="btn btn-warning" onclick="testGoogleSheets()" style="margin-left: 10px;">üß™ –¢–µ—Å—Ç</button>
                </div>
            </div>
            
            <div class="page" id="adminPage">
                <h2>‚öôÔ∏è –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ</h2>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 30px;">
                    <div class="info-box" style="text-align: center;">
                        <div style="font-size: 32px; font-weight: bold; color: #1e3c72;" id="totalNS">0</div>
                        <div>–í—Å–µ–≥–æ –ù–°</div>
                    </div>
                    <div class="info-box" style="text-align: center;">
                        <div style="font-size: 32px; font-weight: bold; color: #ffc107;" id="checkingNS">0</div>
                        <div>–ù–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ</div>
                    </div>
                </div>
                
                <div class="info-box">
                    <h3>–°—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã</h3>
                    <div id="systemStatus"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
        const CONFIG = {
            GOOGLE_SHEETS_API: '',
            WEB3FORMS_KEY: '68e70096-0aed-4fd2-ba43-a9f06163e05b',
            WEB3FORMS_URL: 'https://api.web3forms.com/submit',
            STATUSES: {
                'checking': { name: '–ù–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ', color: '#ffc107' },
                'analysis': { name: '–ê–Ω–∞–ª–∏–∑', color: '#2196F3' },
                'correction': { name: '–ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞', color: '#9C27B0' },
                'closed': { name: '–ó–∞–∫—Ä—ã—Ç–æ', color: '#607D8B' }
            }
        };
        
        // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let currentQRData = null;
        let photos = [];
        let currentNSFilter = 'all';
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.addEventListener('DOMContentLoaded', function() {
            console.log('–°–∏—Å—Ç–µ–º–∞ –§–ê–†–ú–°–¢–ò–õ –∑–∞–ø—É—â–µ–Ω–∞');
            loadSettings();
            checkMode();
            loadDirectories();
            updateStats();
        });
        
        // –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            document.querySelectorAll('.menu-btn').forEach(btn => btn.classList.remove('active'));
            
            const page = document.getElementById(pageId + 'Page');
            if (page) {
                page.classList.add('active');
                const buttons = document.querySelectorAll('.menu-btn');
                const index = ['generateQR', 'listNS', 'directories', 'admin'].indexOf(pageId);
                if (buttons[index]) buttons[index].classList.add('active');
                
                if (pageId === 'listNS') loadNSList(currentNSFilter);
                if (pageId === 'admin') {
                    updateStats();
                    updateSystemStatus();
                }
            }
        }
        
        function showNotification(message, type = 'success', duration = 3000) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = 'notification ' + type;
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, duration);
        }
        
        function closeModal() {
            document.getElementById('statusModal').style.display = 'none';
        }
        
        // –†–µ–∂–∏–º —Ä–∞–±–æ—á–µ–≥–æ
        function checkMode() {
            const urlParams = new URLSearchParams(window.location.search);
            const qrCode = urlParams.get('qrcode');
            
            if (qrCode) {
                document.getElementById('adminMode').style.display = 'none';
                document.getElementById('workerMode').style.display = 'block';
                processQRCode(qrCode);
            }
        }
        
        function processQRCode(qrCode) {
            console.log('–û–±—Ä–∞–±–æ—Ç–∫–∞ QR-–∫–æ–¥–∞:', qrCode);
            
            const qrcodes = JSON.parse(localStorage.getItem('farmstil_qrcodes') || '[]');
            let qrData = null;
            
            for (const qr of qrcodes) {
                if (qr.code === qrCode) {
                    qrData = qr;
                    break;
                }
            }
            
            if (qrData) {
                console.log('–ù–∞–π–¥–µ–Ω QR –≤ –±–∞–∑–µ:', qrData);
                showWorkerForm(qrData);
            } else {
                console.log('QR –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ');
                showWorkerFormManual(qrCode);
            }
        }
        
        function showWorkerForm(qrData) {
            const formHTML = `
                <form class="worker-form" id="workerFormElement" onsubmit="event.preventDefault(); submitWorkerForm();">
                    <div class="info-box">
                        <h4>‚úÖ –î–∞–Ω–Ω—ã–µ –∏–∑ QR-–∫–æ–¥–∞:</h4>
                        <div><strong>–ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ:</strong> ${qrData.department || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</div>
                        <div><strong>–ú–µ—Å—Ç–æ:</strong> ${qrData.location || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</div>
                    </div>
                    
                    <h3>üìù –ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ñ–æ—Ä–º—É –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è</h3>
                    
                    <div class="form-group">
                        <label>üìÖ –î–∞—Ç–∞ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è:</label>
                        <input type="date" id="detectionDate" value="${new Date().toISOString().split('T')[0]}" required>
                    </div>
                    
                    <div class="form-group">
                        <label>üë§ –í–∞—à–µ –§–ò–û:</label>
                        <input type="text" id="applicant" placeholder="–í–∞—à–µ –§–ò–û" required>
                    </div>
                    
                    <div class="form-group">
                        <label>üìã –û–ø–∏—Å–∞–Ω–∏–µ –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è:</label>
                        <textarea id="description" rows="4" placeholder="–û–ø–∏—à–∏—Ç–µ –ø—Ä–æ–±–ª–µ–º—É –ø–æ–¥—Ä–æ–±–Ω–æ..." required></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>üì∑ –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ (–¥–æ 3 —à—Ç—É–∫):</label>
                        <div class="photo-upload-area" onclick="document.getElementById('photoInput').click()">
                            <div style="font-size: 40px; margin-bottom: 10px;">üì∏</div>
                            <div>–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ</div>
                            <input type="file" id="photoInput" accept="image/*" multiple style="display: none;" 
                                   onchange="handlePhotoUpload(event)">
                        </div>
                        <div class="preview-container" id="photoPreview"></div>
                    </div>
                    
                    <input type="hidden" id="hiddenDepartment" value="${qrData.department || ''}">
                    <input type="hidden" id="hiddenLocation" value="${qrData.location || ''}">
                    <input type="hidden" id="hiddenQRCode" value="${qrData.code || ''}">
                    
                    <div style="display: flex; gap: 10px; margin-top: 25px;">
                        <button type="submit" class="btn btn-success" style="flex: 2;">
                            üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å
                        </button>
                        <button type="button" class="btn btn-danger" onclick="cancelWorkerForm()">
                            ‚ùå –û—Ç–º–µ–Ω–∞
                        </button>
                    </div>
                </form>
            `;
            
            document.getElementById('workerForm').innerHTML = formHTML;
            currentQRData = qrData;
        }
        
        function showWorkerFormManual(qrCode) {
            const formHTML = `
                <form class="worker-form" onsubmit="event.preventDefault(); submitWorkerFormManual();">
                    <div class="info-box" style="border-color: #ffc107;">
                        <h4>‚ö†Ô∏è QR-–∫–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ</h4>
                        <p>–ö–æ–¥: <strong>${qrCode}</strong></p>
                        <p>–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –≤—Ä—É—á–Ω—É—é:</p>
                    </div>
                    
                    <div class="form-group">
                        <label>üè≠ –ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ:</label>
                        <select id="manualDepartment" required>
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ</option>
                            <option value="–¶–ú–û">–¶–ú–û</option>
                            <option value="–û–¢–ö">–û–¢–ö</option>
                            <option value="–¶–µ—Ö —Å–±–æ—Ä–∫–∏">–¶–µ—Ö —Å–±–æ—Ä–∫–∏</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>üìç –ú–µ—Å—Ç–æ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è:</label>
                        <input type="text" id="manualLocation" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –£—á–∞—Å—Ç–æ–∫ ‚Ññ3" required>
                    </div>
                    
                    <div class="form-group">
                        <label>üìÖ –î–∞—Ç–∞ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è:</label>
                        <input type="date" id="manualDetectionDate" value="${new Date().toISOString().split('T')[0]}" required>
                    </div>
                    
                    <div class="form-group">
                        <label>üë§ –í–∞—à–µ –§–ò–û:</label>
                        <input type="text" id="manualApplicant" placeholder="–í–∞—à–µ –§–ò–û" required>
                    </div>
                    
                    <div class="form-group">
                        <label>üìã –û–ø–∏—Å–∞–Ω–∏–µ:</label>
                        <textarea id="manualDescription" rows="4" placeholder="–û–ø–∏—à–∏—Ç–µ –ø—Ä–æ–±–ª–µ–º—É..." required></textarea>
                    </div>
                    
                    <button type="submit" class="btn btn-success">üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                </form>
            `;
            
            document.getElementById('workerForm').innerHTML = formHTML;
            currentQRData = { code: qrCode };
        }
        
        async function submitWorkerForm() {
            try {
                const department = document.getElementById('hiddenDepartment').value;
                const location = document.getElementById('hiddenLocation').value;
                const detectionDate = document.getElementById('detectionDate').value;
                const applicant = document.getElementById('applicant').value;
                const description = document.getElementById('description').value;
                
                if (!department || !location || !applicant || !description) {
                    showNotification('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è', 'error');
                    return;
                }
                
                const nsNumber = generateNSNumber();
                
                const nsData = {
                    nsNumber: nsNumber,
                    detectionDate: detectionDate,
                    department: department,
                    location: location,
                    applicant: applicant,
                    description: description,
                    photos: photos,
                    status: 'checking',
                    created: new Date().toISOString(),
                    qrCode: currentQRData?.code || 'manual'
                };
                
                const saved = await saveToGoogleSheets(nsData);
                
                showSuccessScreen(nsData);
                resetForm();
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏:', error);
                showNotification('–û—à–∏–±–∫–∞: ' + error.message, 'error');
            }
        }
        
        async function submitWorkerFormManual() {
            try {
                const department = document.getElementById('manualDepartment').value;
                const location = document.getElementById('manualLocation').value;
                const detectionDate = document.getElementById('manualDetectionDate').value;
                const applicant = document.getElementById('manualApplicant').value;
                const description = document.getElementById('manualDescription').value;
                
                if (!department || !location || !applicant || !description) {
                    showNotification('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è', 'error');
                    return;
                }
                
                const nsNumber = generateNSNumber();
                
                const nsData = {
                    nsNumber: nsNumber,
                    detectionDate: detectionDate,
                    department: department,
                    location: location,
                    applicant: applicant,
                    description: description,
                    photos: photos,
                    status: 'checking',
                    created: new Date().toISOString(),
                    qrCode: currentQRData?.code || 'manual'
                };
                
                const saved = await saveToGoogleSheets(nsData);
                
                showSuccessScreen(nsData);
                resetForm();
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏:', error);
                showNotification('–û—à–∏–±–∫–∞: ' + error.message, 'error');
            }
        }
        
        function showSuccessScreen(nsData) {
            const formHTML = `
                <div style="text-align: center; padding: 30px;">
                    <div style="font-size: 60px; color: #28a745; margin-bottom: 20px;">‚úÖ</div>
                    <h2>–ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–æ!</h2>
                    
                    <div class="info-box" style="max-width: 500px; margin: 20px auto;">
                        <div><strong>–ù–æ–º–µ—Ä –ù–°:</strong> ${nsData.nsNumber}</div>
                        <div><strong>–î–∞—Ç–∞:</strong> ${new Date(nsData.detectionDate).toLocaleDateString('ru-RU')}</div>
                        <div><strong>–ó–∞—è–≤–∏—Ç–µ–ª—å:</strong> ${nsData.applicant}</div>
                        <div><strong>–ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ:</strong> ${nsData.department}</div>
                    </div>
                    
                    <button class="btn btn-primary" onclick="cancelWorkerForm()">
                        üìù –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –∑–∞—è–≤–∫—É
                    </button>
                </div>
            `;
            
            document.getElementById('workerForm').innerHTML = formHTML;
            showNotification('–ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —É—Å–ø–µ—à–Ω–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–æ!', 'success');
        }
        
        function resetForm() {
            photos = [];
            const photoInput = document.getElementById('photoInput');
            if (photoInput) photoInput.value = '';
        }
        
        function cancelWorkerForm() {
            const urlParams = new URLSearchParams(window.location.search);
            const qrCode = urlParams.get('qrcode');
            
            if (qrCode) {
                window.location.href = window.location.pathname + '?qrcode=' + qrCode;
            } else {
                window.location.href = window.location.pathname;
            }
        }
        
        // –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏
        function handlePhotoUpload(event) {
            const files = event.target.files;
            const preview = document.getElementById('photoPreview');
            
            if (!preview) return;
            
            const remainingSlots = 3 - photos.length;
            const fileCount = Math.min(files.length, remainingSlots);
            
            if (fileCount <= 0) {
                showNotification('–ú–∞–∫—Å–∏–º—É–º 3 —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏', 'warning');
                return;
            }
            
            for (let i = 0; i < fileCount; i++) {
                const file = files[i];
                
                if (file.size > 2 * 1024 * 1024) {
                    showNotification(`–§–æ—Ç–æ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–µ (–º–∞–∫—Å. 2MB)`, 'warning');
                    continue;
                }
                
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    const photoDiv = document.createElement('div');
                    photoDiv.className = 'photo-preview';
                    photoDiv.innerHTML = `
                        <img src="${e.target.result}" alt="–§–æ—Ç–æ ${photos.length + 1}">
                        <button onclick="removePhoto(${photos.length})" style="
                            position: absolute; top: 5px; right: 5px; 
                            background: rgba(220, 53, 69, 0.9); color: white; 
                            border: none; border-radius: 50%; width: 24px; 
                            height: 24px; font-size: 14px; cursor: pointer;
                        ">√ó</button>
                    `;
                    preview.appendChild(photoDiv);
                    
                    photos.push({
                        name: file.name,
                        data: e.target.result,
                        type: file.type,
                        size: file.size
                    });
                };
                
                reader.readAsDataURL(file);
            }
            
            showNotification(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${fileCount} —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π`, 'success');
        }
        
        function removePhoto(index) {
            photos.splice(index, 1);
            const preview = document.getElementById('photoPreview');
            if (preview) {
                preview.innerHTML = '';
                
                photos.forEach((photo, i) => {
                    const photoDiv = document.createElement('div');
                    photoDiv.className = 'photo-preview';
                    photoDiv.innerHTML = `
                        <img src="${photo.data}" alt="–§–æ—Ç–æ ${i + 1}">
                        <button onclick="removePhoto(${i})" style="
                            position: absolute; top: 5px; right: 5px; 
                            background: rgba(220, 53, 69, 0.9); color: white; 
                            border: none; border-radius: 50%; width: 24px; 
                            height: 24px; font-size: 14px; cursor: pointer;
                        ">√ó</button>
                    `;
                    preview.appendChild(photoDiv);
                });
            }
        }
        
        // Google Sheets API
        async function saveToGoogleSheets(nsData) {
            try {
                const apiUrl = localStorage.getItem('google_sheets_url') || CONFIG.GOOGLE_SHEETS_API;
                
                if (!apiUrl) {
                    console.warn('Google Sheets URL –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω');
                    saveToLocalStorage(nsData);
                    showNotification('–î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –ª–æ–∫–∞–ª—å–Ω–æ', 'warning');
                    return false;
                }
                
                const dataToSend = {
                    action: 'save',
                    timestamp: new Date().toISOString(),
                    nsNumber: nsData.nsNumber,
                    detectionDate: nsData.detectionDate,
                    department: nsData.department,
                    location: nsData.location,
                    applicant: nsData.applicant,
                    description: nsData.description,
                    status: nsData.status || 'checking'
                };
                
                console.log('–û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö:', dataToSend);
                
                try {
                    await fetch(apiUrl, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(dataToSend)
                    });
                    
                    console.log('‚úÖ –î–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã');
                } catch (fetchError) {
                    console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å:', fetchError);
                }
                
                saveToLocalStorage(nsData);
                return true;
                
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞:', error);
                saveToLocalStorage(nsData);
                showNotification('–î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –ª–æ–∫–∞–ª—å–Ω–æ', 'warning');
                return false;
            }
        }
        
        function saveToLocalStorage(nsData) {
            try {
                const localData = JSON.parse(localStorage.getItem('farmstil_ns_local') || '[]');
                localData.push({
                    ...nsData,
                    localId: `local_${Date.now()}`,
                    synced: false
                });
                
                localStorage.setItem('farmstil_ns_local', JSON.stringify(localData));
                console.log('‚úÖ –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –ª–æ–∫–∞–ª—å–Ω–æ');
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', error);
            }
        }
        
        function loadFromLocalStorage() {
            try {
                const localData = JSON.parse(localStorage.getItem('farmstil_ns_local') || '[]');
                return localData;
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
                return [];
            }
        }
        
        // –†–∞–±–æ—Ç–∞ —Å –ù–°
        function filterNS(status) {
            currentNSFilter = status;
            loadNSList(status);
        }
        
        function loadNSList(filterStatus = 'all') {
            const container = document.getElementById('nsListContainer');
            if (!container) return;
            
            try {
                const nsList = loadFromLocalStorage();
                
                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
                document.querySelectorAll('.status-badge').forEach(badge => {
                    badge.classList.remove('active');
                });
                
                let filteredNS = nsList;
                if (filterStatus !== 'all') {
                    filteredNS = nsList.filter(ns => ns.status === filterStatus);
                }
                
                filteredNS.sort((a, b) => new Date(b.created) - new Date(a.created));
                
                if (filteredNS.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #666;">
                            <h3>–ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–π –Ω–µ—Ç</h3>
                            <p>–°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤–æ–µ –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —á–µ—Ä–µ–∑ QR-–∫–æ–¥</p>
                        </div>
                    `;
                    return;
                }
                
                let html = '';
                
                filteredNS.forEach((ns) => {
                    if (!ns || !ns.nsNumber) return;
                    
                    const date = new Date(ns.detectionDate).toLocaleDateString('ru-RU');
                    const status = ns.status || 'checking';
                    const statusConfig = CONFIG.STATUSES[status] || CONFIG.STATUSES.checking;
                    
                    html += `
                        <div class="ln-card">
                            <div class="ln-card-header">
                                <div class="ln-number">${ns.nsNumber}</div>
                                <div class="ln-status" style="background: ${statusConfig.color}">${statusConfig.name}</div>
                            </div>
                            
                            <div style="font-size: 14px;">
                                <div><strong>–î–∞—Ç–∞:</strong> ${date}</div>
                                <div><strong>–ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ:</strong> ${ns.department || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</div>
                                <div><strong>–ó–∞—è–≤–∏—Ç–µ–ª—å:</strong> ${ns.applicant || '–ù–µ —É–∫–∞–∑–∞–Ω'}</div>
                                <div style="margin-top: 5px; padding: 8px; background: #f8f9fa; border-radius: 5px; font-size: 13px;">
                                    ${ns.description ? (ns.description.length > 100 ? ns.description.substring(0, 100) + '...' : ns.description) : '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è'}
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞:', error);
                container.innerHTML = '<div style="color: #dc3545;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</div>';
            }
        }
        
        // –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏
        function loadDirectories() {
            loadResponsibles();
            loadSettings();
        }
        
        function loadResponsibles() {
            const container = document.getElementById('responsiblesList');
            if (!container) return;
            
            try {
                const responsibles = JSON.parse(localStorage.getItem('farmstil_responsibles') || '[]');
                
                if (responsibles.length === 0) {
                    container.innerHTML = '<div style="color: #666;">–ù–µ—Ç –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã—Ö</div>';
                    return;
                }
                
                let html = '';
                responsibles.forEach((resp, index) => {
                    html += `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; border-bottom: 1px solid #eee;">
                            <div>
                                <strong>${resp.name}</strong>
                                <div style="font-size: 12px; color: #666;">${resp.position}</div>
                            </div>
                            <button onclick="deleteResponsible(${index})" style="
                                background: #dc3545; color: white; border: none; 
                                border-radius: 4px; padding: 4px 8px; font-size: 12px; cursor: pointer;
                            ">
                                –£–¥–∞–ª–∏—Ç—å
                            </button>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
            }
        }
        
        function addResponsible() {
            const name = document.getElementById('responsibleName').value.trim();
            const position = document.getElementById('responsiblePosition').value.trim();
            
            if (!name || !position) {
                showNotification('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –§–ò–û –∏ –¥–æ–ª–∂–Ω–æ—Å—Ç—å', 'error');
                return;
            }
            
            try {
                const responsibles = JSON.parse(localStorage.getItem('farmstil_responsibles') || '[]');
                responsibles.push({ name, position });
                localStorage.setItem('farmstil_responsibles', JSON.stringify(responsibles));
                
                document.getElementById('responsibleName').value = '';
                document.getElementById('responsiblePosition').value = '';
                
                loadResponsibles();
                showNotification('–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π –¥–æ–±–∞–≤–ª–µ–Ω', 'success');
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è:', error);
                showNotification('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è', 'error');
            }
        }
        
        function deleteResponsible(index) {
            if (confirm('–£–¥–∞–ª–∏—Ç—å –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ?')) {
                try {
                    const responsibles = JSON.parse(localStorage.getItem('farmstil_responsibles') || '[]');
                    responsibles.splice(index, 1);
                    localStorage.setItem('farmstil_responsibles', JSON.stringify(responsibles));
                    loadResponsibles();
                    showNotification('–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π —É–¥–∞–ª–µ–Ω', 'success');
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è:', error);
                    showNotification('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è', 'error');
                }
            }
        }
        
        function loadSettings() {
            try {
                const managerEmail = localStorage.getItem('manager_email') || 'finkart23@mail.ru';
                const googleSheetsUrl = localStorage.getItem('google_sheets_url') || CONFIG.GOOGLE_SHEETS_API;
                
                document.getElementById('managerEmail').value = managerEmail;
                document.getElementById('googleSheetsUrl').value = googleSheetsUrl;
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫:', error);
            }
        }
        
        function saveAPISettings() {
            try {
                const managerEmail = document.getElementById('managerEmail').value;
                const googleSheetsUrl = document.getElementById('googleSheetsUrl').value;
                
                if (!managerEmail.includes('@')) {
                    showNotification('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π email', 'error');
                    return;
                }
                
                localStorage.setItem('manager_email', managerEmail);
                localStorage.setItem('google_sheets_url', googleSheetsUrl);
                
                showNotification('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã', 'success');
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', error);
                showNotification('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è', 'error');
            }
        }
        
        async function testGoogleSheets() {
            try {
                showNotification('–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ...', 'info');
                
                const apiUrl = localStorage.getItem('google_sheets_url') || CONFIG.GOOGLE_SHEETS_API;
                
                if (!apiUrl || !apiUrl.startsWith('http')) {
                    showNotification('‚ùå URL –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω', 'error');
                    return;
                }
                
                showNotification('‚úÖ –¢–µ—Å—Ç –∑–∞–ø—É—â–µ–Ω', 'success');
                
            } catch (error) {
                showNotification('‚ùå –û—à–∏–±–∫–∞: ' + error.message, 'error');
            }
        }
        
        // –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ
        function updateStats() {
            try {
                const nsList = loadFromLocalStorage();
                
                const totalNS = nsList.length;
                const checkingNS = nsList.filter(ns => ns.status === 'checking').length;
                
                document.getElementById('totalNS').textContent = totalNS;
                document.getElementById('checkingNS').textContent = checkingNS;
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', error);
            }
        }
        
        function updateSystemStatus() {
            const statusDiv = document.getElementById('systemStatus');
            if (!statusDiv) return;
            
            try {
                const managerEmail = localStorage.getItem('manager_email') || '–ù–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω';
                const googleSheetsUrl = localStorage.getItem('google_sheets_url') || CONFIG.GOOGLE_SHEETS_API;
                const qrCount = JSON.parse(localStorage.getItem('farmstil_qrcodes') || '[]').length;
                
                statusDiv.innerHTML = `
                    <div style="font-size: 14px;">
                        <div><strong>Email –º–µ–Ω–µ–¥–∂–µ—Ä–∞:</strong> ${managerEmail}</div>
                        <div><strong>Google Sheets:</strong> ${googleSheetsUrl && googleSheetsUrl.startsWith('http') ? '‚úÖ –ù–∞—Å—Ç—Ä–æ–µ–Ω' : '‚ùå –ù–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω'}</div>
                        <div><strong>QR-–∫–æ–¥–æ–≤:</strong> ${qrCount}</div>
                        <div><strong>–õ–æ–∫–∞–ª—å–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π:</strong> ${JSON.parse(localStorage.getItem('farmstil_ns_local') || '[]').length}</div>
                    </div>
                `;
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞:', error);
            }
        }
        
        // QR –∫–æ–¥—ã
        function generateQRCode() {
            try {
                const department = document.getElementById('qrDepartment').value;
                const location = document.getElementById('qrLocationInput').value;
                
                if (!department || !location) {
                    showNotification('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è', 'error');
                    return;
                }
                
                const timestamp = Date.now().toString().slice(-6);
                const random = Math.random().toString(36).substr(2, 4).toUpperCase();
                const code = `FS-${timestamp}-${random}`;
                
                const currentUrl = window.location.origin + window.location.pathname;
                const qrUrl = `${currentUrl}?qrcode=${code}`;
                
                currentQRData = {
                    code: code,
                    department: department,
                    location: location,
                    url: qrUrl,
                    created: new Date().toISOString()
                };
                
                const qrcodes = JSON.parse(localStorage.getItem('farmstil_qrcodes') || '[]');
                qrcodes.push(currentQRData);
                localStorage.setItem('farmstil_qrcodes', JSON.stringify(qrcodes));
                
                const qrcodeDiv = document.getElementById('qrcode');
                if (qrcodeDiv) {
                    qrcodeDiv.innerHTML = '';
                    
                    if (typeof QRCode !== 'undefined') {
                        new QRCode(qrcodeDiv, {
                            text: qrUrl,
                            width: 200,
                            height: 200,
                            colorDark: "#1e3c72",
                            colorLight: "#ffffff"
                        });
                    }
                }
                
                document.getElementById('qrPreview').style.display = 'block';
                document.getElementById('previewDept').textContent = department;
                document.getElementById('previewLocation').textContent = location;
                document.getElementById('previewCode').textContent = code;
                
                showNotification('QR-–∫–æ–¥ —Å–æ–∑–¥–∞–Ω!', 'success');
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ QR:', error);
                showNotification('–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏', 'error');
            }
        }
        
        function testQRCode() {
            if (currentQRData?.url) {
                window.open(currentQRData.url, '_blank');
                showNotification('–û—Ç–∫—Ä–æ–π—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ', 'info');
            }
        }
        
        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
        function generateNSNumber() {
            const year = new Date().getFullYear().toString().slice(-2);
            const month = (new Date().getMonth() + 1).toString().padStart(2, '0');
            const random = Math.floor(Math.random() * 999).toString().padStart(3, '0');
            return `NS-${year}${month}-${random}`;
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        try {
            if (!localStorage.getItem('farmstil_responsibles')) {
                localStorage.setItem('farmstil_responsibles', JSON.stringify([
                    { name: "–ò–≤–∞–Ω–æ–≤ –ò.–ò.", position: "–ú–∞—Å—Ç–µ—Ä —Ü–µ—Ö–∞" },
                    { name: "–ü–µ—Ç—Ä–æ–≤ –ü.–ü.", position: "–ò–Ω–∂–µ–Ω–µ—Ä" }
                ]));
            }
            
            if (!localStorage.getItem('manager_email')) {
                localStorage.setItem('manager_email', 'finkart23@mail.ru');
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', error);
        }
        
        // –≠–∫—Å–ø–æ—Ä—Ç —Ñ—É–Ω–∫—Ü–∏–π
        window.showPage = showPage;
        window.generateQRCode = generateQRCode;
        window.testQRCode = testQRCode;
        window.filterNS = filterNS;
        window.closeModal = closeModal;
        window.addResponsible = addResponsible;
        window.deleteResponsible = deleteResponsible;
        window.saveAPISettings = saveAPISettings;
        window.testGoogleSheets = testGoogleSheets;
        window.submitWorkerForm = submitWorkerForm;
        window.submitWorkerFormManual = submitWorkerFormManual;
        window.handlePhotoUpload = handlePhotoUpload;
        window.removePhoto = removePhoto;
        window.cancelWorkerForm = cancelWorkerForm;
        
    </script>
</body>
</html>

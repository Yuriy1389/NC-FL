<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–§–ê–†–ú–°–¢–ò–õ - –°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è–º–∏ ISO 13485</title>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 10px; }
        .container { max-width: 1200px; margin: 0 auto; background: white; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); overflow: hidden; }
        .header { background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); color: white; padding: 20px; text-align: center; }
        .header h1 { font-size: 24px; margin-bottom: 8px; }
        .header h2 { font-size: 14px; font-weight: normal; opacity: 0.9; }
        .menu { display: flex; background: linear-gradient(90deg, #4b6cb7 0%, #182848 100%); padding: 0; gap: 1px; flex-wrap: wrap; }
        .menu-btn { padding: 12px 15px; background: white; border: none; color: #1e3c72; font-weight: bold; cursor: pointer; transition: all 0.3s ease; flex: 1; min-width: 120px; font-size: 14px; }
        .menu-btn.active { background: #1e3c72; color: white; }
        .page { display: none; padding: 20px; min-height: 500px; }
        .page.active { display: block; }
        .form-grid { display: flex; flex-direction: column; gap: 15px; margin: 20px 0; }
        .form-group { display: flex; flex-direction: column; width: 100%; }
        label { margin-bottom: 6px; font-weight: 600; color: #333; font-size: 14px; }
        input, select, textarea { padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px; width: 100%; }
        select { background: white url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%231e3c72' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e") no-repeat right 10px center; background-size: 16px; }
        .btn { padding: 14px 20px; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s; margin: 5px 0; display: flex; align-items: center; justify-content: center; gap: 8px; width: 100%; }
        .btn-primary { background: #1e3c72; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-warning { background: #ffc107; color: #212529; }
        .btn-info { background: #17a2b8; color: white; }
        .notification { position: fixed; top: 10px; right: 10px; left: 10px; background: white; color: #333; padding: 15px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.15); display: none; z-index: 1000; border-left: 5px solid #28a745; text-align: center; }
        .notification.error { border-left-color: #dc3545; }
        .notification.warning { border-left-color: #ffc107; }
        .notification.info { border-left-color: #17a2b8; }
        .worker-container { width: 100%; margin: 20px auto; background: white; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); overflow: hidden; }
        .worker-header { background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); color: white; padding: 25px; text-align: center; }
        .worker-content { padding: 20px; }
        .worker-form { display: flex; flex-direction: column; gap: 20px; }
        .qr-info-box { background: #e3f2fd; padding: 15px; border-radius: 10px; border-left: 5px solid #2196F3; margin-bottom: 15px; }
        .photo-upload-area { border: 3px dashed #28a745; border-radius: 12px; padding: 20px; text-align: center; background: #f8fff8; cursor: pointer; margin: 15px 0; }
        .preview-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; margin-top: 10px; }
        .photo-preview { position: relative; border-radius: 8px; overflow: hidden; border: 2px solid #ddd; height: 100px; }
        .photo-preview img { width: 100%; height: 100%; object-fit: cover; }
        .info-box { background: #f8f9fa; padding: 15px; border-radius: 10px; margin: 15px 0; border-left: 5px solid #1e3c72; font-size: 14px; }
        .ln-list { display: flex; flex-direction: column; gap: 15px; margin-top: 20px; }
        .ln-card { background: white; border: 1px solid #e0e0e0; border-radius: 12px; padding: 15px; box-shadow: 0 3px 10px rgba(0,0,0,0.08); }
        .ln-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 2px solid #f0f0f0; }
        .ln-number { font-weight: bold; color: #1e3c72; font-size: 16px; }
        .ln-status { padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: bold; color: white; }
        .status-checking { background: #ffc107; }
        .status-analysis { background: #2196F3; }
        .status-correction { background: #9C27B0; color: white; }
        .status-execution { background: #FF5722; color: white; }
        .status-verification { background: #4CAF50; color: white; }
        .status-closed { background: #607D8B; color: white; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; justify-content: center; align-items: center; }
        .modal-content { background: white; border-radius: 15px; padding: 25px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-title { font-size: 20px; color: #1e3c72; font-weight: bold; }
        .modal-close { background: none; border: none; font-size: 24px; cursor: pointer; color: #666; }
        .qr-preview { text-align: center; padding: 20px; border: 3px dashed #1e3c72; border-radius: 15px; margin-top: 20px; background: #f8f9fa; }
        .ios-warning { background: #fff3cd; border: 2px solid #ffc107; border-radius: 10px; padding: 15px; margin: 15px 0; font-size: 14px; color: #856404; }
        .voice-indicator { display: none; text-align: center; padding: 10px; margin: 10px 0; background: #d4edda; border-radius: 8px; color: #155724; font-weight: bold; }
        .voice-indicator.active { display: block; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }
        @media (min-width: 768px) {
            body { padding: 20px; }
            .menu-btn { padding: 15px 25px; font-size: 16px; }
            .header h1 { font-size: 28px; }
            .header h2 { font-size: 16px; }
            .page { padding: 30px; }
            .form-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; }
            .btn { width: auto; }
            .worker-container { max-width: 800px; }
            .worker-content { padding: 40px; }
            .ln-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 25px; }
            .notification { right: 20px; left: auto; max-width: 400px; }
        }
    </style>
</head>
<body>
    <div class="notification" id="notification"></div>
    
    <div class="modal" id="statusModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle">–ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞</div>
                <button class="modal-close" onclick="closeModal()">√ó</button>
            </div>
            <div id="modalContent"></div>
        </div>
    </div>
    
    <div id="workerMode" style="display: none;">
        <div class="worker-container">
            <div class="worker-header">
                <h1>üìù –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è (ISO 13485)</h1>
                <p>–§–ê–†–ú–°–¢–ò–õ - –°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–∞—á–µ—Å—Ç–≤–æ–º</p>
            </div>
            <div class="worker-content">
                <div id="workerForm"></div>
            </div>
        </div>
    </div>
    
    <div id="adminMode">
        <div class="container">
            <div class="header">
                <h1>–§–ê–†–ú–°–¢–ò–õ - –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–∞—è –ø–∞–Ω–µ–ª—å</h1>
                <h2>–°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è–º–∏ –ø–æ ISO 13485</h2>
            </div>
            
            <div class="menu">
                <button class="menu-btn active" onclick="showPage('generateQR')">üéØ –°–æ–∑–¥–∞—Ç—å QR</button>
                <button class="menu-btn" onclick="showPage('listNS')">üìã –í—Å–µ –ù–°</button>
                <button class="menu-btn" onclick="showPage('directories')">üìö –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏</button>
                <button class="menu-btn" onclick="showPage('admin')">‚öôÔ∏è –ê–¥–º–∏–Ω</button>
            </div>
            
            <div class="page active" id="generateQRPage">
                <h2>üéØ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è QR-–∫–æ–¥–∞ –¥–ª—è —Ü–µ—Ö–∞</h2>
                <div class="info-box">
                    <p><strong>üí° –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:</strong></p>
                    <ol style="margin: 10px 0 0 15px; font-size: 14px;">
                        <li>–°–æ–∑–¥–∞–µ—Ç–µ QR-–∫–æ–¥ –¥–ª—è –º–µ—Å—Ç–∞ –≤ —Ü–µ—Ö—É</li>
                        <li>–ü–µ—á–∞—Ç–∞–µ—Ç–µ –∏ —Ä–∞–∑–º–µ—â–∞–µ—Ç–µ –Ω–∞ –≤–∏–¥–Ω–æ–º –º–µ—Å—Ç–µ</li>
                        <li>–†–∞–±–æ—á–∏–µ —Å–∫–∞–Ω–∏—Ä—É—é—Ç QR –∏ –∑–∞–ø–æ–ª–Ω—è—é—Ç —Ñ–æ—Ä–º—É</li>
                        <li>–î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ Google Sheets</li>
                    </ol>
                </div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label>üè≠ –ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ:</label>
                        <select id="qrDepartment">
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ</option>
                            <option value="–¶–ú–û">–¶–ú–û (–¶–µ—Ö –º–µ—Ç–∞–ª–ª–æ–æ–±—Ä–∞–±–æ—Ç–∫–∏)</option>
                            <option value="–û–¢–ö">–û–¢–ö (–û—Ç–¥–µ–ª —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–≥–æ –∫–æ–Ω—Ç—Ä–æ–ª—è)</option>
                            <option value="–¶–µ—Ö —Å–±–æ—Ä–∫–∏">–¶–µ—Ö —Å–±–æ—Ä–∫–∏</option>
                            <option value="–°–∫–ª–∞–¥">–°–∫–ª–∞–¥ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤</option>
                            <option value="–¶–µ—Ö –ø–æ–∫—Ä–∞—Å–∫–∏">–¶–µ—Ö –ø–æ–∫—Ä–∞—Å–∫–∏</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>üìç –ú–µ—Å—Ç–æ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è:</label>
                        <input type="text" id="qrLocationInput" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –°—Ç–æ–ª –∑–∞—è–≤–æ–∫, –£—á–∞—Å—Ç–æ–∫ ‚Ññ3">
                    </div>
                    
                    <div class="form-group">
                        <label>üë§ –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π –ø–æ QR:</label>
                        <input type="text" id="qrResponsible" placeholder="–§–ò–û –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ">
                    </div>
                </div>
                
                <button class="btn btn-primary" onclick="generateQRCode()" style="margin-top: 20px;">
                    üéØ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å QR-–∫–æ–¥
                </button>
                
                <div class="qr-preview" id="qrPreview" style="display: none;">
                    <h3>‚úÖ QR-–∫–æ–¥ –≥–æ—Ç–æ–≤!</h3>
                    <div id="qrcode" style="margin: 15px 0;"></div>
                    <div class="info-box">
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            <div><strong>–ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ:</strong> <span id="previewDept"></span></div>
                            <div><strong>–ú–µ—Å—Ç–æ:</strong> <span id="previewLocation"></span></div>
                            <div><strong>–ö–æ–¥:</strong> <code id="previewCode"></code></div>
                            <div><strong>–°–æ–∑–¥–∞–Ω:</strong> <span id="previewDate"></span></div>
                        </div>
                    </div>
                    
                    <div class="form-grid" style="margin-top: 20px;">
                        <button class="btn btn-success" onclick="printQRCode()">üñ®Ô∏è –ü–µ—á–∞—Ç—å</button>
                        <button class="btn btn-primary" onclick="saveQRAsImage()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å PNG</button>
                        <button class="btn btn-warning" onclick="testQRCode()">üì± –¢–µ—Å—Ç</button>
                    </div>
                </div>
            </div>
            
            <div class="page" id="listNSPage">
                <h2>üìã –í—Å–µ –ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è</h2>
                <div id="nsListContainer" style="margin-top: 20px;">
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <h3 style="color: #1e3c72;">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</h3>
                        <p>–ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ Google Sheets</p>
                    </div>
                </div>
            </div>
            
            <div class="page" id="directoriesPage">
                <h2>üìö –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏</h2>
                <div class="info-box" style="border-color: #1e3c72;">
                    <h3>‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ API</h3>
                    <div style="margin-bottom: 15px;">
                        <label>üîó Google Sheets API URL:</label>
                        <input type="text" id="googleSheetsUrl" placeholder="https://script.google.com/macros/s/..." style="margin-top: 5px; font-family: monospace; font-size: 12px;">
                        <small style="color: #666;">–í—Å—Ç–∞–≤—å—Ç–µ URL –∏–∑ Google Apps Script</small>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label>üìß Email –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –°–ú–ö:</label>
                        <input type="email" id="managerEmail" value="finkart23@mail.ru" style="margin-top: 5px;">
                    </div>
                    
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn btn-primary" onclick="saveAPISettings()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
                        <button class="btn btn-warning" onclick="testGoogleSheets()">üß™ –¢–µ—Å—Ç Google Sheets</button>
                    </div>
                </div>
                
                <div class="info-box" style="border-color: #28a745; margin-top: 20px;">
                    <h3 style="color: #28a745;">üë• –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–µ –ª–∏—Ü–∞</h3>
                    <p>–°–ø–∏—Å–æ–∫ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã—Ö –ª–∏—Ü —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ Google Sheets –∏ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.</p>
                    <button class="btn btn-info" onclick="refreshResponsibles()" style="margin-top: 10px;">üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫</button>
                </div>
            </div>
            
            <div class="page" id="adminPage">
                <h2>‚öôÔ∏è –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ</h2>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 30px;">
                    <div class="info-box" style="text-align: center;">
                        <div style="font-size: 32px; font-weight: bold; color: #1e3c72;" id="totalNS">0</div>
                        <div style="color: #666; font-size: 14px;">–í—Å–µ–≥–æ –ù–°</div>
                    </div>
                    <div class="info-box" style="text-align: center;">
                        <div style="font-size: 32px; font-weight: bold; color: #ffc107;" id="checkingNS">0</div>
                        <div style="color: #666; font-size: 14px;">–ù–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ</div>
                    </div>
                    <div class="info-box" style="text-align: center;">
                        <div style="font-size: 32px; font-weight: bold; color: #2196F3;" id="analysisNS">0</div>
                        <div style="color: #666; font-size: 14px;">–í –∞–Ω–∞–ª–∏–∑–µ</div>
                    </div>
                    <div class="info-box" style="text-align: center;">
                        <div style="font-size: 32px; font-weight: bold; color: #4CAF50;" id="closedNS">0</div>
                        <div style="color: #666; font-size: 14px;">–ó–∞–∫—Ä—ã—Ç—ã–µ</div>
                    </div>
                </div>
                
                <div class="info-box">
                    <h3>–°—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã</h3>
                    <div id="systemStatus">–ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Google Sheets...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ==========
        const CONFIG = {
            // Google Sheets API URL (–±—É–¥–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º)
            GOOGLE_SHEETS_API: '',
            
            // Email –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
            WEB3FORMS_KEY: '0f9ce86d-9834-4669-b86e-c0cc782cca96,
            WEB3FORMS_URL: 'https://api.web3forms.com/submit',
            
            // –°—Ç–∞—Ç—É—Å—ã –ø–æ ISO 13485
            STATUSES: {
                'checking': { name: '–ù–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ –°–ú–ö', color: '#ffc107' },
                'analysis': { name: '–ê–Ω–∞–ª–∏–∑ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–º', color: '#2196F3' },
                'correction': { name: '–ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É—é—â–∏–µ –¥–µ–π—Å—Ç–≤–∏—è', color: '#9C27B0' },
                'execution': { name: '–ò—Å–ø–æ–ª–Ω–µ–Ω–∏–µ', color: '#FF5722' },
                'verification': { name: '–í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏', color: '#4CAF50' },
                'closed': { name: '–ó–∞–∫—Ä—ã—Ç–æ', color: '#607D8B' }
            }
        };
        
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let currentQRData = null;
        let photos = [];
        
        // ========== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ==========
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ –°–∏—Å—Ç–µ–º–∞ –§–ê–†–ú–°–¢–ò–õ –∑–∞–ø—É—â–µ–Ω–∞');
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
            loadSettings();
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∂–∏–º
            checkMode();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            updateStats();
        });
        
        function loadSettings() {
            const savedApiUrl = localStorage.getItem('google_sheets_api_url');
            const savedEmail = localStorage.getItem('manager_email');
            
            if (savedApiUrl) {
                CONFIG.GOOGLE_SHEETS_API = savedApiUrl;
                document.getElementById('googleSheetsUrl').value = savedApiUrl;
            }
            
            if (savedEmail) {
                document.getElementById('managerEmail').value = savedEmail;
            }
        }
        
        function saveAPISettings() {
            const apiUrl = document.getElementById('googleSheetsUrl').value.trim();
            const managerEmail = document.getElementById('managerEmail').value.trim();
            
            if (!apiUrl.startsWith('https://script.google.com/')) {
                showNotification('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π URL Google Apps Script', 'error');
                return;
            }
            
            if (!managerEmail.includes('@')) {
                showNotification('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π email', 'error');
                return;
            }
            
            CONFIG.GOOGLE_SHEETS_API = apiUrl;
            localStorage.setItem('google_sheets_api_url', apiUrl);
            localStorage.setItem('manager_email', managerEmail);
            
            showNotification('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã', 'success');
            updateSystemStatus();
            
            // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
            if (currentPage === 'listNS') loadNSList();
        }
        
        // ========== GOOGLE SHEETS API ==========
        
        async function saveToGoogleSheets(nsData) {
            try {
                if (!CONFIG.GOOGLE_SHEETS_API) {
                    throw new Error('–ù–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω Google Sheets API URL');
                }
                
                // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
                const dataToSend = {
                    action: 'save',
                    nsNumber: nsData.nsNumber,
                    detectionDate: nsData.detectionDate,
                    department: nsData.department,
                    location: nsData.location,
                    applicant: nsData.applicant,
                    productName: nsData.productName || '',
                    productCode: nsData.productCode || '',
                    description: nsData.description,
                    photos: JSON.stringify(nsData.photos || []),
                    status: nsData.status || 'checking',
                    created: new Date().toISOString()
                };
                
                console.log('–û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≤ Google Sheets:', dataToSend);
                
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º CORS –ø—Ä–æ–∫—Å–∏ –¥–ª—è –æ–±—Ö–æ–¥–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π
                const proxyUrl = 'https://cors-anywhere.herokuapp.com/';
                const response = await fetch(proxyUrl + CONFIG.GOOGLE_SHEETS_API, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify(dataToSend)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    console.log('‚úÖ –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ Google Sheets');
                    return true;
                } else {
                    throw new Error(result.error || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
                }
                
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Google Sheets:', error);
                showNotification('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ Google Sheets: ' + error.message, 'error');
                return false;
            }
        }
        
        async function loadFromGoogleSheets() {
            try {
                if (!CONFIG.GOOGLE_SHEETS_API) {
                    throw new Error('–ù–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω Google Sheets API URL');
                }
                
                console.log('–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ Google Sheets...');
                
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º CORS –ø—Ä–æ–∫—Å–∏
                const proxyUrl = 'https://cors-anywhere.herokuapp.com/';
                const response = await fetch(proxyUrl + CONFIG.GOOGLE_SHEETS_API + '?action=get', {
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    console.log('‚úÖ –î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ Google Sheets:', data.data.length, '–∑–∞–ø–∏—Å–µ–π');
                    return data.data;
                } else {
                    throw new Error(data.error || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏');
                }
                
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑ Google Sheets:', error);
                showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑ Google Sheets: ' + error.message, 'error');
                return [];
            }
        }
        
        async function updateNSStatus(nsNumber, newStatus, responsible = '', notes = '') {
            try {
                if (!CONFIG.GOOGLE_SHEETS_API) {
                    throw new Error('–ù–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω Google Sheets API URL');
                }
                
                const dataToSend = {
                    action: 'update',
                    nsNumber: nsNumber,
                    status: newStatus,
                    responsible: responsible,
                    notes: notes,
                    updated: new Date().toISOString()
                };
                
                const proxyUrl = 'https://cors-anywhere.herokuapp.com/';
                const response = await fetch(proxyUrl + CONFIG.GOOGLE_SHEETS_API, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify(dataToSend)
                });
                
                const result = await response.json();
                return result.success;
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞:', error);
                return false;
            }
        }
        
        // ========== –û–°–ù–û–í–ù–´–ï –§–£–ù–ö–¶–ò–ò ==========
        
        let currentPage = 'generateQR';
        
        function showPage(pageId) {
            currentPage = pageId;
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            document.querySelectorAll('.menu-btn').forEach(btn => btn.classList.remove('active'));
            
            const page = document.getElementById(pageId + 'Page');
            if (page) {
                page.classList.add('active');
                const pageIndex = ['generateQR', 'listNS', 'directories', 'admin'].indexOf(pageId);
                document.querySelectorAll('.menu-btn')[pageIndex]?.classList.add('active');
                
                if (pageId === 'listNS') loadNSList();
                if (pageId === 'admin') {
                    updateStats();
                    updateSystemStatus();
                }
            }
        }
        
        function showNotification(message, type = 'success', duration = 3000) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = 'notification ' + type;
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, duration);
        }
        
        function closeModal() {
            document.getElementById('statusModal').style.display = 'none';
        }
        
        // ========== –†–ï–ñ–ò–ú –†–ê–ë–û–ß–ï–ì–û ==========
        
        function checkMode() {
            const urlParams = new URLSearchParams(window.location.search);
            const qrCode = urlParams.get('qrcode');
            
            if (qrCode) {
                document.getElementById('adminMode').style.display = 'none';
                document.getElementById('workerMode').style.display = 'block';
                processQRCode(qrCode);
            } else {
                document.getElementById('adminMode').style.display = 'block';
                document.getElementById('workerMode').style.display = 'none';
            }
        }
        
        function processQRCode(qrCode) {
            console.log('üîç –û–±—Ä–∞–±–æ—Ç–∫–∞ QR-–∫–æ–¥–∞:', qrCode);
            
            // QR-–∫–æ–¥ —Å–æ–¥–µ—Ä–∂–∏—Ç –¥–∞–Ω–Ω—ã–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON
            try {
                const qrData = JSON.parse(decodeURIComponent(qrCode));
                showWorkerForm(qrData);
            } catch (e) {
                // –ï—Å–ª–∏ –Ω–µ JSON, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫–∞–∫ –ø—Ä–æ—Å—Ç–æ–π –∫–æ–¥
                showWorkerForm({
                    code: qrCode,
                    department: '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ',
                    location: '–ù–µ —É–∫–∞–∑–∞–Ω–æ',
                    responsible: ''
                });
            }
        }
        
        function showWorkerForm(qrData) {
            const formHTML = `
                <form class="worker-form" id="workerFormElement" onsubmit="event.preventDefault(); submitWorkerForm();">
                    <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∏–∑ QR-–∫–æ–¥–∞ -->
                    <div class="qr-info-box">
                        <h4 style="color: #0d47a1; margin-top: 0;">‚úÖ –î–∞–Ω–Ω—ã–µ –∏–∑ QR-–∫–æ–¥–∞:</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <div>
                                <strong>–ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ:</strong><br>
                                <span style="font-size: 16px; font-weight: bold; color: #1e3c72;">
                                    ${qrData.department || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}
                                </span>
                            </div>
                            <div>
                                <strong>–ú–µ—Å—Ç–æ:</strong><br>
                                <span style="font-size: 16px; font-weight: bold; color: #1e3c72;">
                                    ${qrData.location || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}
                                </span>
                            </div>
                        </div>
                        ${qrData.responsible ? `<p style="margin-top: 10px;"><strong>–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π:</strong> ${qrData.responsible}</p>` : ''}
                    </div>
                    
                    <h3 style="color: #1e3c72; margin-bottom: 15px;">üìù –ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ñ–æ—Ä–º—É –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è</h3>
                    
                    <div class="form-group">
                        <label>üìÖ –î–∞—Ç–∞ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è:</label>
                        <input type="date" id="detectionDate" value="${new Date().toISOString().split('T')[0]}" required>
                    </div>
                    
                    <div class="form-group">
                        <label>üë§ –í–∞—à–µ –§–ò–û:</label>
                        <input type="text" id="applicant" placeholder="–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á" required>
                    </div>
                    
                    <div class="form-group">
                        <label>üìù –û–ø–∏—Å–∞–Ω–∏–µ –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è:</label>
                        <textarea id="description" rows="4" placeholder="–û–ø–∏—à–∏—Ç–µ –ø—Ä–æ–±–ª–µ–º—É –ø–æ–¥—Ä–æ–±–Ω–æ..." required></textarea>
                    </div>
                    
                    <!-- –§–û–¢–û -->
                    <div class="form-group">
                        <label>üì∑ –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ (–¥–æ 3 —à—Ç—É–∫):</label>
                        <div class="photo-upload-area" onclick="document.getElementById('photoInput').click()">
                            <div style="font-size: 40px; margin-bottom: 10px;">üì∏</div>
                            <div style="font-weight: bold; color: #28a745;">–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ</div>
                            <input type="file" id="photoInput" accept="image/*" multiple style="display: none;" 
                                   onchange="handlePhotoUpload(event)" capture="environment">
                        </div>
                        <div class="preview-container" id="photoPreview"></div>
                    </div>
                    
                    <!-- –°–ö–†–´–¢–´–ï –ü–û–õ–Ø -->
                    <input type="hidden" id="hiddenDepartment" value="${qrData.department || ''}">
                    <input type="hidden" id="hiddenLocation" value="${qrData.location || ''}">
                    <input type="hidden" id="hiddenResponsible" value="${qrData.responsible || ''}">
                    <input type="hidden" id="hiddenQRCode" value="${qrData.code || ''}">
                    
                    <!-- –ö–ù–û–ü–ö–ò -->
                    <div style="display: flex; gap: 10px; margin-top: 25px;">
                        <button type="submit" class="btn btn-success" style="flex: 2;">
                            üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ Google Sheets
                        </button>
                        <button type="button" class="btn btn-danger" onclick="cancelWorkerForm()" style="flex: 1;">
                            ‚ùå –û—Ç–º–µ–Ω–∞
                        </button>
                    </div>
                </form>
            `;
            
            document.getElementById('workerForm').innerHTML = formHTML;
            currentQRData = qrData;
        }
        
        function handlePhotoUpload(event) {
            const files = event.target.files;
            const preview = document.getElementById('photoPreview');
            
            if (!preview) return;
            
            const remainingSlots = 3 - photos.length;
            const fileCount = Math.min(files.length, remainingSlots);
            
            if (fileCount <= 0) {
                showNotification('–ú–∞–∫—Å–∏–º—É–º 3 —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏', 'warning');
                return;
            }
            
            for (let i = 0; i < fileCount; i++) {
                const file = files[i];
                
                if (file.size > 2 * 1024 * 1024) {
                    showNotification(`–§–æ—Ç–æ "${file.name}" —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–µ (–º–∞–∫—Å. 2MB)`, 'warning');
                    continue;
                }
                
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    // –°–∂–∏–º–∞–µ–º —Ñ–æ—Ç–æ
                    const img = new Image();
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        canvas.width = 800;
                        canvas.height = 600;
                        ctx.drawImage(img, 0, 0, 800, 600);
                        
                        const compressedData = canvas.toDataURL('image/jpeg', 0.7);
                        
                        const photoDiv = document.createElement('div');
                        photoDiv.className = 'photo-preview';
                        photoDiv.innerHTML = `
                            <img src="${compressedData}" alt="–§–æ—Ç–æ">
                            <button onclick="removePhoto(${photos.length})" style="
                                position: absolute; top: 5px; right: 5px; 
                                background: rgba(220, 53, 69, 0.9); color: white; 
                                border: none; border-radius: 50%; width: 24px; 
                                height: 24px; font-size: 14px; cursor: pointer;
                            ">√ó</button>
                        `;
                        preview.appendChild(photoDiv);
                        
                        photos.push(compressedData);
                    };
                    
                    img.src = e.target.result;
                };
                
                reader.readAsDataURL(file);
            }
            
            showNotification(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${fileCount} —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π`, 'success');
        }
        
        function removePhoto(index) {
            photos.splice(index, 1);
            const preview = document.getElementById('photoPreview');
            if (preview) {
                preview.innerHTML = '';
                photos.forEach((photo, i) => {
                    const photoDiv = document.createElement('div');
                    photoDiv.className = 'photo-preview';
                    photoDiv.innerHTML = `
                        <img src="${photo}" alt="–§–æ—Ç–æ">
                        <button onclick="removePhoto(${i})" style="
                            position: absolute; top: 5px; right: 5px; 
                            background: rgba(220, 53, 69, 0.9); color: white; 
                            border: none; border-radius: 50%; width: 24px; 
                            height: 24px; font-size: 14px; cursor: pointer;
                        ">√ó</button>
                    `;
                    preview.appendChild(photoDiv);
                });
            }
        }
        
        async function submitWorkerForm() {
            try {
                if (!CONFIG.GOOGLE_SHEETS_API) {
                    showNotification('–°–∏—Å—Ç–µ–º–∞ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.', 'error');
                    return;
                }
                
                // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ
                const department = document.getElementById('hiddenDepartment').value;
                const location = document.getElementById('hiddenLocation').value;
                const detectionDate = document.getElementById('detectionDate').value;
                const applicant = document.getElementById('applicant').value;
                const description = document.getElementById('description').value;
                
                // –í–∞–ª–∏–¥–∞—Ü–∏—è
                if (!applicant.trim() || !description.trim()) {
                    showNotification('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –§–ò–û –∏ –æ–ø–∏—Å–∞–Ω–∏–µ', 'error');
                    return;
                }
                
                // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–æ–º–µ—Ä–∞ –ù–°
                const nsNumber = 'NS-' + Date.now().toString().slice(-8);
                
                // –°–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç –ù–°
                const nsData = {
                    nsNumber: nsNumber,
                    detectionDate: detectionDate,
                    department: department,
                    location: location,
                    applicant: applicant,
                    description: description,
                    photos: photos,
                    status: 'checking'
                };
                
                showNotification('–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ Google Sheets...', 'info');
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ Google Sheets
                const saved = await saveToGoogleSheets(nsData);
                
                if (saved) {
                    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º email
                    await sendEmailNotification(nsData);
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É—Å–ø–µ—Ö
                    showSuccessScreen(nsData);
                    
                    // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
                    photos = [];
                }
                
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏:', error);
                showNotification('–û—à–∏–±–∫–∞: ' + error.message, 'error');
            }
        }
        
        async function sendEmailNotification(nsData) {
            try {
                const managerEmail = localStorage.getItem('manager_email') || 'finkart23@mail.ru';
                
                const emailBody = `
                    <h2>üìã –ù–æ–≤–æ–µ –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–æ</h2>
                    <h3>${nsData.nsNumber}</h3>
                    
                    <table style="width: 100%; border-collapse: collapse; margin: 20px 0; border: 1px solid #ddd;">
                        <tr><td style="padding: 10px; background: #f9f9f9;"><strong>–ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ:</strong></td><td style="padding: 10px;">${nsData.department}</td></tr>
                        <tr><td style="padding: 10px; background: #f9f9f9;"><strong>–ú–µ—Å—Ç–æ:</strong></td><td style="padding: 10px;">${nsData.location}</td></tr>
                        <tr><td style="padding: 10px; background: #f9f9f9;"><strong>–ó–∞—è–≤–∏—Ç–µ–ª—å:</strong></td><td style="padding: 10px;">${nsData.applicant}</td></tr>
                        <tr><td style="padding: 10px; background: #f9f9f9;"><strong>–î–∞—Ç–∞:</strong></td><td style="padding: 10px;">${nsData.detectionDate}</td></tr>
                    </table>
                    
                    <h4>–û–ø–∏—Å–∞–Ω–∏–µ:</h4>
                    <div style="background: #f5f5f5; padding: 15px; border-radius: 5px; margin: 10px 0;">
                        ${nsData.description.replace(/\n/g, '<br>')}
                    </div>
                    
                    <p><strong>üì∑ –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏:</strong> ${nsData.photos.length} —à—Ç.</p>
                    
                    <div style="margin: 20px 0; padding: 15px; background: #e3f2fd; border-radius: 8px;">
                        <strong>–î–µ–π—Å—Ç–≤–∏—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –°–ú–ö:</strong>
                        <ol>
                            <li>–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–∞–Ω–Ω—ã–µ –≤ Google Sheets</li>
                            <li>–ù–∞–∑–Ω–∞—á—å—Ç–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∑–∞ –∞–Ω–∞–ª–∏–∑</li>
                            <li>–ò–∑–º–µ–Ω–∏—Ç–µ —Å—Ç–∞—Ç—É—Å –Ω–∞ "–í —Ä–∞–±–æ—Ç–µ"</li>
                        </ol>
                    </div>
                    
                    <p><a href="${window.location.origin}" style="
                        display: inline-block; padding: 12px 24px; background: #1e3c72; 
                        color: white; text-decoration: none; border-radius: 5px; font-weight: bold;
                    ">–ü–µ—Ä–µ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É</a></p>
                `;
                
                const response = await fetch(CONFIG.WEB3FORMS_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        access_key: CONFIG.WEB3FORMS_KEY,
                        subject: `–§–ê–†–ú–°–¢–ò–õ: –ù–æ–≤–æ–µ –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ ${nsData.nsNumber}`,
                        from_name: '–°–∏—Å—Ç–µ–º–∞ –§–ê–†–ú–°–¢–ò–õ',
                        to: managerEmail,
                        html: emailBody,
                        reply_to: managerEmail
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    console.log('‚úÖ Email –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω');
                }
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ email:', error);
            }
        }
        
        function showSuccessScreen(nsData) {
            const formHTML = `
                <div style="text-align: center; padding: 30px;">
                    <div style="font-size: 60px; color: #28a745; margin-bottom: 20px;">‚úÖ</div>
                    <h2 style="color: #1e3c72; margin-bottom: 20px;">–ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–æ!</h2>
                    
                    <div class="info-box" style="max-width: 500px; margin: 0 auto 30px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; text-align: left;">
                            <div><strong>–ù–æ–º–µ—Ä –ù–°:</strong><br><span style="font-size: 18px; font-weight: bold;">${nsData.nsNumber}</span></div>
                            <div><strong>–°—Ç–∞—Ç—É—Å:</strong><br><span class="ln-status status-checking">–ù–ê –ü–†–û–í–ï–†–ö–ï –°–ú–ö</span></div>
                            <div><strong>–î–∞—Ç–∞:</strong><br>${new Date(nsData.detectionDate).toLocaleDateString('ru-RU')}</div>
                            <div><strong>–ó–∞—è–≤–∏—Ç–µ–ª—å:</strong><br>${nsData.applicant}</div>
                            <div style="grid-column: 1 / -1;"><strong>–ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ:</strong><br>${nsData.department}</div>
                            <div style="grid-column: 1 / -1;"><strong>–ú–µ—Å—Ç–æ:</strong><br>${nsData.location}</div>
                        </div>
                    </div>
                    
                    <p style="color: #666; margin: 20px 0;">–î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ Google Sheets. –ú–µ–Ω–µ–¥–∂–µ—Ä –°–ú–ö –ø–æ–ª—É—á–∏–ª —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ.</p>
                    
                    <button class="btn btn-primary" onclick="cancelWorkerForm()" style="padding: 14px 28px;">
                        üìù –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –∑–∞—è–≤–∫—É
                    </button>
                </div>
            `;
            
            document.getElementById('workerForm').innerHTML = formHTML;
            showNotification('–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ Google Sheets!', 'success');
        }
        
        function cancelWorkerForm() {
            const urlParams = new URLSearchParams(window.location.search);
            const qrCode = urlParams.get('qrcode');
            
            if (qrCode) {
                window.location.href = window.location.pathname + '?qrcode=' + encodeURIComponent(qrCode);
            } else {
                window.location.href = window.location.pathname;
            }
        }
        
        // ========== –£–ü–†–ê–í–õ–ï–ù–ò–ï –ù–° ==========
        
        async function loadNSList() {
            const container = document.getElementById('nsListContainer');
            if (!container) return;
            
            container.innerHTML = `
                <div style="text-align: center; padding: 40px; color: #666;">
                    <h3 style="color: #1e3c72;">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ Google Sheets...</h3>
                    <p>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ</p>
                </div>
            `;
            
            try {
                const nsList = await loadFromGoogleSheets();
                
                if (nsList.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #666;">
                            <h3 style="color: #1e3c72;">–ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–π –Ω–µ—Ç</h3>
                            <p>–°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤–æ–µ –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —á–µ—Ä–µ–∑ QR-–∫–æ–¥</p>
                        </div>
                    `;
                    return;
                }
                
                // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –¥–∞—Ç–µ (–Ω–æ–≤—ã–µ —Å–Ω–∞—á–∞–ª–∞)
                nsList.sort((a, b) => new Date(b.created || b.timestamp) - new Date(a.created || a.timestamp));
                
                let html = '<div class="ln-list">';
                
                nsList.forEach((ns, index) => {
                    if (!ns || !ns.nsNumber) return;
                    
                    const date = new Date(ns.detectionDate || ns.created || ns.timestamp).toLocaleDateString('ru-RU');
                    const status = ns.status || 'checking';
                    const statusConfig = CONFIG.STATUSES[status] || CONFIG.STATUSES.checking;
                    
                    html += `
                        <div class="ln-card">
                            <div class="ln-card-header">
                                <div class="ln-number">${ns.nsNumber}</div>
                                <div class="ln-status" style="background: ${statusConfig.color}">${statusConfig.name}</div>
                            </div>
                            
                            <div style="font-size: 14px;">
                                <div><strong>üìÖ –î–∞—Ç–∞:</strong> ${date}</div>
                                <div><strong>üè≠ –ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ:</strong> ${ns.department || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</div>
                                <div><strong>üìç –ú–µ—Å—Ç–æ:</strong> ${ns.location || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</div>
                                <div><strong>üë§ –ó–∞—è–≤–∏—Ç–µ–ª—å:</strong> ${ns.applicant || '–ù–µ —É–∫–∞–∑–∞–Ω'}</div>
                                <div><strong>üìã –û–ø–∏—Å–∞–Ω–∏–µ:</strong></div>
                                <div style="margin-top: 5px; padding: 8px; background: #f8f9fa; border-radius: 5px; font-size: 13px; max-height: 60px; overflow: hidden;">
                                    ${ns.description ? (ns.description.length > 100 ? ns.description.substring(0, 100) + '...' : ns.description) : '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è'}
                                </div>
                                
                                ${ns.responsible ? `<div style="margin-top: 10px;"><strong>üéØ –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π:</strong> ${ns.responsible}</div>` : ''}
                                
                                <div style="display: flex; gap: 10px; margin-top: 15px;">
                                    <button class="btn btn-info" onclick="viewNSDetails('${ns.nsNumber}')" style="flex: 1; padding: 8px; font-size: 13px;">
                                        üëÅÔ∏è –ü—Ä–æ—Å–º–æ—Ç—Ä
                                    </button>
                                    <button class="btn btn-warning" onclick="editNS('${ns.nsNumber}')" style="flex: 1; padding: 8px; font-size: 13px;">
                                        üìù –ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
                container.innerHTML = html;
                
            } catch (error) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <h3 style="color: #dc3545;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</h3>
                        <p>${error.message}</p>
                        <p>–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Google Sheets API</p>
                        <button class="btn btn-primary" onclick="loadNSList()" style="margin-top: 15px;">
                            üîÑ –ü–æ–≤—Ç–æ—Ä–∏—Ç—å
                        </button>
                    </div>
                `;
            }
        }
        
        async function viewNSDetails(nsNumber) {
            try {
                const nsList = await loadFromGoogleSheets();
                const ns = nsList.find(item => item.nsNumber === nsNumber);
                
                if (!ns) {
                    showNotification('–ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ', 'error');
                    return;
                }
                
                const date = new Date(ns.detectionDate || ns.created || ns.timestamp).toLocaleDateString('ru-RU');
                const statusConfig = CONFIG.STATUSES[ns.status] || CONFIG.STATUSES.checking;
                
                let photosHTML = '';
                if (ns.photos && ns.photos.length > 0) {
                    const photoArray = JSON.parse(ns.photos || '[]');
                    if (photoArray.length > 0) {
                        photosHTML = `
                            <div style="margin-top: 15px;">
                                <h4>üì∑ –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ (${photoArray.length}):</h4>
                                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; margin-top: 10px;">
                        `;
                        
                        photoArray.forEach((photo, i) => {
                            photosHTML += `
                                <div class="photo-preview">
                                    <img src="${photo}" alt="–§–æ—Ç–æ ${i + 1}" style="cursor: pointer;">
                                </div>
                            `;
                        });
                        
                        photosHTML += '</div></div>';
                    }
                }
                
                const modalContent = `
                    <h3 style="color: #1e3c72; margin-bottom: 20px;">${ns.nsNumber}</h3>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                        <div><strong>–î–∞—Ç–∞ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è:</strong><br>${date}</div>
                        <div><strong>–°—Ç–∞—Ç—É—Å:</strong><br><span class="ln-status" style="background: ${statusConfig.color}">${statusConfig.name}</span></div>
                        <div><strong>–ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ:</strong><br>${ns.department || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</div>
                        <div><strong>–ú–µ—Å—Ç–æ:</strong><br>${ns.location || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</div>
                        <div><strong>–ó–∞—è–≤–∏—Ç–µ–ª—å:</strong><br>${ns.applicant || '–ù–µ —É–∫–∞–∑–∞–Ω'}</div>
                        <div><strong>–°–æ–∑–¥–∞–Ω–æ:</strong><br>${new Date(ns.created || ns.timestamp).toLocaleDateString('ru-RU')}</div>
                    </div>
                    
                    <div style="margin-top: 15px;">
                        <h4>üìã –û–ø–∏—Å–∞–Ω–∏–µ:</h4>
                        <div style="padding: 15px; background: #f8f9fa; border-radius: 8px; margin-top: 10px; white-space: pre-line;">
                            ${ns.description || '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è'}
                        </div>
                    </div>
                    
                    ${ns.responsible ? `<div style="margin-top: 15px;"><strong>üéØ –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π:</strong> ${ns.responsible}</div>` : ''}
                    
                    ${ns.notes ? `<div style="margin-top: 15px;"><strong>üìù –ü—Ä–∏–º–µ—á–∞–Ω–∏—è:</strong><br>${ns.notes}</div>` : ''}
                    
                    ${photosHTML}
                    
                    <div style="margin-top: 25px; text-align: center;">
                        <button class="btn btn-primary" onclick="closeModal()">
                            –ó–∞–∫—Ä—ã—Ç—å
                        </button>
                    </div>
                `;
                
                document.getElementById('modalTitle').textContent = '–î–µ—Ç–∞–ª–∏ –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è';
                document.getElementById('modalContent').innerHTML = modalContent;
                document.getElementById('statusModal').style.display = 'flex';
                
            } catch (error) {
                showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–µ—Ç–∞–ª–µ–π: ' + error.message, 'error');
            }
        }
        
        async function editNS(nsNumber) {
            try {
                const nsList = await loadFromGoogleSheets();
                const ns = nsList.find(item => item.nsNumber === nsNumber);
                
                if (!ns) {
                    showNotification('–ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ', 'error');
                    return;
                }
                
                const statusConfig = CONFIG.STATUSES[ns.status] || CONFIG.STATUSES.checking;
                
                const modalContent = `
                    <h3 style="color: #1e3c72; margin-bottom: 15px;">${ns.nsNumber}</h3>
                    
                    <div style="margin-bottom: 20px;">
                        <strong>–¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å:</strong> <span class="ln-status" style="background: ${statusConfig.color}">${statusConfig.name}</span>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label>–ù–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å:</label>
                        <select id="editStatus" style="width: 100%; padding: 10px; border-radius: 5px; border: 2px solid #ddd;">
                            ${Object.entries(CONFIG.STATUSES).map(([key, value]) => 
                                `<option value="${key}" ${ns.status === key ? 'selected' : ''}>${value.name}</option>`
                            ).join('')}
                        </select>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label>–ù–∞–∑–Ω–∞—á–∏—Ç—å –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ:</label>
                        <input type="text" id="editResponsible" value="${ns.responsible || ''}" placeholder="–§–ò–û –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ" style="width: 100%; padding: 10px; border-radius: 5px; border: 2px solid #ddd;">
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</label>
                        <textarea id="editComment" rows="3" placeholder="–î–æ–±–∞–≤—å—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..." style="width: 100%; padding: 10px; border-radius: 5px; border: 2px solid #ddd;">${ns.notes || ''}</textarea>
                    </div>
                    
                    <div style="display: flex; gap: 10px; margin-top: 25px;">
                        <button class="btn btn-success" onclick="saveNSChanges('${nsNumber}')" style="flex: 2;">
                            üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ Google Sheets
                        </button>
                        <button class="btn btn-danger" onclick="closeModal()" style="flex: 1;">
                            ‚ùå –û—Ç–º–µ–Ω–∞
                        </button>
                    </div>
                `;
                
                document.getElementById('modalTitle').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è';
                document.getElementById('modalContent').innerHTML = modalContent;
                document.getElementById('statusModal').style.display = 'flex';
                
            } catch (error) {
                showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + error.message, 'error');
            }
        }
        
        async function saveNSChanges(nsNumber) {
            try {
                const newStatus = document.getElementById('editStatus').value;
                const responsible = document.getElementById('editResponsible').value;
                const comment = document.getElementById('editComment').value;
                
                showNotification('–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π...', 'info');
                
                const success = await updateNSStatus(nsNumber, newStatus, responsible, comment);
                
                if (success) {
                    showNotification('–ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ Google Sheets', 'success');
                    closeModal();
                    loadNSList();
                    updateStats();
                } else {
                    showNotification('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π', 'error');
                }
                
            } catch (error) {
                showNotification('–û—à–∏–±–∫–∞: ' + error.message, 'error');
            }
        }
        
        // ========== –°–¢–ê–¢–ò–°–¢–ò–ö–ê ==========
        
        async function updateStats() {
            try {
                const nsList = await loadFromGoogleSheets();
                
                const totalNS = nsList.length;
                const checkingNS = nsList.filter(ns => ns.status === 'checking').length;
                const analysisNS = nsList.filter(ns => ns.status === 'analysis').length;
                const closedNS = nsList.filter(ns => ns.status === 'closed').length;
                
                if (document.getElementById('totalNS')) {
                    document.getElementById('totalNS').textContent = totalNS;
                    document.getElementById('checkingNS').textContent = checkingNS;
                    document.getElementById('analysisNS').textContent = analysisNS;
                    document.getElementById('closedNS').textContent = closedNS;
                }
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', error);
            }
        }
        
        function updateSystemStatus() {
            const statusDiv = document.getElementById('systemStatus');
            if (!statusDiv) return;
            
            if (CONFIG.GOOGLE_SHEETS_API) {
                statusDiv.innerHTML = `
                    <div style="color: #28a745; font-weight: bold;">‚úÖ Google Sheets –Ω–∞—Å—Ç—Ä–æ–µ–Ω</div>
                    <div style="font-size: 12px; color: #666; margin-top: 5px;">${CONFIG.GOOGLE_SHEETS_API}</div>
                    <div style="margin-top: 10px;">
                        <button class="btn btn-sm btn-info" onclick="testGoogleSheets()">
                            üß™ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
                        </button>
                    </div>
                `;
            } else {
                statusDiv.innerHTML = `
                    <div style="color: #dc3545; font-weight: bold;">‚ùå Google Sheets –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω</div>
                    <p style="font-size: 14px; margin-top: 10px;">–ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ —Ä–∞–∑–¥–µ–ª "üìö –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏" –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</p>
                `;
            }
        }
        
        async function testGoogleSheets() {
            try {
                showNotification('–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Google Sheets...', 'info');
                
                const nsList = await loadFromGoogleSheets();
                
                showNotification(`‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ! –ó–∞–ø–∏—Å–µ–π: ${nsList.length}`, 'success');
                updateSystemStatus();
                
            } catch (error) {
                showNotification('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ' + error.message, 'error');
            }
        }
        
        function refreshResponsibles() {
            showNotification('–°–ø–∏—Å–æ–∫ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –∏–∑ Google Sheets', 'info');
            // –í —Ä–µ–∞–ª—å–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ –∑–¥–µ—Å—å –±—ã–ª–∞ –±—ã –∑–∞–≥—Ä—É–∑–∫–∞ –∏–∑ –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ –ª–∏—Å—Ç–∞
        }
        
        // ========== QR –ö–û–î–´ ==========
        
        function generateQRCode() {
            const department = document.getElementById('qrDepartment').value;
            const location = document.getElementById('qrLocationInput').value;
            const responsible = document.getElementById('qrResponsible').value;
            
            if (!department || !location) {
                showNotification('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è', 'error');
                return;
            }
            
            // –°–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è QR-–∫–æ–¥–∞
            const qrData = {
                department: department,
                location: location,
                responsible: responsible || '',
                code: 'FS-' + Date.now().toString().slice(-8),
                timestamp: new Date().toISOString()
            };
            
            const qrContent = JSON.stringify(qrData);
            const currentUrl = window.location.origin + window.location.pathname;
            const qrUrl = `${currentUrl}?qrcode=${encodeURIComponent(qrContent)}`;
            
            currentQRData = qrData;
            
            const qrcodeDiv = document.getElementById('qrcode');
            qrcodeDiv.innerHTML = '';
            
            if (typeof QRCode !== 'undefined') {
                new QRCode(qrcodeDiv, {
                    text: qrUrl,
                    width: 200,
                    height: 200,
                    colorDark: "#1e3c72",
                    colorLight: "#ffffff",
                    correctLevel: QRCode.CorrectLevel.H
                });
            }
            
            document.getElementById('qrPreview').style.display = 'block';
            document.getElementById('previewDept').textContent = department;
            document.getElementById('previewLocation').textContent = location;
            document.getElementById('previewCode').textContent = qrData.code;
            document.getElementById('previewDate').textContent = new Date().toLocaleDateString('ru-RU');
            
            showNotification('QR-–∫–æ–¥ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!', 'success');
        }
        
        function printQRCode() {
            if (!currentQRData) {
                showNotification('–°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ QR-–∫–æ–¥', 'error');
                return;
            }
            
            const qrContent = JSON.stringify(currentQRData);
            const currentUrl = window.location.origin + window.location.pathname;
            const qrUrl = `${currentUrl}?qrcode=${encodeURIComponent(qrContent)}`;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>QR-–∫–æ–¥ ${currentQRData.department}</title>
                    <style>
                        body { font-family: Arial; text-align: center; padding: 20px; }
                        .info { text-align: left; margin: 20px 0; padding: 15px; border: 2px solid #1e3c72; border-radius: 10px; }
                        @media print { body { padding: 10px; } }
                    </style>
                </head>
                <body>
                    <h1>–§–ê–†–ú–°–¢–ò–õ</h1>
                    <h3>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è</h3>
                    
                    <div class="info">
                        <p><strong>–ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ:</strong> ${currentQRData.department}</p>
                        <p><strong>–ú–µ—Å—Ç–æ:</strong> ${currentQRData.location}</p>
                        <p><strong>–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π:</strong> ${currentQRData.responsible || '–ù–µ —É–∫–∞–∑–∞–Ω'}</p>
                        <p><strong>–ö–æ–¥:</strong> ${currentQRData.code}</p>
                        <p><strong>–°–æ–∑–¥–∞–Ω:</strong> ${new Date(currentQRData.timestamp).toLocaleDateString('ru-RU')}</p>
                    </div>
                    
                    <div style="margin: 20px 0;">
                        <strong>–û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR-–∫–æ–¥ –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è</strong>
                    </div>
                    
                    <div id="qrcode"></div>
                    
                    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"><\/script>
                    <script>
                        new QRCode(document.getElementById('qrcode'), {
                            text: '${qrUrl}',
                            width: 200,
                            height: 200,
                            colorDark: "#1e3c72",
                            colorLight: "#ffffff"
                        });
                        setTimeout(() => {
                            window.print();
                            setTimeout(() => window.close(), 1000);
                        }, 500);
                    <\/script>
                </body>
                </html>
            `);
            printWindow.document.close();
        }
        
        function saveQRAsImage() {
            if (!currentQRData) {
                showNotification('–°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ QR-–∫–æ–¥', 'error');
                return;
            }
            
            const canvas = document.querySelector('#qrcode canvas');
            if (!canvas) {
                showNotification('QR-–∫–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');
                return;
            }
            
            const link = document.createElement('a');
            link.download = `QR_${currentQRData.department}_${currentQRData.code}.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();
            
            showNotification('QR-–∫–æ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω', 'success');
        }
        
        function testQRCode() {
            if (!currentQRData) {
                showNotification('–°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ QR-–∫–æ–¥', 'error');
                return;
            }
            
            const qrContent = JSON.stringify(currentQRData);
            const currentUrl = window.location.origin + window.location.pathname;
            const qrUrl = `${currentUrl}?qrcode=${encodeURIComponent(qrContent)}`;
            
            window.open(qrUrl, '_blank');
        }
        
        // ========== –≠–ö–°–ü–û–†–¢ –§–£–ù–ö–¶–ò–ô ==========
        
        window.showPage = showPage;
        window.generateQRCode = generateQRCode;
        window.printQRCode = printQRCode;
        window.saveQRAsImage = saveQRAsImage;
        window.testQRCode = testQRCode;
        window.viewNSDetails = viewNSDetails;
        window.editNS = editNS;
        window.saveNSChanges = saveNSChanges;
        window.closeModal = closeModal;
        window.saveAPISettings = saveAPISettings;
        window.testGoogleSheets = testGoogleSheets;
        window.refreshResponsibles = refreshResponsibles;
        window.submitWorkerForm = submitWorkerForm;
        window.handlePhotoUpload = handlePhotoUpload;
        window.removePhoto = removePhoto;
        window.cancelWorkerForm = cancelWorkerForm;
        
    </script>
</body>
</html>
